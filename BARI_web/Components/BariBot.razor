@page "/baribot"
@namespace BARI_web.Components
@using BARI_web.Services

<div class="bb-shell">
    <div class="bb-header">
        <div class="bb-title">
            <div class="bb-badge">BariBot</div>
            <div class="bb-subtitle">Inventario de laboratorio (química + electrónica)</div>
        </div>

        <div class="bb-status">
            @if (IsBusy)
            {
                <span class="bb-dot bb-dot--busy"></span>
                <span>Analizando…</span>
            }
            else
            {
                <span class="bb-dot bb-dot--ok"></span>
                <span>Listo</span>
            }
        </div>
    </div>

    <div class="bb-body">
        @if (Messages.Count == 0)
        {
            <div class="bb-empty">
                <div class="bb-empty-title">Prueba con:</div>
                <div class="bb-chips">
                    <button class="bb-chip"
                            @onclick="@(() => QuickAsk("¿Cuántos reactivos corrosivos hay?"))">
                        ¿Cuántos reactivos corrosivos hay?
                    </button>

                    <button class="bb-chip"
                            @onclick="@(() => QuickAsk("Lista equipos en el laboratorio"))">
                        Lista equipos
                    </button>

                    <button class="bb-chip"
                            @onclick="@(() => QuickAsk("¿Tienen ácido sulfúrico? (por nombre o CAS)"))">
                        ¿Tienen ácido sulfúrico?
                    </button>

                    <button class="bb-chip"
                            @onclick="@(() => QuickAsk("Busca documentos de seguridad"))">
                        Busca documentos
                    </button>
                </div>
            </div>
        }

        @foreach (var m in Messages)
        {
            <div class="bb-row @(m.Role == "user" ? "bb-row--me" : "bb-row--bot")">
                <div class="bb-bubble @(m.Role == "user" ? "bb-bubble--me" : "bb-bubble--bot")">
                    <div class="bb-bubble-meta">
                        <span class="bb-who">@(m.Role == "user" ? "Tú" : "BariBot")</span>
                        <span class="bb-time">@m.At.ToLocalTime().ToString("HH:mm")</span>
                    </div>

                    <div class="bb-bubble-text">@m.Content</div>

                    @if (m.Role == "assistant" && m.UsedDatabase == true)
                    {
                        <div class="bb-pill">BD</div>
                    }
                </div>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(ErrorMessage))
        {
            <div class="bb-error">
                <strong>Error:</strong> @ErrorMessage
            </div>
        }
    </div>

    <div class="bb-footer">
        <div class="bb-input-wrap">
            <textarea class="bb-input"
                      placeholder="Escribe tu pregunta…"
                      @bind="Draft"
                      @bind:event="oninput"
                      @onkeydown="OnKeyDown"
                      disabled="@IsBusy"></textarea>

            <button class="bb-send"
                    @onclick="SendAsync"
                    disabled="@IsBusy || string.IsNullOrWhiteSpace(Draft)">
                <span class="bb-send-icon">➤</span>
                <span>Enviar</span>
            </button>
        </div>

        <div class="bb-hint">
            Tip: intenta por <code>nombre</code>, <code>CAS</code>, <code>QR</code>, <code>área</code>,
            o por peligrosidad (<code>corros</code>, <code>inflam</code>, <code>toxic</code>).
        </div>
    </div>
</div>
