@page "/documentacion/instituciones/pictogramas/{GhsId}"

<PageTitle>Detalle pictograma</PageTitle>

<section class="page-card">
    <h2>Pictograma: @GhsId</h2>
    <p>Detalle del pictograma y su uso en sustancias.</p>
    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.5rem;">
    @if (detalle is not null)
    {
        <div class="detail-card">
            <img class="pictogram-large" src="@detalle.IconUrl" alt="@detalle.Descripcion" />
            <div>
                <h3>@detalle.Descripcion</h3>
                <p>Uso en sustancias: <strong>@detalle.UsoCount</strong></p>
            </div>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(loadError))
    {
        <p class="error-note">No se pudo cargar el pictograma: @loadError</p>
    }
</section>

@code {
    [Parameter] public string GhsId { get; set; } = "";
    [Inject] private NpgsqlDataSource DataSource { get; set; } = default!;

    private PictogramaDetalle? detalle;
    private string? loadError;

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            const string sql = @"
                SELECT g.ghs_id, g.descripcion, g.icon_url,
                       COALESCE(COUNT(sp.sustancia_id), 0) AS uso_count
                FROM ghs_pictogramas g
                LEFT JOIN sustancias_pictogramas sp ON sp.ghs_id = g.ghs_id
                WHERE g.ghs_id = @id
                GROUP BY g.ghs_id, g.descripcion, g.icon_url
                ";
            await using var cmd = new NpgsqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("id", GhsId);
            await using var reader = await cmd.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                detalle = new PictogramaDetalle(
                    reader.GetString(0),
                    reader.GetString(1),
                    reader.IsDBNull(2) ? "" : reader.GetString(2),
                    reader.GetInt64(3)
                );
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private sealed record PictogramaDetalle(string GhsId, string Descripcion, string IconUrl, long UsoCount);
}

<style>
    .detail-card { display:flex; gap:1rem; align-items:center; }
    .pictogram-large { width:72px; height:72px; object-fit:contain; }
    .error-note { color:#b91c1c; margin-top:0.75rem; }
</style>
