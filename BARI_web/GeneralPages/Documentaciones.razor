@page "/documentaciones"
@using BARI_web.General_Services
@using Npgsql
@using System.Globalization
@using System.IO
@using Microsoft.AspNetCore.Components.Forms
@inject LaboratorioState LaboratorioState
@inject IWebHostEnvironment HostEnvironment
@implements IDisposable

<PageTitle>Documentaciones</PageTitle>

<section class="page-card">
    <h2>Documentaciones</h2>
    <p>
        En esta página se concentrará la documentación oficial del laboratorio:
        fichas de reactivos, manuales, protocolos y formularios.
    </p>
    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <details>
        <summary style="cursor:pointer; font-weight:600;">Subir documento</summary>
        <div class="form-header">
            <h4>Registro de documento</h4>
            <p class="form-hint">Agrega la ficha o normativa con su categoría, procedencia y miniatura.</p>
        </div>
        <div class="assign-row form-grid">
            <input class="border p-1" placeholder="Título" @bind="_nuevoDocumentoTitulo" />
            <select class="border p-1" @bind="_nuevoDocumentoCategoriaId">
                <option value="">Categoría</option>
                @foreach (var categoria in _categoriaOptions)
                {
                    <option value="@categoria.Id">@categoria.Label</option>
                }
            </select>
            <select class="border p-1" @bind="_nuevoDocumentoSubcategoriaId">
                <option value="">Subcategoría</option>
                @foreach (var subcategoria in _subcategoriaOptions)
                {
                    <option value="@subcategoria.Id">@subcategoria.Label</option>
                }
            </select>
            <input class="border p-1" placeholder="Descripción" @bind="_nuevoDocumentoDescripcion" />
            <input class="border p-1" placeholder="URL" @bind="_nuevoDocumentoUrl" />
            <input class="border p-1" placeholder="Ruta local (cualquier dirección)" @bind="_nuevoDocumentoArchivoLocal" />
            <select class="border p-1" @bind="_nuevoDocumentoProcedencia">
                <option value="UNIVERSIDAD">Procedencia · UNIVERSIDAD</option>
                <option value="ORGANISMO">Procedencia · ORGANISMO</option>
                <option value="ASIGNATURA">Procedencia · ASIGNATURA</option>
            </select>

            <div class="upload-card full-span">
                <div class="upload-options">
                    <label class="text-sm">
                        <input type="radio"
                               name="documentoImagenModo"
                               value="url"
                               checked="@(_nuevoDocumentoImagenModo == "url")"
                               @onchange="OnDocumentoImagenModoChanged" />
                        Colocar un URL
                    </label>
                    <label class="text-sm">
                        <input type="radio"
                               name="documentoImagenModo"
                               value="archivo"
                               checked="@(_nuevoDocumentoImagenModo == "archivo")"
                               @onchange="OnDocumentoImagenModoChanged" />
                        Subir archivo
                    </label>
                </div>

                @if (_nuevoDocumentoImagenModo == "url")
                {
                    <input class="border p-1" placeholder="Imagen URL (o ruta relativa)" @bind="_nuevoDocumentoImagenUrl" />
                }
                else
                {
                    <label class="upload-drop">
                        <InputFile OnChange="OnDocumentoImagenArchivoSeleccionado" accept="image/png,image/jpeg,image/jpg,image/webp" />
                        <span>Arrastra una imagen o haz clic para buscar</span>
                    </label>
                    @if (!string.IsNullOrWhiteSpace(_nuevoDocumentoImagenArchivo))
                    {
                        <div class="text-xs text-gray-500">Archivo: @_nuevoDocumentoImagenArchivo</div>
                    }
                }
            </div>
            <input class="border p-1" placeholder="Notas" @bind="_nuevoDocumentoNotas" />
            <div class="form-actions full-span">
                <button class="btn primary" @onclick="SubirDocumentoAsync">Subir documento</button>
                @if (!string.IsNullOrWhiteSpace(_nuevoDocumentoMsg))
                {
                    <span class="muted">@_nuevoDocumentoMsg</span>
                }
            </div>
        </div>
    </details>
</section>
<section id="asignaturas" class="page-card" style="margin-top:1.5rem;">
    <h3>Documentación por asignatura</h3>
    <p class="section-intro">
        Explora el resumen de asignaturas y entra al detalle de cada una.
    </p>
    @if (!string.IsNullOrWhiteSpace(loadError))
    {
        <p class="error-note">No se pudo cargar asignaturas desde la base de datos: @loadError</p>
    }
    else if (asignaturas.Count == 0)
    {
        <p class="empty-note">No hay asignaturas asociadas al laboratorio seleccionado.</p>
    }
    else
    {
        <div class="menu-grid">
            @foreach (var asignatura in asignaturas)
            {
                <article class="menu-item" @key="asignatura.Id">
                    <div class="menu-thumb"></div>
                    <div class="menu-title">
                        <strong>@asignatura.Nombre</strong>
                        <span class="muted">@asignatura.Codigo</span>
                    </div>
                    <p class="menu-desc">@asignatura.Descripcion</p>
                    <div class="menu-links">
                        <NavLink class="btn-link" href="@($"/documentacion/{asignatura.Slug}/laboratorios")">
                            Ver experiencias
                        </NavLink>
                        <NavLink class="btn-link secondary" href="/documentacion/asignaturas">
                            Ver mosaico general
                        </NavLink>
                    </div>
                </article>
            }
        </div>
    }
</section>

<section id="instituciones-general" class="page-card" style="margin-top:1.5rem;">
    <h3>Documentación institucional (general)</h3>
    <p class="section-intro">
        Documentos y normativas institucionales disponibles por laboratorio.
    </p>
    @if (!isQuimica)
    {
        <p class="muted">Los listados CAS, GHS, H y P están activos solo para Química.</p>
    }
    <div class="menu-grid">
        <article class="menu-item">
            <strong>Instituciones y normativas</strong>
            <p class="menu-desc">
                Catálogos, fichas y documentación general de referencia para el laboratorio.
            </p>
            <div class="menu-links">
                <NavLink class="btn-link" href="/documentacion/instituciones">Ver mosaico institucional</NavLink>
                <NavLink class="btn-link secondary" href="/documentacion/instituciones/documentos">Documentos institucionales</NavLink>
            </div>
        </article>
    </div>
</section>

<section id="upsa-general" class="page-card" style="margin-top:1.5rem;">
    <h3>Documentación del laboratorio (UPSA)</h3>
    <p class="section-intro">
        Manuales, procedimientos y protocolos internos del laboratorio.
    </p>
    <div class="menu-grid">
        <div class="menu-item">
            <strong>Documentación UPSA</strong>
            <div class="menu-links">
                <NavLink class="btn-link" href="/documentacion/upsa/manuales">Manuales</NavLink>
                <NavLink class="btn-link" href="/documentacion/upsa/procedimientos">Procedimientos</NavLink>
                <NavLink class="btn-link" href="/documentacion/upsa/protocolos">Protocolos internos</NavLink>
            </div>
        </div>
    </div>
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <h3>Selecciona el tipo de documentación (@(string.IsNullOrWhiteSpace(laboratorioNombre) ? "Laboratorio" : laboratorioNombre))</h3>
    <p class="section-intro">
        Elige una de las tres categorías principales del laboratorio.
    </p>
    <div class="type-grid">
        <article class="type-item">
            <h4>Documentación para asignaturas</h4>
            <p>Guías de práctica, planificaciones y material académico.</p>
            <NavLink class="btn-link" href="/documentacion/asignaturas">Ver asignaturas</NavLink>
        </article>
        @if (isQuimica)
        {
            <article class="type-item">
                <h4>Documentación de instituciones</h4>
                <p>Normativas externas: IUPAC, GHS, consejos de prudencia y peligros.</p>
                <NavLink class="btn-link" href="/documentacion/instituciones">Ver instituciones</NavLink>
            </article>
        }
        <article class="type-item">
            <h4>Documentación del laboratorio (UPSA)</h4>
            <p>Manuales internos, procedimientos y reglamentos del laboratorio.</p>
            <NavLink class="btn-link" href="/documentacion/upsa/manuales">Ver UPSA</NavLink>
        </article>
    </div>
</section>


@code {
    [Inject] private NpgsqlDataSource DataSource { get; set; } = default!;

    private readonly List<AsignaturaView> asignaturas = new();
    private string? loadError;
    private string? laboratorioNombre;
    private bool isQuimica;
    private string? _nuevoDocumentoTitulo;
    private string? _nuevoDocumentoCategoriaId;
    private string? _nuevoDocumentoSubcategoriaId;
    private string? _nuevoDocumentoDescripcion;
    private string? _nuevoDocumentoUrl;
    private string? _nuevoDocumentoArchivoLocal;
    private string? _nuevoDocumentoProcedencia;
    private string? _nuevoDocumentoImagenUrl;
    private string _nuevoDocumentoImagenModo = "url";
    private string? _nuevoDocumentoImagenArchivo;
    private string? _nuevoDocumentoNotas;
    private string? _nuevoDocumentoMsg;

    private readonly List<SelectOption> _categoriaOptions = new();
    private readonly List<SelectOption> _subcategoriaOptions = new();

    protected override void OnInitialized()
    {
        LaboratorioState.OnChange += HandleLaboratorioChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDocumentLookupsAsync();
        await LoadAsignaturasAsync();
    }

    private async void HandleLaboratorioChanged()
    {
        await LoadAsignaturasAsync();
        await InvokeAsync(StateHasChanged);
    }

    private void OnDocumentoImagenModoChanged(ChangeEventArgs args)
    {
        var value = args.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(value))
            _nuevoDocumentoImagenModo = value;
    }

    private async Task OnDocumentoImagenArchivoSeleccionado(InputFileChangeEventArgs args)
    {
        if (args.FileCount == 0) return;

        var file = args.File;
        var extension = Path.GetExtension(file.Name);
        var fileName = $"documento_{Guid.NewGuid():N}{extension}";
        var relativePath = Path.Combine("uploads", "documentos", fileName).Replace("\\", "/");
        var absolutePath = Path.Combine(HostEnvironment.WebRootPath, relativePath);
        Directory.CreateDirectory(Path.GetDirectoryName(absolutePath)!);

        await using var stream = file.OpenReadStream(5 * 1024 * 1024);
        await using var fileStream = File.Create(absolutePath);
        await stream.CopyToAsync(fileStream);

        _nuevoDocumentoImagenUrl = $"/{relativePath}";
        _nuevoDocumentoImagenArchivo = file.Name;
        _nuevoDocumentoMsg = $"Imagen cargada: {file.Name}";
    }

    private async Task LoadDocumentLookupsAsync()
    {
        _categoriaOptions.Clear();
        _subcategoriaOptions.Clear();

        await using var conn = await DataSource.OpenConnectionAsync();

        await using (var cmd = new NpgsqlCommand("SELECT categoria_id, nombre FROM categorias WHERE nombre = 'Documentación' ORDER BY nombre", conn))
        await using (var reader = await cmd.ExecuteReaderAsync())
            while (await reader.ReadAsync())
                _categoriaOptions.Add(new SelectOption(reader.GetString(0), reader.GetString(1)));

        const string subcategoriaSql = @"
            SELECT s.subcategoria_id, s.nombre, c.nombre
            FROM subcategorias s
            INNER JOIN categorias c ON c.categoria_id = s.categoria_id
            WHERE c.nombre = 'Documentación'
            ORDER BY c.nombre, s.nombre";
        await using (var cmd = new NpgsqlCommand(subcategoriaSql, conn))
        await using (var reader = await cmd.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                var label = $"{reader.GetString(2)} · {reader.GetString(1)}";
                _subcategoriaOptions.Add(new SelectOption(reader.GetString(0), label));
            }
        }
    }

    private async Task LoadAsignaturasAsync()
    {
        try
        {
            loadError = null;
            asignaturas.Clear();
            laboratorioNombre = null;
            isQuimica = false;
            await using var conn = await DataSource.OpenConnectionAsync();

            const string sqlLab = @"
                SELECT nombre
                FROM laboratorios
                WHERE laboratorio_id = @laboratorio
                ";
            await using (var cmdLab = new NpgsqlCommand(sqlLab, conn))
            {
                cmdLab.Parameters.AddWithValue("laboratorio", LaboratorioState.LaboratorioId);
                laboratorioNombre = (string?)await cmdLab.ExecuteScalarAsync();
            }
            var labNombre = laboratorioNombre ?? string.Empty;
            isQuimica = LaboratorioState.LaboratorioId == 1
                || labNombre.Contains("quim", StringComparison.OrdinalIgnoreCase);

            const string sqlAsignaturas = @"
                SELECT asignatura_id,
                       nombre,
                       codigo_clase,
                       COALESCE(descripcion_detalle, '')
                FROM asignaturas
                WHERE laboratorio_id = @laboratorio
                ORDER BY nombre
                ";
            await using var cmd = new NpgsqlCommand(sqlAsignaturas, conn);
            cmd.Parameters.AddWithValue("laboratorio", LaboratorioState.LaboratorioId);
            await using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                var id = reader.GetString(0);
                var nombre = reader.GetString(1);
                var codigo = reader.GetString(2);
                var descripcion = reader.GetString(3);
                var slug = Slugify(!string.IsNullOrWhiteSpace(codigo) ? codigo : nombre);
                asignaturas.Add(new AsignaturaView(id, nombre, codigo, slug, descripcion));
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private async Task SubirDocumentoAsync()
    {
        if (string.IsNullOrWhiteSpace(_nuevoDocumentoTitulo))
        {
            _nuevoDocumentoMsg = "Ingresa un título para el documento.";
            return;
        }

        var docId = $"doc_{Guid.NewGuid():N}".Substring(0, 12);
        await using var conn = await DataSource.OpenConnectionAsync();
        const string sql = @"
            INSERT INTO documentos
            (documento_id, titulo, categoria_id, subcategoria_id, descripcion_detalle, url, archivo_local,
             procedencia, imagen_url, notas, laboratorio_id)
            VALUES (@id, @titulo, @categoria, @subcategoria, @descripcion, @url, @archivo,
                    @procedencia, @imagen, @notas, @lab)";
        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("id", docId);
        cmd.Parameters.AddWithValue("titulo", _nuevoDocumentoTitulo!);
        cmd.Parameters.AddWithValue("categoria", string.IsNullOrWhiteSpace(_nuevoDocumentoCategoriaId) ? (object)DBNull.Value : _nuevoDocumentoCategoriaId!);
        cmd.Parameters.AddWithValue("subcategoria", string.IsNullOrWhiteSpace(_nuevoDocumentoSubcategoriaId) ? (object)DBNull.Value : _nuevoDocumentoSubcategoriaId!);
        cmd.Parameters.AddWithValue("descripcion", string.IsNullOrWhiteSpace(_nuevoDocumentoDescripcion) ? (object)DBNull.Value : _nuevoDocumentoDescripcion!);
        cmd.Parameters.AddWithValue("url", string.IsNullOrWhiteSpace(_nuevoDocumentoUrl) ? (object)DBNull.Value : _nuevoDocumentoUrl!);
        cmd.Parameters.AddWithValue("archivo", string.IsNullOrWhiteSpace(_nuevoDocumentoArchivoLocal) ? (object)DBNull.Value : _nuevoDocumentoArchivoLocal!);
        cmd.Parameters.AddWithValue("procedencia", string.IsNullOrWhiteSpace(_nuevoDocumentoProcedencia) ? "UNIVERSIDAD" : _nuevoDocumentoProcedencia!);
        cmd.Parameters.AddWithValue("imagen", string.IsNullOrWhiteSpace(_nuevoDocumentoImagenUrl) ? (object)DBNull.Value : _nuevoDocumentoImagenUrl!);
        cmd.Parameters.AddWithValue("notas", string.IsNullOrWhiteSpace(_nuevoDocumentoNotas) ? (object)DBNull.Value : _nuevoDocumentoNotas!);
        cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);
        await cmd.ExecuteNonQueryAsync();

        _nuevoDocumentoTitulo = null;
        _nuevoDocumentoCategoriaId = null;
        _nuevoDocumentoSubcategoriaId = null;
        _nuevoDocumentoDescripcion = null;
        _nuevoDocumentoUrl = null;
        _nuevoDocumentoArchivoLocal = null;
        _nuevoDocumentoProcedencia = null;
        _nuevoDocumentoImagenUrl = null;
        _nuevoDocumentoImagenModo = "url";
        _nuevoDocumentoImagenArchivo = null;
        _nuevoDocumentoNotas = null;
        _nuevoDocumentoMsg = "Documento registrado.";
    }

    private static string Slugify(string value)
    {
        var lower = value.ToLowerInvariant();
        var normalized = System.Text.RegularExpressions.Regex.Replace(lower, @"[^a-z0-9]+", "-");
        return normalized.Trim('-');
    }

    private sealed record SelectOption(string Id, string Label);
    private sealed record AsignaturaView(string Id, string Nombre, string Codigo, string Slug, string Descripcion);

    public void Dispose()
    {
        LaboratorioState.OnChange -= HandleLaboratorioChanged;
    }
}

<style>
    .section-intro { color:#4b5563; margin-bottom:0.75rem; }
    .form-header {
        margin-top: 0.75rem;
        margin-bottom: 0.75rem;
    }

        .form-header h4 {
            margin: 0 0 0.25rem 0;
            font-weight: 700;
            color: #0f172a;
        }

    .form-hint {
        margin: 0;
        color: #64748b;
        font-size: 0.95rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
        align-items: start;
    }

    .full-span {
        grid-column: 1 / -1;
    }

    .form-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 0.25rem;
    }

    .btn.primary {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.18);
    }

    .btn.primary:hover {
        background: #1d4ed8;
    }
    .upload-card {
        border: 1px dashed #d1d5db;
        padding: 0.6rem;
        border-radius: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 220px;
    }

    .upload-options {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .upload-drop {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        color: #6b7280;
        cursor: pointer;
    }

        .upload-drop input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
    .menu-grid {
        display:grid;
        gap:1rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .menu-item {
        border:1px solid #e5e7eb;
        border-radius:0.8rem;
        padding:0.9rem 1rem;
        background:#fff;
    }
    .menu-title {
        display:flex;
        flex-direction:column;
        gap:0.25rem;
        font-weight:600;
        color:#0b2a68;
    }
    .menu-thumb {
        width:100%;
        height:90px;
        border-radius:0.6rem;
        background:linear-gradient(135deg, rgba(30, 64, 175, 0.2), rgba(147, 197, 253, 0.25));
        position:relative;
        overflow:hidden;
    }
    .menu-thumb::after {
        content:"";
        position:absolute;
        inset:0;
        background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(15,23,42,0.2));
    }
    .menu-desc {
        color:#475569;
        margin:0.45rem 0 0;
    }
    .menu-links {
        display:flex;
        flex-wrap:wrap;
        gap:0.4rem;
        margin-top:0.6rem;
    }
    .empty-note { color:#6b7280; margin-top:0.75rem; }
    .type-grid {
        display:grid;
        gap:1rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .type-item {
        border:1px solid #e5e7eb;
        border-radius:0.8rem;
        padding:0.9rem 1rem;
        background:#fff;
        display:flex;
        flex-direction:column;
        gap:0.6rem;
    }
    .type-item h4 { margin:0 0 0.2rem; color:#0b2a68; }
    .error-note { color:#b91c1c; font-size:0.9rem; margin:0 0 0.75rem; }
    .muted { color:#6b7280; font-size:0.85rem; }
    .assign-row {
        display:flex;
        flex-wrap:wrap;
        gap:0.5rem;
        align-items:center;
        margin-top:0.5rem;
    }
    .btn-link {
        display:inline-flex;
        width:max-content;
        padding:0.35rem 0.6rem;
        border-radius:0.5rem;
        background:#0b2a68;
        color:#fff;
        text-decoration:none;
        font-size:0.85rem;
    }
    .btn-link:hover { background:#143a84; }
    .btn-link.secondary {
        background:#e2e8f0;
        color:#0b2a68;
    }
    .btn-link.secondary:hover { background:#cbd5f5; }
    .link-stack { display:flex; flex-direction:column; gap:0.35rem; }
</style>
