@page "/documentacion/instituciones/p-codes/{Code}"
@using BARI_web.General_Services
@using Npgsql
@inject LaboratorioState LaboratorioState
@implements IDisposable

<PageTitle>Detalle P-Code</PageTitle>

<section class="page-card">
    <h2>P-Code: @Code</h2>
    <p>Detalle del P-code y su uso en sustancias.</p>
    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.5rem;">
    @if (detalle is not null)
    {
        <div class="detail-card">
            <div>
                <h3>@detalle.Descripcion</h3>
                <p>Uso en sustancias: <strong>@detalle.UsoCount</strong></p>
            </div>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(loadError))
    {
        <p class="error-note">No se pudo cargar el P-code: @loadError</p>
    }
</section>

@code {
    [Parameter] public string Code { get; set; } = "";
    [Inject] private NpgsqlDataSource DataSource { get; set; } = default!;

    private CodeDetalle? detalle;
    private string? loadError;

    protected override void OnInitialized()
    {
        LaboratorioState.OnChange += HandleLaboratorioChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadDetalleAsync();
    }

    private async void HandleLaboratorioChanged()
    {
        await LoadDetalleAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadDetalleAsync()
    {
        try
        {
            loadError = null;
            await using var conn = await DataSource.OpenConnectionAsync();
            const string sql = @"
                SELECT p.p_id, p.descripcion,
                       COALESCE(COUNT(s.sustancia_id), 0) AS uso_count
                FROM p_codes p
                LEFT JOIN sustancias_p sp ON sp.p_id = p.p_id
                LEFT JOIN sustancias s
                       ON s.sustancia_id = sp.sustancia_id
                      AND s.laboratorio_id = @laboratorio
                WHERE p.p_id = @id
                GROUP BY p.p_id, p.descripcion
                ";
            await using var cmd = new NpgsqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("id", Code);
            cmd.Parameters.AddWithValue("laboratorio", LaboratorioState.LaboratorioId);
            await using var reader = await cmd.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                detalle = new CodeDetalle(
                    reader.GetString(0),
                    reader.GetString(1),
                    reader.GetInt64(2)
                );
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private sealed record CodeDetalle(string Code, string Descripcion, long UsoCount);

    public void Dispose()
    {
        LaboratorioState.OnChange -= HandleLaboratorioChanged;
    }
}

<style>
    .detail-card { display:flex; gap:1rem; align-items:center; }
    .error-note { color:#b91c1c; margin-top:0.75rem; }
</style>
