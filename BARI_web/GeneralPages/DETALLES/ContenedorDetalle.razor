@page "/inventario-sustancias/contenedor/{ContenedorId}"
@using Npgsql
@using System.Globalization
@using System.IO
@using System.Linq
@using Microsoft.AspNetCore.Components.Forms
@inject NpgsqlDataSource DataSource
@inject LaboratorioState LaboratorioState
@inject IWebHostEnvironment HostEnvironment
@inject NavigationManager Nav
@implements IDisposable

<PageTitle>@(isLoading ? "Detalle de Contenedor" : (found ? $"Contenedor {edit.ContenedorId}" : "Contenedor"))</PageTitle>

<section class="page-card">
    <div class="header-row">
        <div>
            <h2>Detalle de Contenedor</h2>
            <div class="muted">ID: <b>@(ContenedorId ?? "—")</b></div>
        </div>
        <div class="header-actions">
            <button class="btn" type="button" @onclick="GoBack">Volver</button>
        </div>
    </div>

    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.2rem;">
    @if (!string.IsNullOrWhiteSpace(loadError))
    {
        <p class="error-note">Error: @loadError</p>
    }
    else if (isLoading)
    {
        <p><em>Cargando…</em></p>
    }
    else if (!found)
    {
        <div class="empty">
            No se encontró el contenedor <b>@(ContenedorId ?? "")</b> en el laboratorio actual.
        </div>
    }
    else
    {
        @* ======= VISTA (ESTÉTICA) ======= *@
        @if (!isEditing)
        {
            <div class="detail-grid">
                <div class="detail-media">
                    @if (!string.IsNullOrWhiteSpace(edit.ImagenUrl))
                    {
                        <img class="material-img"
                             src="@ResolveImagenUrl(edit.ImagenUrl)"
                             alt="Imagen del contenedor"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                        <div class="img-placeholder" style="display:none;">Sin imagen</div>
                    }
                    else
                    {
                        <div class="img-placeholder">Sin imagen</div>
                    }

                    @if (!string.IsNullOrWhiteSpace(edit.ImagenUrl))
                    {
                        <div class="text-xs muted" style="margin-top:.35rem;">
                            <span>Imagen:</span> <code>@edit.ImagenUrl</code>
                        </div>
                    }

                    <div class="chips-row" style="margin-top:.75rem;">
                        <span class="chip"><b>Condición</b> · @NullDash(CondicionLabel)</span>
                        <span class="chip gray"><b>Área</b> · @NullDash(AreaLabel)</span>
                        <span class="chip gray"><b>Mesón</b> · @NullDash(MesonLabel)</span>
                    </div>
                </div>

                <div class="detail-info">
                    <div class="title-row">
                        <h3 style="margin:0;">Contenedor @edit.ContenedorId</h3>
                        <div class="badges">
                            <span class="badge">@NullDash(edit.Reactivo)</span>
                            <span class="badge gray">@NullDash(edit.Marca)</span>
                        </div>
                    </div>

                    <div class="dl">
                        <div class="dl-row">
                            <div class="dt">Reactivo</div>
                            <div class="dd">
                                <NavLink href="@($"/inventario-sustancias/{edit.SustanciaId}")">
                                    @NullDash(edit.Reactivo)
                                </NavLink>
                            </div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Densidad</div>
                            <div class="dd">@NullDash(edit.Densidad)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Proveedor</div>
                            <div class="dd">@NullDash(edit.Proveedor)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Cantidad nominal</div>
                            <div class="dd">@NullDash(edit.CantidadNominalTexto)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Cantidad actual</div>
                            <div class="dd">@NullDash(edit.CantidadActualTexto)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Ubicación</div>
                            <div class="dd">@BuildUbicacion(AreaLabel, MesonLabel, edit.Nivel, edit.Posicion)</div>
                        </div>

                        @* ✅ NUEVO: altura *@
                        <div class="dl-row">
                            <div class="dt">Altura (cm)</div>
                            <div class="dd">@NullDash(edit.AlturaCm)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Envase</div>
                            <div class="dd">@NullDash(edit.Envase)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">QR</div>
                            <div class="dd">@NullDash(edit.Qr)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Fechas</div>
                            <div class="dd">
                                Compra: <b>@NullDash(edit.FechaCompraTexto)</b> ·
                                Recepción: <b>@NullDash(edit.FechaRecepcionTexto)</b> ·
                                Apertura: <b>@NullDash(edit.FechaAperturaTexto)</b> ·
                                Vencimiento: <b>@NullDash(edit.FechaVencimientoTexto)</b>
                            </div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Observaciones</div>
                            <div class="dd">@NullDash(edit.Observaciones)</div>
                        </div>
                    </div>

                    <div class="view-actions">
                        <button class="btn primary" type="button" @onclick="StartEdit">Editar</button>

                        @if (!confirmDelete)
                        {
                            <button class="btn danger" type="button" @onclick="AskDelete">Eliminar</button>
                        }
                        else
                        {
                            <button class="btn danger" type="button" @onclick="DeleteAsync" disabled="@isSaving">Confirmar eliminar</button>
                            <button class="btn" type="button" @onclick="CancelDelete" disabled="@isSaving">Cancelar</button>
                        }

                        @if (!string.IsNullOrWhiteSpace(msg))
                        {
                            <span class="text-sm muted">@msg</span>
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            @* ======= MODO EDICIÓN (FORM ESTILO ESTÁNDAR) ======= *@
            <div class="form-header">
                <h4>Editar contenedor</h4>
                <p class="form-hint">
                    Actualiza stock, condición, fechas, ubicación y QR. Guarda para aplicar.
                </p>
            </div>

            <div class="form-grid">
                <div class="field full-span">
                    <label>Reactivo</label>
                    <div class="readonly">
                        <NavLink href="@($"/inventario-sustancias/{edit.SustanciaId}")">@edit.Reactivo</NavLink>
                        <span class="muted">(@edit.SustanciaId)</span>
                    </div>
                </div>

                <div class="field">
                    <label>Proveedor</label>
                    <input class="border p-1" placeholder="Proveedor" @bind="edit.Proveedor" />
                </div>

                <div class="field">
                    <label>Condición</label>
                    <select class="border p-1" @bind="edit.CondicionId">
                        <option value="">(sin condición)</option>
                        @foreach (var c in _condicionOptions)
                        {
                            <option value="@c.Id">@c.Label</option>
                        }
                    </select>
                </div>

                <div class="field">
                    <label>Cantidad nominal</label>
                    <input class="border p-1" type="number" step="any" placeholder="Ej: 500" @bind="edit.CantidadNominal" />
                    <div class="text-xs muted">Unidad: <b>@NullDash(edit.UnidadSimbolo)</b></div>
                </div>

                <div class="field">
                    <label>Cantidad actual</label>
                    <input class="border p-1" type="number" step="any" placeholder="Ej: 120" @bind="edit.CantidadActual" />
                    <div class="text-xs muted">Unidad: <b>@NullDash(edit.UnidadSimbolo)</b></div>
                </div>

                <div class="field">
                    <label>Fecha de apertura</label>
                    <input class="border p-1" type="date" @bind-value="edit.FechaApertura" @bind-value:format="yyyy-MM-dd" />
                </div>

                <div class="field">
                    <label>Fecha de vencimiento</label>
                    <input class="border p-1" type="date" @bind-value="edit.FechaVencimiento" @bind-value:format="yyyy-MM-dd" />
                </div>

                <div class="field">
                    <label>Área</label>
                    <select class="border p-1" value="@edit.AreaId" @onchange="OnAreaChanged">
                        <option value="">(selecciona)</option>
                        @foreach (var a in _areaOptions)
                        {
                            <option value="@a.Id">@a.Label</option>
                        }
                    </select>
                </div>

                <div class="field">
                    <label>Mesón</label>
                    <select class="border p-1"
                            value="@edit.MesonId"
                            @onchange="OnMesonChanged"
                            disabled="@string.IsNullOrWhiteSpace(edit.AreaId)">
                        <option value="">(selecciona)</option>
                        @foreach (var m in _mesonOptions)
                        {
                            <option value="@m.Id">@m.Label</option>
                        }
                    </select>
                </div>

                <div class="field">
                    <label>Nivel</label>
                    <input class="border p-1" type="number" step="1" placeholder="Nivel" @bind="edit.Nivel" />
                </div>

                <div class="field">
                    <label>Posición</label>
                    <input class="border p-1" placeholder="Ej: al fondo" @bind="edit.Posicion" />
                </div>

                @* ✅ NUEVO: altura *@
                <div class="field">
                    <label>Altura (cm)</label>
                    <input class="border p-1" type="number" step="any" placeholder="Ej: 25" @bind="edit.AlturaCm" />
                </div>

                <div class="field">
                    <label>QR</label>
                    <input class="border p-1" placeholder="QR" @bind="edit.Qr" />
                </div>

                <div class="field full-span">
                    <label>Observaciones</label>
                    <textarea class="border p-1" rows="3" placeholder="Observaciones" @bind="edit.Observaciones"></textarea>
                </div>

                @* ===== Imagen ===== *@
                <div class="upload-card full-span">
                    <div class="upload-options">
                        <label class="text-sm">
                            <input type="radio" name="imagenModoCont"
                                   value="url"
                                   checked="@(_imagenModo == "url")"
                                   @onchange="OnImagenModoChanged" />
                            Colocar un URL
                        </label>
                        <label class="text-sm">
                            <input type="radio" name="imagenModoCont"
                                   value="archivo"
                                   checked="@(_imagenModo == "archivo")"
                                   @onchange="OnImagenModoChanged" />
                            Subir archivo
                        </label>
                    </div>

                    @if (_imagenModo == "url")
                    {
                        <input class="border p-1" placeholder="Imagen URL (o ruta relativa)" @bind="edit.ImagenUrl" />
                    }
                    else
                    {
                        <label class="upload-drop">
                            <InputFile OnChange="OnImagenArchivoSeleccionado" accept="image/png,image/jpeg,image/jpg,image/webp" />
                            <span>Arrastra una imagen o haz clic para buscar</span>
                        </label>

                        @if (!string.IsNullOrWhiteSpace(_imagenArchivoNombre))
                        {
                            <div class="text-xs muted">Archivo: @_imagenArchivoNombre</div>
                        }
                    }

                    @if (!string.IsNullOrWhiteSpace(edit.ImagenUrl))
                    {
                        <div class="preview-row">
                            <div class="text-xs muted">Preview:</div>
                            <img class="material-img-sm"
                                 src="@ResolveImagenUrl(edit.ImagenUrl)"
                                 alt="Preview"
                                 onerror="this.style.display='none';" />
                            <div class="text-xs muted">Guardará: <code>@edit.ImagenUrl</code></div>
                        </div>
                    }
                </div>

                <div class="form-actions full-span">
                    <button class="btn primary" type="button" @onclick="SaveAsync" disabled="@isSaving">Guardar cambios</button>
                    <button class="btn" type="button" @onclick="CancelEdit" disabled="@isSaving">Cancelar</button>

                    @if (!confirmDelete)
                    {
                        <button class="btn danger" type="button" @onclick="AskDelete" disabled="@isSaving">Eliminar</button>
                    }
                    else
                    {
                        <button class="btn danger" type="button" @onclick="DeleteAsync" disabled="@isSaving">Confirmar eliminar</button>
                        <button class="btn" type="button" @onclick="CancelDelete" disabled="@isSaving">Cancelar eliminar</button>
                    }

                    @if (!string.IsNullOrWhiteSpace(msg))
                    {
                        <span class="text-sm muted">@msg</span>
                    }
                </div>
            </div>
        }
    }
</section>

@code {
    [Parameter] public string? ContenedorId { get; set; }

    private bool isLoading = true;
    private bool isSaving = false;
    private bool found = false;

    private bool isEditing = false;
    private bool confirmDelete = false;

    private string? loadError;
    private string? msg;

    private ContenedorEdit edit = new();

    // Imagen
    private string _imagenModo = "url";
    private string? _imagenArchivoNombre;

    // Lookups
    private readonly List<SelectOption> _condicionOptions = new();
    private readonly List<SelectOption> _areaOptions = new();
    private readonly List<SelectOption> _mesonOptions = new();

    // ======= lifecycle =======
    protected override void OnInitialized()
    {
        LaboratorioState.OnChange += HandleLaboratorioChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await ReloadAllAsync();
    }

    private void HandleLaboratorioChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await ReloadAllAsync();
            StateHasChanged();
        });
    }

    private async Task ReloadAllAsync()
    {
        loadError = null;
        msg = null;
        confirmDelete = false;

        isLoading = true;
        isSaving = false;
        found = false;
        isEditing = false;

        _condicionOptions.Clear();
        _areaOptions.Clear();
        _mesonOptions.Clear();

        edit = new ContenedorEdit();

        try
        {
            var id = (ContenedorId ?? "").Trim();
            if (string.IsNullOrWhiteSpace(id))
            {
                found = false;
                return;
            }

            await using var conn = await DataSource.OpenConnectionAsync();

            await LoadLookupsAsync(conn);
            await LoadContenedorAsync(conn, id);

            if (!found) return;

            if (!string.IsNullOrWhiteSpace(edit.AreaId))
                await LoadMesonesAsync(conn, edit.AreaId);

            _imagenModo = "url";
            _imagenArchivoNombre = null;

            // Derivados para vista
            ComputeDisplayStrings();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/inventario-sustancias");
    }

    private void StartEdit()
    {
        msg = null;
        confirmDelete = false;
        isEditing = true;
    }

    private async Task CancelEdit()
    {
        msg = null;
        confirmDelete = false;
        isEditing = false;
        await ReloadAllAsync();
    }

    private void AskDelete()
    {
        confirmDelete = true;
        msg = "Esto eliminará el contenedor. Presiona Confirmar eliminar para continuar.";
    }

    private void CancelDelete()
    {
        confirmDelete = false;
        msg = null;
    }

    // ======= Labels =======
    private string CondicionLabel => FindLabel(_condicionOptions, edit.CondicionId);
    private string AreaLabel => FindLabel(_areaOptions, edit.AreaId);
    private string MesonLabel => FindLabel(_mesonOptions, edit.MesonId);

    private static string FindLabel(List<SelectOption> list, string? id)
        => string.IsNullOrWhiteSpace(id) ? "" : (list.FirstOrDefault(x => string.Equals(x.Id, id, StringComparison.OrdinalIgnoreCase))?.Label ?? id);

    private static string NullDash(string? s) => string.IsNullOrWhiteSpace(s) ? "—" : s;

    private static string BuildUbicacion(string area, string meson, string? nivel, string? posicion)
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(area)) parts.Add(area);
        if (!string.IsNullOrWhiteSpace(meson)) parts.Add(meson);
        if (!string.IsNullOrWhiteSpace(nivel)) parts.Add($"Nivel {nivel}");
        if (!string.IsNullOrWhiteSpace(posicion)) parts.Add(posicion);
        return parts.Count == 0 ? "Sin ubicación" : string.Join(" · ", parts);
    }

    // ======= Lookups =======
    private async Task LoadLookupsAsync(NpgsqlConnection conn)
    {
        // Condiciones
        await using (var cmd = new NpgsqlCommand("SELECT condicion_id, nombre FROM condiciones ORDER BY nombre", conn))
        await using (var r = await cmd.ExecuteReaderAsync())
        {
            while (await r.ReadAsync())
                _condicionOptions.Add(new SelectOption(r.GetString(0), r.GetString(1)));
        }

        // Áreas
        const string areaSql = @"
            SELECT area_id, nombre_areas
            FROM areas
            WHERE laboratorio_id = @lab
            ORDER BY nombre_areas";
        await using (var cmd = new NpgsqlCommand(areaSql, conn))
        {
            cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);
            await using var r = await cmd.ExecuteReaderAsync();
            while (await r.ReadAsync())
                _areaOptions.Add(new SelectOption(r.GetString(0), r.GetString(1)));
        }
    }

    private async Task LoadMesonesAsync(NpgsqlConnection conn, string areaId)
    {
        _mesonOptions.Clear();

        const string mesonSql = @"
            SELECT m.meson_id,
                   COALESCE(NULLIF(m.nombre_meson, ''), m.meson_id) AS nombre_meson
            FROM mesones m
            INNER JOIN areas a ON a.area_id = m.area_id AND a.laboratorio_id = @lab
            WHERE m.area_id = @area
            ORDER BY nombre_meson";

        await using var cmd = new NpgsqlCommand(mesonSql, conn);
        cmd.Parameters.AddWithValue("area", areaId);
        cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);

        await using var r = await cmd.ExecuteReaderAsync();
        while (await r.ReadAsync())
            _mesonOptions.Add(new SelectOption(r.GetString(0), r.GetString(1)));
    }

    // ======= Carga contenedor =======
    private async Task LoadContenedorAsync(NpgsqlConnection conn, string contId)
    {
        const string sql = @"
            SELECT c.cont_id,
                   c.sustancia_id,
                   COALESCE(NULLIF(s.nombre_comercial, ''), NULLIF(s.nombre_quimico, ''), s.sustancia_id) AS reactivo,

                   COALESCE(ma.nombre, '') AS marca,
                   c.densidad_g_ml,
                   c.proveedor,

                   c.cantidad_reactivo_nominal,
                   c.cantidad_reactivo_actual,
                   COALESCE(u.simbolo, '') AS unidad,

                   c.condicion_id,
                   c.fecha_compra,
                   c.fecha_recepcion,
                   c.fecha_apertura,
                   c.fecha_vencimiento,

                   c.area_id,
                   c.meson_id,
                   c.nivel,
                   c.posicion,

                   c.color_envase,
                   c.masa_envase_vacio_g,
                   c.masa_tapa_g,
                   c.altura_cm,

                   c.qr,
                   c.observaciones,
                   c.imagen_url
            FROM contenedores c
            INNER JOIN sustancias s ON s.sustancia_id = c.sustancia_id
            LEFT JOIN marcas ma ON ma.marca_id = c.marca_id
            LEFT JOIN unidades u ON u.unidad_id = c.unidad_id
            WHERE c.cont_id = @id
              AND c.laboratorio_id = @lab
            LIMIT 1;
        ";

        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("id", contId);
        cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);

        await using var r = await cmd.ExecuteReaderAsync();
        if (!await r.ReadAsync())
        {
            found = false;
            return;
        }

        found = true;

        edit = new ContenedorEdit
            {
                ContenedorId = r.GetString(0),
                SustanciaId = r.GetString(1),
                Reactivo = r.IsDBNull(2) ? "" : r.GetString(2),

                Marca = r.IsDBNull(3) ? "" : r.GetString(3),
                Densidad = r.IsDBNull(4) ? "" : $"{r.GetDecimal(4).ToString(CultureInfo.InvariantCulture)} g/mL",
                Proveedor = r.IsDBNull(5) ? "" : r.GetString(5),

                CantidadNominal = r.IsDBNull(6) ? null : r.GetDecimal(6).ToString(CultureInfo.InvariantCulture),
                CantidadActual = r.IsDBNull(7) ? null : r.GetDecimal(7).ToString(CultureInfo.InvariantCulture),
                UnidadSimbolo = r.IsDBNull(8) ? "" : r.GetString(8),

                CondicionId = r.IsDBNull(9) ? null : r.GetString(9),

                FechaCompra = r.IsDBNull(10) ? (DateTime?)null : r.GetDateTime(10),
                FechaRecepcion = r.IsDBNull(11) ? (DateTime?)null : r.GetDateTime(11),
                FechaApertura = r.IsDBNull(12) ? (DateTime?)null : r.GetDateTime(12),
                FechaVencimiento = r.IsDBNull(13) ? (DateTime?)null : r.GetDateTime(13),

                AreaId = r.IsDBNull(14) ? null : r.GetString(14),
                MesonId = r.IsDBNull(15) ? null : r.GetString(15),
                Nivel = r.IsDBNull(16) ? null : r.GetInt32(16).ToString(CultureInfo.InvariantCulture),
                Posicion = r.IsDBNull(17) ? null : r.GetString(17),

                Envase = BuildEnvase(
                        r.IsDBNull(18) ? null : r.GetString(18),
                        r.IsDBNull(19) ? (decimal?)null : r.GetDecimal(19),
                        r.IsDBNull(20) ? (decimal?)null : r.GetDecimal(20)
                    ),

                AlturaCm = r.IsDBNull(21) ? null : r.GetDecimal(21).ToString(CultureInfo.InvariantCulture),

                Qr = r.IsDBNull(22) ? "" : r.GetString(22),
                Observaciones = r.IsDBNull(23) ? "" : r.GetString(23),
                ImagenUrl = r.IsDBNull(24) ? "" : r.GetString(24),
            };

        // textos
        edit.FechaCompraTexto = FormatDate(edit.FechaCompra);
        edit.FechaRecepcionTexto = FormatDate(edit.FechaRecepcion);
        edit.FechaAperturaTexto = FormatDate(edit.FechaApertura);
        edit.FechaVencimientoTexto = FormatDate(edit.FechaVencimiento);
    }

    private void ComputeDisplayStrings()
    {
        // cantidad strings para vista
        edit.CantidadNominalTexto = BuildCantidad(edit.CantidadNominal, edit.UnidadSimbolo);
        edit.CantidadActualTexto = BuildCantidad(edit.CantidadActual, edit.UnidadSimbolo);

        edit.FechaCompraTexto = FormatDate(edit.FechaCompra);
        edit.FechaRecepcionTexto = FormatDate(edit.FechaRecepcion);
        edit.FechaAperturaTexto = FormatDate(edit.FechaApertura);
        edit.FechaVencimientoTexto = FormatDate(edit.FechaVencimiento);
    }

    private static string BuildCantidad(string? n, string? unidad)
    {
        if (string.IsNullOrWhiteSpace(n)) return "—";
        var u = string.IsNullOrWhiteSpace(unidad) ? "" : $" {unidad}";
        return $"{n}{u}".Trim();
    }

    private static string FormatDate(DateTime? dt)
        => dt.HasValue ? dt.Value.ToString("dd/MM/yyyy") : "—";

    private static string BuildEnvase(string? color, decimal? envase, decimal? tapa)
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(color)) parts.Add(color);
        if (envase.HasValue) parts.Add($"envase {envase.Value.ToString(CultureInfo.InvariantCulture)} g");
        if (tapa.HasValue) parts.Add($"tapa {tapa.Value.ToString(CultureInfo.InvariantCulture)} g");
        return parts.Count == 0 ? "—" : string.Join(" · ", parts);
    }

    // ======= handlers =======
    private async Task OnAreaChanged(ChangeEventArgs args)
    {
        var newArea = args.Value?.ToString();
        edit.AreaId = string.IsNullOrWhiteSpace(newArea) ? null : newArea;
        edit.MesonId = null;

        _mesonOptions.Clear();

        if (!string.IsNullOrWhiteSpace(edit.AreaId))
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            await LoadMesonesAsync(conn, edit.AreaId);
        }

        msg = null;
        await InvokeAsync(StateHasChanged);
    }

    private void OnMesonChanged(ChangeEventArgs args)
    {
        var v = args.Value?.ToString();
        edit.MesonId = string.IsNullOrWhiteSpace(v) ? null : v;
    }

    private void OnImagenModoChanged(ChangeEventArgs args)
    {
        var v = args.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(v))
            _imagenModo = v;
    }

    private async Task OnImagenArchivoSeleccionado(InputFileChangeEventArgs args)
    {
        if (args.FileCount == 0) return;

        var file = args.File;
        var extension = Path.GetExtension(file.Name);
        var fileName = $"contenedor_{Guid.NewGuid():N}{extension}";
        var relativePath = Path.Combine("uploads", "contenedores", fileName).Replace("\\", "/");
        var absolutePath = Path.Combine(HostEnvironment.WebRootPath, relativePath);
        Directory.CreateDirectory(Path.GetDirectoryName(absolutePath)!);

        await using var stream = file.OpenReadStream(5 * 1024 * 1024);
        await using var fs = File.Create(absolutePath);
        await stream.CopyToAsync(fs);

        edit.ImagenUrl = $"/{relativePath}";
        _imagenArchivoNombre = file.Name;
        msg = $"Imagen cargada: {file.Name}";
    }

    // ======= guardar =======
    private async Task SaveAsync()
    {
        msg = null;
        confirmDelete = false;

        if (!found)
        {
            msg = "No hay contenedor cargado.";
            return;
        }

        // ubicación obligatoria (según tu regla)
        if (string.IsNullOrWhiteSpace(edit.AreaId))
        {
            msg = "Selecciona un área.";
            return;
        }

        if (string.IsNullOrWhiteSpace(edit.MesonId))
        {
            msg = "Selecciona un mesón.";
            return;
        }

        // parseos (si falla, avisar)
        if (!TryParseDecimalOrNull(edit.CantidadNominal, out var nominal, out var errNom))
        {
            msg = $"Cantidad nominal inválida: {errNom}";
            return;
        }
        if (!TryParseDecimalOrNull(edit.CantidadActual, out var actual, out var errAct))
        {
            msg = $"Cantidad actual inválida: {errAct}";
            return;
        }

        // ✅ NUEVO: altura_cm
        if (!TryParseDecimalOrNull(edit.AlturaCm, out var alturaCm, out var errAlt))
        {
            msg = $"Altura (cm) inválida: {errAlt}";
            return;
        }

        isSaving = true;

        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            await using var tx = await conn.BeginTransactionAsync();

            // Blindaje: mesón pertenece al área y laboratorio
            const string checkMeson = @"
                SELECT COUNT(*)
                FROM mesones m
                INNER JOIN areas a ON a.area_id = m.area_id
                WHERE m.meson_id = @meson
                  AND m.area_id = @area
                  AND a.laboratorio_id = @lab";
            await using (var chk = new NpgsqlCommand(checkMeson, conn, tx))
            {
                chk.Parameters.AddWithValue("meson", edit.MesonId!);
                chk.Parameters.AddWithValue("area", edit.AreaId!);
                chk.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);

                var ok = Convert.ToInt64(await chk.ExecuteScalarAsync()) > 0;
                if (!ok)
                {
                    msg = "El mesón no pertenece al área seleccionada (o no es del laboratorio).";
                    return;
                }
            }

            const string sql = @"
                UPDATE contenedores
                SET proveedor = @proveedor,
                    cantidad_reactivo_nominal = @cantidad_nominal,
                    cantidad_reactivo_actual = @cantidad_actual,
                    condicion_id = @condicion,
                    fecha_apertura = @fecha_apertura,
                    fecha_vencimiento = @fecha_vencimiento,
                    area_id = @area,
                    meson_id = @meson,
                    nivel = @nivel,
                    posicion = @posicion,
                    altura_cm = @altura_cm,
                    qr = @qr,
                    observaciones = @observaciones,
                    imagen_url = @imagen
                WHERE cont_id = @id
                  AND laboratorio_id = @lab";

            await using var cmd = new NpgsqlCommand(sql, conn, tx);

            cmd.Parameters.AddWithValue("proveedor", DbOrNull(edit.Proveedor));
            cmd.Parameters.AddWithValue("cantidad_nominal", nominal is null ? (object)DBNull.Value : nominal.Value);
            cmd.Parameters.AddWithValue("cantidad_actual", actual is null ? (object)DBNull.Value : actual.Value);

            cmd.Parameters.AddWithValue("condicion", string.IsNullOrWhiteSpace(edit.CondicionId) ? (object)DBNull.Value : edit.CondicionId!);
            cmd.Parameters.AddWithValue("fecha_apertura", edit.FechaApertura.HasValue ? edit.FechaApertura.Value.Date : (object)DBNull.Value);
            cmd.Parameters.AddWithValue("fecha_vencimiento", edit.FechaVencimiento.HasValue ? edit.FechaVencimiento.Value.Date : (object)DBNull.Value);

            cmd.Parameters.AddWithValue("area", edit.AreaId!);
            cmd.Parameters.AddWithValue("meson", edit.MesonId!);
            cmd.Parameters.AddWithValue("nivel", ParseIntDb(edit.Nivel));
            cmd.Parameters.AddWithValue("posicion", DbOrNull(edit.Posicion));

            // ✅ NUEVO: altura_cm
            cmd.Parameters.AddWithValue("altura_cm", alturaCm is null ? (object)DBNull.Value : alturaCm.Value);

            cmd.Parameters.AddWithValue("qr", DbOrNull(edit.Qr));
            cmd.Parameters.AddWithValue("observaciones", DbOrNull(edit.Observaciones));
            cmd.Parameters.AddWithValue("imagen", DbOrNull(edit.ImagenUrl));

            cmd.Parameters.AddWithValue("id", edit.ContenedorId);
            cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);

            await cmd.ExecuteNonQueryAsync();
            await tx.CommitAsync();

            msg = "Guardado correctamente.";
            isEditing = false;

            await ReloadAllAsync();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    // ======= eliminar =======
    private async Task DeleteAsync()
    {
        msg = null;
        if (!found) return;

        isSaving = true;
        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            await using var tx = await conn.BeginTransactionAsync();

            const string sql = @"
                DELETE FROM contenedores
                WHERE cont_id = @id
                  AND laboratorio_id = @lab;";

            await using var cmd = new NpgsqlCommand(sql, conn, tx);
            cmd.Parameters.AddWithValue("id", edit.ContenedorId);
            cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);

            var rows = await cmd.ExecuteNonQueryAsync();
            await tx.CommitAsync();

            if (rows == 0)
            {
                msg = "No se pudo eliminar (no existe en el laboratorio actual).";
                confirmDelete = false;
                return;
            }

            Nav.NavigateTo("/inventario-sustancias");
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    // ======= helpers =======
    private static object DbOrNull(string? s) =>
        string.IsNullOrWhiteSpace(s) ? (object)DBNull.Value : s!.Trim();

    private static object ParseIntDb(string? s)
    {
        if (string.IsNullOrWhiteSpace(s)) return DBNull.Value;
        return int.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out var i)
            ? i
            : DBNull.Value;
    }

    private static bool TryParseDecimalOrNull(string? s, out decimal? value, out string? error)
    {
        error = null;
        value = null;

        if (string.IsNullOrWhiteSpace(s))
            return true;

        var x = s.Trim().Replace(",", ".");
        if (!decimal.TryParse(x, NumberStyles.Any, CultureInfo.InvariantCulture, out var d))
        {
            error = "no es número";
            return false;
        }

        value = d;
        return true;
    }

    private static string ResolveImagenUrl(string? url)
    {
        if (string.IsNullOrWhiteSpace(url)) return "";
        if (url.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return url;
        return url.StartsWith("/", StringComparison.OrdinalIgnoreCase) ? url : $"/{url}";
    }

    public void Dispose()
    {
        LaboratorioState.OnChange -= HandleLaboratorioChanged;
    }

    private sealed record SelectOption(string Id, string Label);

    private sealed class ContenedorEdit
    {
        public string ContenedorId { get; set; } = "";
        public string SustanciaId { get; set; } = "";
        public string Reactivo { get; set; } = "";

        // extras vista
        public string Marca { get; set; } = "";
        public string Densidad { get; set; } = "";
        public string Envase { get; set; } = "";
        public string UnidadSimbolo { get; set; } = "";

        public string Proveedor { get; set; } = "";

        public string? CantidadNominal { get; set; }
        public string? CantidadActual { get; set; }
        public string CantidadNominalTexto { get; set; } = "";
        public string CantidadActualTexto { get; set; } = "";

        public string? CondicionId { get; set; }

        public DateTime? FechaCompra { get; set; }
        public DateTime? FechaRecepcion { get; set; }
        public DateTime? FechaApertura { get; set; }
        public DateTime? FechaVencimiento { get; set; }

        public string FechaCompraTexto { get; set; } = "";
        public string FechaRecepcionTexto { get; set; } = "";
        public string FechaAperturaTexto { get; set; } = "";
        public string FechaVencimientoTexto { get; set; } = "";

        public string? AreaId { get; set; }
        public string? MesonId { get; set; }
        public string? Nivel { get; set; }
        public string? Posicion { get; set; }

        // ✅ NUEVO
        public string? AlturaCm { get; set; }

        public string? Qr { get; set; }
        public string? Observaciones { get; set; }
        public string? ImagenUrl { get; set; }
    }
}

<style>
    .page-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
        padding: 1rem;
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.04);
    }

    .header-row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
    }

    .header-actions {
        display: flex;
        gap: .5rem;
        align-items: center;
    }

    .muted {
        color: #64748b;
    }

    .text-xs {
        font-size: .8rem;
    }

    .text-sm {
        font-size: .9rem;
    }

    .error-note {
        color: #b91c1c;
    }

    .empty {
        padding: .85rem 1rem;
        border-radius: 10px;
        background: #fef9c3;
        border: 1px solid #fde68a;
        color: #854d0e;
    }

    .btn {
        border: 1px solid #cbd5e1;
        background: #fff;
        color: #0f172a;
        padding: .5rem .9rem;
        border-radius: .55rem;
        font-weight: 700;
        cursor: pointer;
    }

        .btn.primary {
            background: #2563eb;
            color: #fff;
            border: none;
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.18);
        }

            .btn.primary:hover {
                background: #1d4ed8;
            }

        .btn.danger {
            background: #b91c1c;
            color: #fff;
            border: none;
        }

            .btn.danger:hover {
                background: #991b1b;
            }

    /* ===== Vista bonita ===== */
    .detail-grid {
        display: grid;
        grid-template-columns: minmax(240px, 320px) 1fr;
        gap: 1rem;
        align-items: start;
    }

    @@media (max-width: 900px) {
        .detail-grid {
            grid-template-columns: 1fr;
        }
    }

    .detail-media {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: .75rem;
        background: #fafafa;
    }

    .material-img {
        width: 100%;
        height: 280px;
        object-fit: contain;
        border-radius: 10px;
        background: #fff;
        border: 1px solid #e5e7eb;
    }

    .img-placeholder {
        width: 100%;
        height: 280px;
        border-radius: 10px;
        background: #f1f5f9;
        border: 1px dashed #cbd5e1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-weight: 800;
    }

    .detail-info {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        background: #fff;
    }

    .title-row {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: .75rem;
    }

    .badges {
        display: flex;
        gap: .4rem;
        flex-wrap: wrap;
    }

    .badge {
        background: #dbeafe;
        color: #1d4ed8;
        padding: .2rem .55rem;
        border-radius: 999px;
        font-size: .85rem;
        font-weight: 800;
    }

        .badge.gray {
            background: #e2e8f0;
            color: #0f172a;
        }

    .dl {
        display: grid;
        gap: .6rem;
    }

    .dl-row {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: .75rem;
    }

    @@media (max-width: 900px) {
        .dl-row {
            grid-template-columns: 1fr;
        }
    }

    .dt {
        color: #475569;
        font-weight: 900;
    }

    .dd {
        color: #0f172a;
    }

    .view-actions {
        margin-top: 1rem;
        display: flex;
        gap: .75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Chips */
    .chips-row {
        display: flex;
        gap: .5rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .chip {
        background: #eef2ff;
        border: 1px solid #c7d2fe;
        color: #1e1b4b;
        padding: .25rem .6rem;
        border-radius: 999px;
        font-weight: 900;
        font-size: .85rem;
    }

        .chip.gray {
            background: #e2e8f0;
            border-color: #cbd5e1;
            color: #0f172a;
        }

    /* ===== Form ===== */
    .form-header {
        margin-bottom: .75rem;
    }

        .form-header h4 {
            margin: 0 0 .25rem 0;
            font-weight: 900;
            color: #0f172a;
        }

    .form-hint {
        margin: 0;
        color: #64748b;
        font-size: .95rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: .75rem;
        align-items: start;
    }

    .full-span {
        grid-column: 1 / -1;
    }

    .field label {
        display: block;
        font-size: .85rem;
        color: #475569;
        margin-bottom: .25rem;
        font-weight: 900;
    }

    .border {
        border: 1px solid #e5e7eb;
        border-radius: .5rem;
    }

    .p-1 {
        padding: .45rem .6rem;
    }

    .readonly {
        border: 1px solid #e5e7eb;
        border-radius: .5rem;
        background: #f8fafc;
        padding: .55rem .6rem;
        display: flex;
        gap: .5rem;
        align-items: center;
        flex-wrap: wrap;
        font-weight: 800;
        color: #0f172a;
    }

    .form-actions {
        display: flex;
        gap: .75rem;
        align-items: center;
        flex-wrap: wrap;
        margin-top: .25rem;
    }

    /* Upload + preview */
    .upload-card {
        border: 1px dashed #d1d5db;
        padding: .75rem;
        border-radius: .75rem;
        display: grid;
        gap: .6rem;
        background: #fff;
    }

    .upload-options {
        display: flex;
        gap: .75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .upload-drop {
        position: relative;
        display: flex;
        align-items: center;
        gap: .5rem;
        padding: .6rem;
        border: 1px solid #e5e7eb;
        border-radius: .5rem;
        color: #6b7280;
        cursor: pointer;
    }

        .upload-drop input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

    .preview-row {
        display: flex;
        gap: .5rem;
        align-items: center;
        flex-wrap: wrap;
        margin-top: .25rem;
    }

    .material-img-sm {
        width: 180px;
        height: 120px;
        object-fit: contain;
        border-radius: 10px;
        background: #fff;
        border: 1px solid #e5e7eb;
    }
</style>