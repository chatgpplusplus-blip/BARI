@page "/inventario-equipos/modelo/{Id}"

@using Npgsql
@using System.Globalization
@using System.IO
@using System.Linq
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms

@inject NpgsqlDataSource DataSource
@inject LaboratorioState LaboratorioState
@inject NavigationManager Nav
@inject IWebHostEnvironment HostEnvironment
@implements IDisposable

<PageTitle>@(isLoading ? "Detalle de Modelo de Equipo" : (found ? (edit.NombreModelo ?? "Modelo") : "Modelo"))</PageTitle>

<section class="page-card">
    <div class="header-row">
        <div>
            <h2>Detalle de Modelo de Equipo</h2>
            <div class="muted">ID: <b>@(Id ?? "—")</b></div>
        </div>
        <div class="header-actions">
            <button class="btn" type="button" @onclick="GoBack">Volver</button>
        </div>
    </div>

    @* Aunque el modelo es global, el lab importa para listar INSTANCIAS (equipos) *@
    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.2rem;">
    @if (!string.IsNullOrWhiteSpace(loadError))
    {
        <p class="error-note">Error: @loadError</p>
    }
    else if (isLoading)
    {
        <p><em>Cargando…</em></p>
    }
    else if (!found)
    {
        <div class="empty">
            No se encontró el modelo <b>@(Id ?? "")</b>.
        </div>
    }
    else
    {
        @* ======= VISTA ======= *@
        @if (!isEditing)
        {
            <div class="detail-grid">
                <div class="detail-media">
                    @if (!string.IsNullOrWhiteSpace(edit.ImagenUrl))
                    {
                        <img class="material-img"
                             src="@ResolveUrl(edit.ImagenUrl)"
                             alt="Imagen del modelo"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                        <div class="img-placeholder" style="display:none;">Sin imagen</div>
                    }
                    else
                    {
                        <div class="img-placeholder">Sin imagen</div>
                    }

                    @if (!string.IsNullOrWhiteSpace(edit.ImagenUrl))
                    {
                        <div class="text-xs muted" style="margin-top:.35rem;">
                            <span>Imagen:</span> <code>@edit.ImagenUrl</code>
                        </div>
                    }

                    <div class="chips-row" style="margin-top:.75rem;">
                        <span class="chip"><b>SUB</b> · @edit.SubcategoriaIds.Count</span>
                        <span class="chip"><b>EQUIP</b> · @_equiposDelModelo.Count</span>
                        @if (edit.EsCalibrable)
                        {
                            <span class="chip warn">Calibrable</span>
                        }
                    </div>
                </div>

                <div class="detail-info">
                    <div class="title-row">
                        <h3 style="margin:0;">@NullDash(edit.NombreModelo)</h3>

                        <div class="badges">
                            <span class="badge gray">@NullDash(edit.MarcaNombre)</span>
                            <span class="badge">@NullDash(edit.CategoriaNombre)</span>
                            <span class="badge gray">@NullDash(SubcategoriasLabel)</span>
                            @if (edit.EsCalibrable)
                            {
                                <span class="badge gray">Calibrable</span>
                            }
                        </div>
                    </div>

                    <div class="dl">
                        <div class="dl-row">
                            <div class="dt">Marca</div>
                            <div class="dd">@NullDash(edit.MarcaNombre)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Categoría</div>
                            <div class="dd">@NullDash(edit.CategoriaNombre)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Altura (cm)</div>
                            <div class="dd">@AlturaCmLabel</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Manual</div>
                            <div class="dd">
                                @if (string.IsNullOrWhiteSpace(edit.ManualUrl))
                                {
                                    <span class="muted">—</span>
                                }
                                else
                                {
                                    <div style="display:flex; gap:.6rem; flex-wrap:wrap; align-items:center;">
                                        <NavLink class="btn-link" href="@($"{RutaDocumentoDetalle}{Uri.EscapeDataString(edit.ManualUrl)}")">
                                            @ManualDocLabel
                                        </NavLink>

                                        @if (!string.IsNullOrWhiteSpace(ManualOpenHref))
                                        {
                                            <a class="btn-link"
                                               href="@ManualOpenHref"
                                               target="_blank"
                                               rel="noopener noreferrer">Abrir contenido</a>
                                        }
                                    </div>

                                    <div class="text-xs muted" style="margin-top:.25rem;">
                                        Doc ID: <code>@edit.ManualUrl</code>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Notas</div>
                            <div class="dd">@NullDash(edit.Notas)</div>
                        </div>

                        <div class="dl-row">
                            <div class="dt">Descripción</div>
                            <div class="dd">@NullDash(edit.Descripcion)</div>
                        </div>
                    </div>

                    <div class="view-actions">
                        <button class="btn primary" type="button" @onclick="StartEdit">Editar</button>

                        @if (!confirmDelete)
                        {
                            <button class="btn danger" type="button" @onclick="AskDelete">Eliminar</button>
                        }
                        else
                        {
                            <button class="btn danger" type="button" @onclick="DeleteAsync" disabled="@isSaving">Confirmar eliminar</button>
                            <button class="btn" type="button" @onclick="CancelDelete" disabled="@isSaving">Cancelar</button>
                        }

                        @if (!string.IsNullOrWhiteSpace(msg))
                        {
                            <span class="text-sm muted">@msg</span>
                        }
                    </div>
                </div>
            </div>

            @* ===== Equipos físicos (instancias) en el laboratorio actual ===== *@
            <div class="notes" style="margin-top:1rem;">
                <strong>Equipos (instancias físicas) en el laboratorio actual</strong>
                <div class="muted">@_equiposDelModelo.Count equipo(s) registrados para este modelo en el laboratorio.</div>

                @if (_equiposDelModelo.Count == 0)
                {
                    <div class="muted" style="margin-top:.35rem;">No hay equipos en este laboratorio usando este modelo.</div>
                }
                else
                {
                    <div class="table-wrap" style="margin-top:.5rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Serie</th>
                                    <th>Estado</th>
                                    <th>Ubicación</th>
                                    <th>Calibración</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var e in _equiposDelModelo)
                                {
                                    <tr>
                                        <td>
                                            <NavLink href="@($"{RutaEquipoDetalle}{Uri.EscapeDataString(e.EquipoId)}")">
                                                @e.EquipoId
                                            </NavLink>
                                        </td>
                                        <td>@e.Nombre</td>
                                        <td>@e.Serie</td>
                                        <td>@e.Estado</td>
                                        <td>@e.Ubicacion</td>
                                        <td>@e.RequiereCalibracion</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }
        else
        {
            @* ======= EDICIÓN ======= *@
            <div class="form-header">
                <h4>Editar modelo de equipo</h4>
                <p class="form-hint">
                    Ajusta datos del modelo y sus subcategorías (M:N). El laboratorio actual solo afecta al listado de instancias.
                </p>
            </div>

            <div class="form-grid">
                <div class="field">
                    <label>Nombre del modelo</label>
                    <input class="border p-1" placeholder="Nombre del modelo" @bind="edit.NombreModelo" />
                </div>

                <div class="field">
                    <label>Marca</label>
                    <select class="border p-1" @bind="edit.MarcaId">
                        <option value="">(sin marca)</option>
                        @foreach (var m in _marcaOptions.OrderBy(x => x.Label))
                        {
                            <option value="@m.Id">@m.Label</option>
                        }
                    </select>
                </div>

                <div class="field">
                    <label>Categoría</label>
                    <select class="border p-1" value="@edit.CategoriaId" @onchange="OnCategoriaChanged">
                        <option value="">(selecciona categoría…)</option>
                        @foreach (var c in _categoriaOptions.OrderBy(x => x.Label))
                        {
                            <option value="@c.Id">@c.Label</option>
                        }
                    </select>
                    <div class="text-xs muted" style="margin-top:.25rem;">
                        Define qué subcategorías son válidas. En <code>equipo-mixto</code> puedes elegir subcats de medición y operación.
                    </div>
                </div>

                <div class="field">
                    <label>Altura (cm)</label>
                    <input class="border p-1" type="number" step="any" placeholder="Altura en cm (opcional)" @bind="edit.AlturaCm" />
                    <div class="text-xs muted" style="margin-top:.25rem;">
                        Se guarda en <code>modelos_equipo.altura_cm</code>.
                    </div>
                </div>

                <div class="field">
                    <label>&nbsp;</label>
                    <div class="edit-check">
                        <input type="checkbox" @bind="edit.EsCalibrable" />
                        <span>Es calibrable</span>
                    </div>
                </div>

                <div class="field full-span">
                    <label>Subcategorías (M:N)</label>

                    <div class="subcats-dropdown">
                        <button type="button"
                                class="border p-1 subcats-btn"
                                @onclick="ToggleSubcatsDropdown">
                            @SelectedSubcategoriasLabel
                        </button>

                        @if (_showSubcatsDropdown)
                        {
                            <div class="subcats-panel">
                                <div class="text-xs muted" style="margin-bottom:.35rem;">
                                    Selecciona una o más subcategorías válidas según la categoría.
                                </div>

                                @foreach (var s in GetSubcatsFiltradas().OrderBy(x => x.Label))
                                {
                                    <label class="subcats-item">
                                        <input type="checkbox"
                                               checked="@edit.SubcategoriaIds.Contains(s.Id)"
                                               @onchange="(e) => OnSubcategoriaToggle(s.Id, e)" />
                                        <span>@s.Label</span>
                                        <span class="text-xs muted" style="margin-left:.35rem;">(@s.CategoriaId)</span>
                                    </label>
                                }
                            </div>
                        }
                    </div>

                    <div class="text-xs muted" style="margin-top:.25rem;">
                        Guardará en <code>modelo_equipo_subcategorias</code>.
                    </div>
                </div>

                @* ✅ Manual ahora es Documento *@
                <div class="field full-span">
                    <label>Manual (Documento · alcance EQUIPO)</label>

                    <select class="border p-1" @bind="edit.ManualUrl">
                        <option value="">(sin manual)</option>
                        @foreach (var d in _manualDocs)
                        {
                            var tag = d.LaboratorioContextoId is null ? "GLOBAL" : "LAB";
                            <option value="@d.Id">@d.Titulo · @tag</option>
                        }
                    </select>

                    <div class="text-xs muted" style="margin-top:.25rem;">
                        Solo aparecen documentos con <code>alcance='EQUIPO'</code> y <code>modelo_equipo_id = @edit.ModeloId</code>.
                    </div>

                    <div style="margin-top:.45rem; display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
                        <select class="border p-1" style="max-width:320px;"
                                @onchange="OnManualActionChanged"
                                disabled="@string.IsNullOrWhiteSpace(edit.ManualUrl)">
                            <option value="">Acciones…</option>
                            <option value="doc">Ir al documento</option>
                            <option value="content">Abrir contenido (URL/archivo)</option>
                            <option value="docs">Ir a Documentaciones</option>
                        </select>

                        @if (string.IsNullOrWhiteSpace(edit.ManualUrl))
                        {
                            <span class="text-xs muted">Selecciona un documento para habilitar acciones.</span>
                        }
                    </div>
                </div>

                <div class="field full-span">
                    <label>Notas</label>
                    <textarea class="border p-1" rows="3" placeholder="Notas" @bind="edit.Notas"></textarea>
                </div>

                <div class="field full-span">
                    <label>Descripción</label>
                    <textarea class="border p-1" rows="3" placeholder="Descripción" @bind="edit.Descripcion"></textarea>
                </div>

                @* ===== Imagen ===== *@
                <div class="upload-card full-span">
                    <div class="upload-options">
                        <label class="text-sm">
                            <input type="radio" name="imagenModoModelo"
                                   value="url"
                                   checked="@(_imagenModo == "url")"
                                   @onchange="OnImagenModoChanged" />
                            Colocar un URL
                        </label>
                        <label class="text-sm">
                            <input type="radio" name="imagenModoModelo"
                                   value="archivo"
                                   checked="@(_imagenModo == "archivo")"
                                   @onchange="OnImagenModoChanged" />
                            Subir archivo
                        </label>
                    </div>

                    @if (_imagenModo == "url")
                    {
                        <input class="border p-1" placeholder="Imagen URL (o ruta relativa)" @bind="edit.ImagenUrl" />
                    }
                    else
                    {
                        <label class="upload-drop">
                            <InputFile OnChange="OnImagenArchivoSeleccionado" accept="image/png,image/jpeg,image/jpg,image/webp" />
                            <span>Arrastra una imagen o haz clic para buscar</span>
                        </label>

                        @if (!string.IsNullOrWhiteSpace(_imagenArchivoNombre))
                        {
                            <div class="text-xs muted">Archivo: @_imagenArchivoNombre</div>
                        }
                    }

                    @if (!string.IsNullOrWhiteSpace(edit.ImagenUrl))
                    {
                        <div class="preview-row">
                            <div class="text-xs muted">Preview:</div>
                            <img class="material-img-sm"
                                 src="@ResolveUrl(edit.ImagenUrl)"
                                 alt="Preview"
                                 onerror="this.style.display='none';" />
                            <div class="text-xs muted">Guardará: <code>@edit.ImagenUrl</code></div>
                        </div>
                    }
                </div>

                <div class="form-actions full-span">
                    <button class="btn primary" type="button" @onclick="SaveAsync" disabled="@isSaving">Guardar cambios</button>
                    <button class="btn" type="button" @onclick="CancelEdit" disabled="@isSaving">Cancelar</button>

                    @if (!confirmDelete)
                    {
                        <button class="btn danger" type="button" @onclick="AskDelete" disabled="@isSaving">Eliminar</button>
                    }
                    else
                    {
                        <button class="btn danger" type="button" @onclick="DeleteAsync" disabled="@isSaving">Confirmar eliminar</button>
                        <button class="btn" type="button" @onclick="CancelDelete" disabled="@isSaving">Cancelar eliminar</button>
                    }

                    @if (!string.IsNullOrWhiteSpace(msg))
                    {
                        <span class="text-sm muted">@msg</span>
                    }
                </div>
            </div>
        }
    }
</section>

@code {
    [Parameter] public string? Id { get; set; }

    // ✅ Ajusta rutas si tu app usa otras
    private const string RutaDocumentoDetalle = "/documentacion/item/";
    private const string RutaDocumentaciones = "/documentaciones/todos";
    private const string RutaEquipoDetalle = "/inventario-equipo/item/";

    // Categorías válidas para modelos de equipo
    private static readonly HashSet<string> CategoriaEquipoIds = new(StringComparer.OrdinalIgnoreCase)
    {
        "equipo-medicion",
        "equipo-operacion",
        "equipo-mixto",
    };

    private bool isLoading = true;
    private bool isSaving = false;
    private bool found = false;

    private bool isEditing = false;
    private bool confirmDelete = false;

    private string? loadError;
    private string? msg;

    private ModeloEquipoEdit edit = new();

    // Imagen
    private string _imagenModo = "url";
    private string? _imagenArchivoNombre;

    // Lookups
    private readonly List<SelectOption> _marcaOptions = new();
    private readonly List<SelectOption> _categoriaOptions = new();
    private readonly List<SubcatOption> _subcategoriaOptions = new();

    // ✅ Docs manuales
    private readonly List<ManualDocOption> _manualDocs = new();
    private readonly Dictionary<string, ManualDocOption> _manualDocById = new(StringComparer.OrdinalIgnoreCase);

    // Equipos físicos (instancias) del modelo en el lab actual
    private readonly List<EquipoInstanciaInfo> _equiposDelModelo = new();

    // UI subcats
    private bool _showSubcatsDropdown;

    private void ToggleSubcatsDropdown() => _showSubcatsDropdown = !_showSubcatsDropdown;

    private string SelectedSubcategoriasLabel
    {
        get
        {
            if (edit.SubcategoriaIds.Count == 0)
                return "Subcategorías (selecciona al menos 1)";

            var labels = _subcategoriaOptions
                .Where(s => edit.SubcategoriaIds.Contains(s.Id))
                .Select(s => s.Label)
                .ToList();

            return labels.Count == 0 ? "Subcategorías (selecciona al menos 1)" : string.Join(", ", labels);
        }
    }

    private string SubcategoriasLabel
    {
        get
        {
            if (edit.SubcategoriaIds.Count == 0) return "—";

            var labels = _subcategoriaOptions
                .Where(s => edit.SubcategoriaIds.Contains(s.Id))
                .Select(s => s.Label)
                .ToList();

            return labels.Count > 0 ? string.Join(", ", labels) : string.Join(", ", edit.SubcategoriaIds);
        }
    }

    private string AlturaCmLabel =>
        string.IsNullOrWhiteSpace(edit.AlturaCm) ? "—" : $"{edit.AlturaCm.Trim()} cm";

    private void OnSubcategoriaToggle(string subcatId, ChangeEventArgs args)
    {
        var isChecked = args.Value switch
        {
            bool b => b,
            string s => s.Equals("true", StringComparison.OrdinalIgnoreCase) || s.Equals("on", StringComparison.OrdinalIgnoreCase),
            _ => false
        };

        if (isChecked) edit.SubcategoriaIds.Add(subcatId);
        else edit.SubcategoriaIds.Remove(subcatId);
    }

    // ===== Manual label/open =====
    private string ManualDocLabel
    {
        get
        {
            if (string.IsNullOrWhiteSpace(edit.ManualUrl)) return "—";
            return _manualDocById.TryGetValue(edit.ManualUrl, out var d) ? d.Titulo : edit.ManualUrl;
        }
    }

    private string? ManualOpenHref
    {
        get
        {
            if (string.IsNullOrWhiteSpace(edit.ManualUrl)) return null;

            if (_manualDocById.TryGetValue(edit.ManualUrl, out var d))
            {
                if (!string.IsNullOrWhiteSpace(d.Url)) return d.Url;
                if (!string.IsNullOrWhiteSpace(d.ArchivoLocal)) return ResolveUrl(d.ArchivoLocal);
            }
            return null;
        }
    }

    private void OnManualActionChanged(ChangeEventArgs e)
    {
        var action = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(action)) return;
        if (string.IsNullOrWhiteSpace(edit.ManualUrl)) return;

        if (action == "doc")
        {
            Nav.NavigateTo($"{RutaDocumentoDetalle}{Uri.EscapeDataString(edit.ManualUrl)}");
        }
        else if (action == "content")
        {
            var href = ManualOpenHref;
            if (!string.IsNullOrWhiteSpace(href))
                Nav.NavigateTo(href, forceLoad: true);
        }
        else if (action == "docs")
        {
            Nav.NavigateTo(RutaDocumentaciones);
        }
    }

    protected override void OnInitialized()
    {
        LaboratorioState.OnChange += HandleLaboratorioChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await ReloadAllAsync();
    }

    private void HandleLaboratorioChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await ReloadAllAsync();
            StateHasChanged();
        });
    }

    private async Task ReloadAllAsync()
    {
        loadError = null;
        msg = null;
        confirmDelete = false;

        isLoading = true;
        isSaving = false;
        found = false;
        isEditing = false;

        _showSubcatsDropdown = false;

        _marcaOptions.Clear();
        _categoriaOptions.Clear();
        _subcategoriaOptions.Clear();
        _equiposDelModelo.Clear();

        _manualDocs.Clear();
        _manualDocById.Clear();

        edit = new ModeloEquipoEdit();

        try
        {
            var id = (Id ?? "").Trim();
            if (string.IsNullOrWhiteSpace(id))
            {
                found = false;
                return;
            }

            await using var conn = await DataSource.OpenConnectionAsync();

            await LoadLookupsAsync(conn);
            await LoadModeloAsync(conn, id);

            if (!found) return;

            await LoadModeloSubcategoriasAsync(conn, edit.ModeloId);
            await LoadEquiposDelModeloAsync(conn, edit.ModeloId);

            // ✅ docs manuales del modelo
            await LoadManualDocsAsync(conn, edit.ModeloId);

            _imagenModo = "url";
            _imagenArchivoNombre = null;
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack() => Nav.NavigateTo("/inventario-equipo");

    private void StartEdit()
    {
        msg = null;
        confirmDelete = false;
        _showSubcatsDropdown = false;
        isEditing = true;
    }

    private async Task CancelEdit()
    {
        msg = null;
        confirmDelete = false;
        isEditing = false;
        await ReloadAllAsync();
    }

    private void AskDelete()
    {
        confirmDelete = true;
        msg = "Esto eliminará el modelo. No se puede eliminar si existen equipos (instancias) usando este modelo.";
    }

    private void CancelDelete()
    {
        confirmDelete = false;
        msg = null;
    }

    private async Task LoadLookupsAsync(NpgsqlConnection conn)
    {
        // Marcas
        await using (var cmd = new NpgsqlCommand(@"
            SELECT marca_id, nombre
            FROM marcas
            ORDER BY nombre;", conn))
        await using (var r = await cmd.ExecuteReaderAsync())
        {
            while (await r.ReadAsync())
                _marcaOptions.Add(new SelectOption(r.GetString(0), r.GetString(1)));
        }

        // Categorías de equipo (solo las 3)
        await using (var cmd = new NpgsqlCommand(@"
            SELECT categoria_id, nombre
            FROM categorias
            WHERE categoria_id = ANY(@ids::text[])
            ORDER BY nombre;", conn))
        {
            cmd.Parameters.AddWithValue("ids", CategoriaEquipoIds.ToArray());
            await using var r = await cmd.ExecuteReaderAsync();
            while (await r.ReadAsync())
                _categoriaOptions.Add(new SelectOption(r.GetString(0), r.GetString(1)));
        }

        // Subcategorías de equipo (cargamos todas las de esas categorías para filtrar en UI)
        await using (var cmd = new NpgsqlCommand(@"
            SELECT subcategoria_id, categoria_id, nombre
            FROM subcategorias
            WHERE categoria_id = ANY(@ids::text[])
            ORDER BY categoria_id, nombre;", conn))
        {
            cmd.Parameters.AddWithValue("ids", CategoriaEquipoIds.ToArray());
            await using var r = await cmd.ExecuteReaderAsync();
            while (await r.ReadAsync())
            {
                _subcategoriaOptions.Add(new SubcatOption(
                    r.GetString(0),
                    r.GetString(1),
                    r.GetString(2)
                ));
            }
        }
    }

    private async Task LoadModeloAsync(NpgsqlConnection conn, string modeloId)
    {
        const string sql = @"
            SELECT me.modelo_id,
                   me.nombre_modelo,
                   COALESCE(me.es_calibrable, false) AS es_calibrable,
                   me.manual_url,
                   me.notas,
                   me.descripcion,
                   me.imagen_url,
                   me.altura_cm,
                   COALESCE(ma.marca_id,'') AS marca_id,
                   COALESCE(ma.nombre,'')   AS marca_nombre,
                   COALESCE(c.categoria_id,'') AS categoria_id,
                   COALESCE(c.nombre,'')       AS categoria_nombre
            FROM modelos_equipo me
            LEFT JOIN marcas ma ON ma.marca_id = me.marca_id
            LEFT JOIN categorias c ON c.categoria_id = me.categoria_id
            WHERE me.modelo_id = @id
            LIMIT 1;
        ";

        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("id", modeloId);

        await using var r = await cmd.ExecuteReaderAsync();
        if (!await r.ReadAsync())
        {
            found = false;
            return;
        }

        found = true;

        edit = new ModeloEquipoEdit
            {
                ModeloId = r.GetString(0),
                NombreModelo = r.IsDBNull(1) ? "" : r.GetString(1),
                EsCalibrable = !r.IsDBNull(2) && r.GetBoolean(2),
                ManualUrl = r.IsDBNull(3) ? "" : r.GetString(3), // ✅ documento_id
                Notas = r.IsDBNull(4) ? "" : r.GetString(4),
                Descripcion = r.IsDBNull(5) ? "" : r.GetString(5),
                ImagenUrl = r.IsDBNull(6) ? "" : r.GetString(6),

            // ✅ NUEVO: altura_cm
                AlturaCm = r.IsDBNull(7) ? "" : r.GetDecimal(7).ToString(CultureInfo.InvariantCulture),

                MarcaId = r.IsDBNull(8) ? "" : r.GetString(8),
                MarcaNombre = r.IsDBNull(9) ? "" : r.GetString(9),
                CategoriaId = r.IsDBNull(10) ? "" : r.GetString(10),
                CategoriaNombre = r.IsDBNull(11) ? "" : r.GetString(11),
            };
    }

    private async Task LoadModeloSubcategoriasAsync(NpgsqlConnection conn, string modeloId)
    {
        edit.SubcategoriaIds.Clear();

        const string sql = @"
            SELECT sc.subcategoria_id
            FROM modelo_equipo_subcategorias ms
            INNER JOIN subcategorias sc ON sc.subcategoria_id = ms.subcategoria_id
            WHERE ms.modelo_id = @id
            ORDER BY sc.nombre;
        ";

        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("id", modeloId);

        await using var r = await cmd.ExecuteReaderAsync();
        while (await r.ReadAsync())
            edit.SubcategoriaIds.Add(r.GetString(0));
    }

    private async Task LoadEquiposDelModeloAsync(NpgsqlConnection conn, string modeloId)
    {
        _equiposDelModelo.Clear();

        const string sql = @"
            SELECT e.equipo_id,
                   COALESCE(e.nombre,'') AS nombre,
                   COALESCE(e.serie,'') AS serie,
                   COALESCE(est.nombre,'') AS estado,
                   COALESCE(a.nombre_areas,'') AS area,
                   COALESCE(m.nombre_meson,'') AS meson,
                   COALESCE(e.posicion,'') AS posicion,
                   COALESCE(e.requiere_calibracion,false) AS requiere_calibracion
            FROM equipos e
            LEFT JOIN estados_activo est ON est.estado_id = e.estado_id
            LEFT JOIN areas a ON a.area_id = e.area_id
            LEFT JOIN mesones m ON m.meson_id = e.meson_id
            WHERE e.modelo_id = @mid
              AND e.laboratorio_id = @lab
            ORDER BY e.equipo_id;
        ";

        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("mid", modeloId);
        cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);

        await using var r = await cmd.ExecuteReaderAsync();
        while (await r.ReadAsync())
        {
            var area = r.IsDBNull(4) ? "" : r.GetString(4);
            var meson = r.IsDBNull(5) ? "" : r.GetString(5);
            var pos = r.IsDBNull(6) ? "" : r.GetString(6);

            _equiposDelModelo.Add(new EquipoInstanciaInfo
                {
                    EquipoId = r.GetString(0),
                    Nombre = r.IsDBNull(1) ? "—" : r.GetString(1),
                    Serie = string.IsNullOrWhiteSpace(r.GetString(2)) ? "—" : r.GetString(2),
                    Estado = string.IsNullOrWhiteSpace(r.GetString(3)) ? "—" : r.GetString(3),
                    Ubicacion = BuildUbicacion(area, meson, pos),
                    RequiereCalibracion = (!r.IsDBNull(7) && r.GetBoolean(7)) ? "Sí" : "No"
                });
        }
    }

    private async Task LoadManualDocsAsync(NpgsqlConnection conn, string modeloId)
    {
        _manualDocs.Clear();
        _manualDocById.Clear();

        const string sql = @"
            SELECT d.documento_id,
                   COALESCE(NULLIF(d.titulo,''), d.documento_id) AS titulo,
                   d.url,
                   d.archivo_local,
                   d.laboratorio_contexto_id
            FROM documentos d
            WHERE d.alcance = 'EQUIPO'
              AND d.modelo_equipo_id = @mid
              AND (d.laboratorio_contexto_id = @lab OR d.laboratorio_contexto_id IS NULL)
            ORDER BY titulo, d.documento_id;";

        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("mid", modeloId);
        cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);

        await using var r = await cmd.ExecuteReaderAsync();
        while (await r.ReadAsync())
        {
            var id = r.GetString(0);
            var titulo = r.GetString(1);
            var url = r.IsDBNull(2) ? null : r.GetString(2);
            var archivo = r.IsDBNull(3) ? null : r.GetString(3);
            var ctx = r.IsDBNull(4) ? (int?)null : r.GetInt32(4);

            var item = new ManualDocOption(id, titulo, url, archivo, ctx);
            _manualDocs.Add(item);
            _manualDocById[id] = item;
        }
    }

    private void OnCategoriaChanged(ChangeEventArgs args)
    {
        var value = args.Value?.ToString() ?? "";
        edit.CategoriaId = value;

        // Prune: si cambias categoría, removemos subcats que ya no sean válidas
        var allowed = GetAllowedSubcatIdsForCategoria(edit.CategoriaId);
        edit.SubcategoriaIds.RemoveWhere(id => !allowed.Contains(id));

        _showSubcatsDropdown = false;
        msg = null;
    }

    private IEnumerable<SubcatOption> GetSubcatsFiltradas()
    {
        var allowedCats = GetAllowedCategoriaIdsForSubcats(edit.CategoriaId);
        return _subcategoriaOptions.Where(s => allowedCats.Contains(s.CategoriaId));
    }

    private HashSet<string> GetAllowedSubcatIdsForCategoria(string? categoriaId)
    {
        var allowedCats = GetAllowedCategoriaIdsForSubcats(categoriaId);
        return new HashSet<string>(
            _subcategoriaOptions.Where(s => allowedCats.Contains(s.CategoriaId)).Select(s => s.Id),
            StringComparer.OrdinalIgnoreCase
        );
    }

    private static HashSet<string> GetAllowedCategoriaIdsForSubcats(string? categoriaId)
    {
        categoriaId ??= "";

        if (categoriaId.Equals("equipo-medicion", StringComparison.OrdinalIgnoreCase))
            return new HashSet<string>(StringComparer.OrdinalIgnoreCase) { "equipo-medicion", "equipo-mixto" };

        if (categoriaId.Equals("equipo-operacion", StringComparison.OrdinalIgnoreCase))
            return new HashSet<string>(StringComparer.OrdinalIgnoreCase) { "equipo-operacion", "equipo-mixto" };

        if (categoriaId.Equals("equipo-mixto", StringComparison.OrdinalIgnoreCase))
            return new HashSet<string>(StringComparer.OrdinalIgnoreCase) { "equipo-medicion", "equipo-operacion", "equipo-mixto" };

        return new HashSet<string>(StringComparer.OrdinalIgnoreCase) { "equipo-medicion", "equipo-operacion", "equipo-mixto" };
    }

    private void OnImagenModoChanged(ChangeEventArgs args)
    {
        var value = args.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(value))
            _imagenModo = value;
    }

    private async Task OnImagenArchivoSeleccionado(InputFileChangeEventArgs args)
    {
        if (args.FileCount == 0) return;

        var file = args.File;
        var extension = Path.GetExtension(file.Name);
        var fileName = $"modelo_equipo_{Guid.NewGuid():N}{extension}";
        var relativePath = Path.Combine("uploads", "modelos_equipo", fileName).Replace("\\", "/");
        var absolutePath = Path.Combine(HostEnvironment.WebRootPath, relativePath);
        Directory.CreateDirectory(Path.GetDirectoryName(absolutePath)!);

        await using var stream = file.OpenReadStream(5 * 1024 * 1024);
        await using var fs = File.Create(absolutePath);
        await stream.CopyToAsync(fs);

        edit.ImagenUrl = $"/{relativePath}";
        _imagenArchivoNombre = file.Name;
        msg = $"Imagen cargada: {file.Name}";
    }

    private static bool TryParseDecimalFlexible(string? input, out decimal value)
    {
        value = 0m;
        if (string.IsNullOrWhiteSpace(input)) return false;

        var s = input.Trim();

        if (decimal.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out value))
            return true;

        if (decimal.TryParse(s, NumberStyles.Any, CultureInfo.CurrentCulture, out value))
            return true;

        s = s.Replace(',', '.');
        return decimal.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out value);
    }

    private async Task SaveAsync()
    {
        msg = null;
        confirmDelete = false;

        if (!found)
        {
            msg = "No hay modelo cargado.";
            return;
        }

        if (string.IsNullOrWhiteSpace(edit.NombreModelo))
        {
            msg = "Ingresa el nombre del modelo.";
            return;
        }

        if (string.IsNullOrWhiteSpace(edit.CategoriaId) || !CategoriaEquipoIds.Contains(edit.CategoriaId))
        {
            msg = "Selecciona una categoría válida (equipo-medicion / equipo-operacion / equipo-mixto).";
            return;
        }

        // ✅ Parse altura_cm (opcional)
        decimal? alturaCm = null;
        if (!string.IsNullOrWhiteSpace(edit.AlturaCm))
        {
            if (!TryParseDecimalFlexible(edit.AlturaCm, out var alt))
            {
                msg = "Altura (cm) inválida.";
                return;
            }
            if (alt < 0)
            {
                msg = "Altura (cm) no puede ser negativa.";
                return;
            }
            alturaCm = alt;
        }

        var selectedSubcats = edit.SubcategoriaIds
            .Where(x => !string.IsNullOrWhiteSpace(x))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToList();

        if (selectedSubcats.Count == 0)
        {
            msg = "Selecciona al menos una subcategoría.";
            return;
        }

        var allowedSubcatIds = GetAllowedSubcatIdsForCategoria(edit.CategoriaId);
        if (selectedSubcats.Any(id => !allowedSubcatIds.Contains(id)))
        {
            msg = "Hay subcategorías inválidas para la categoría seleccionada.";
            return;
        }

        isSaving = true;

        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            await using var tx = await conn.BeginTransactionAsync();

            // Blindaje subcats
            var allowedCats = GetAllowedCategoriaIdsForSubcats(edit.CategoriaId).ToArray();

            const string checkSubs = @"
                SELECT COUNT(*)
                FROM subcategorias
                WHERE subcategoria_id = ANY(@subs::text[])
                  AND categoria_id = ANY(@allowed_cats::text[]);
            ";

            await using (var chk = new NpgsqlCommand(checkSubs, conn, tx))
            {
                chk.Parameters.AddWithValue("subs", selectedSubcats.ToArray());
                chk.Parameters.AddWithValue("allowed_cats", allowedCats);

                var countOk = Convert.ToInt64(await chk.ExecuteScalarAsync());
                if (countOk != selectedSubcats.Count)
                {
                    msg = "Una o más subcategorías no existen o no son válidas para la categoría seleccionada.";
                    await tx.RollbackAsync();
                    return;
                }
            }

            // ✅ Validar manual (si se eligió): doc debe ser alcance EQUIPO y del mismo modelo (y contexto lab o global)
            if (!string.IsNullOrWhiteSpace(edit.ManualUrl))
            {
                const string chkManual = @"
                    SELECT COUNT(*)
                    FROM documentos
                    WHERE documento_id = @doc
                      AND alcance = 'EQUIPO'
                      AND modelo_equipo_id = @mid
                      AND (laboratorio_contexto_id = @lab OR laboratorio_contexto_id IS NULL);";

                await using var chk = new NpgsqlCommand(chkManual, conn, tx);
                chk.Parameters.AddWithValue("doc", edit.ManualUrl.Trim());
                chk.Parameters.AddWithValue("mid", edit.ModeloId);
                chk.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);

                var ok = Convert.ToInt64(await chk.ExecuteScalarAsync()) == 1;
                if (!ok)
                {
                    msg = "Manual inválido: el documento debe ser alcance EQUIPO y pertenecer a este modelo.";
                    await tx.RollbackAsync();
                    return;
                }
            }

            // 1) UPDATE modelos_equipo (✅ incluye altura_cm)
            const string up = @"
                UPDATE modelos_equipo
                SET marca_id      = @marca_id,
                    categoria_id  = @categoria_id,
                    nombre_modelo = @nombre_modelo,
                    es_calibrable = @es_calibrable,
                    manual_url    = @manual_url,
                    notas         = @notas,
                    descripcion   = @descripcion,
                    imagen_url    = @imagen_url,
                    altura_cm     = @altura_cm
                WHERE modelo_id   = @id;
            ";

            await using (var cmd = new NpgsqlCommand(up, conn, tx))
            {
                cmd.Parameters.AddWithValue("marca_id", DbOrNull(edit.MarcaId));
                cmd.Parameters.AddWithValue("categoria_id", DbOrNull(edit.CategoriaId));
                cmd.Parameters.AddWithValue("nombre_modelo", edit.NombreModelo.Trim());
                cmd.Parameters.AddWithValue("es_calibrable", edit.EsCalibrable);
                cmd.Parameters.AddWithValue("manual_url", DbOrNull(edit.ManualUrl)); // ✅ doc_id o NULL
                cmd.Parameters.AddWithValue("notas", DbOrNull(edit.Notas));
                cmd.Parameters.AddWithValue("descripcion", DbOrNull(edit.Descripcion));
                cmd.Parameters.AddWithValue("imagen_url", DbOrNull(edit.ImagenUrl));
                cmd.Parameters.AddWithValue("altura_cm", alturaCm.HasValue ? alturaCm.Value : (object)DBNull.Value);
                cmd.Parameters.AddWithValue("id", edit.ModeloId);

                await cmd.ExecuteNonQueryAsync();
            }

            // 2) Sync subcategorías (M:N)
            await ExecAsync(conn, tx, "DELETE FROM modelo_equipo_subcategorias WHERE modelo_id = @id", ("id", edit.ModeloId));

            const string insSubs = @"
                INSERT INTO modelo_equipo_subcategorias (modelo_id, subcategoria_id)
                SELECT @mid, s
                FROM unnest(@subs::text[]) AS s
                ON CONFLICT DO NOTHING;
            ";

            await using (var cmdSubs = new NpgsqlCommand(insSubs, conn, tx))
            {
                cmdSubs.Parameters.AddWithValue("mid", edit.ModeloId);
                cmdSubs.Parameters.AddWithValue("subs", selectedSubcats.ToArray());
                await cmdSubs.ExecuteNonQueryAsync();
            }

            await tx.CommitAsync();

            msg = "Guardado correctamente.";
            isEditing = false;
            await ReloadAllAsync();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task DeleteAsync()
    {
        msg = null;
        if (!found) return;

        isSaving = true;

        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            await using var tx = await conn.BeginTransactionAsync();

            // Blindaje: no borrar si hay equipos usando este modelo (en cualquier laboratorio)
            var equiposCount = await ScalarCountAsync(conn, tx,
                "SELECT COUNT(*) FROM equipos WHERE modelo_id=@id",
                ("id", edit.ModeloId));

            if (equiposCount > 0)
            {
                msg = $"No se puede eliminar: hay {equiposCount} equipo(s) usando este modelo (en uno o más laboratorios).";
                confirmDelete = false;
                await tx.RollbackAsync();
                return;
            }

            await ExecAsync(conn, tx, "DELETE FROM modelo_equipo_subcategorias WHERE modelo_id=@id", ("id", edit.ModeloId));

            var rows = await ExecAsync(conn, tx,
                "DELETE FROM modelos_equipo WHERE modelo_id=@id",
                ("id", edit.ModeloId));

            await tx.CommitAsync();

            if (rows == 0)
            {
                msg = "No se pudo eliminar (no existe).";
                confirmDelete = false;
                return;
            }

            Nav.NavigateTo("/inventario-equipo");
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private static async Task<long> ScalarCountAsync(NpgsqlConnection conn, NpgsqlTransaction tx, string sql, params (string name, object value)[] ps)
    {
        await using var cmd = new NpgsqlCommand(sql, conn, tx);
        foreach (var (n, v) in ps)
            cmd.Parameters.AddWithValue(n, v ?? DBNull.Value);
        var result = await cmd.ExecuteScalarAsync();
        return Convert.ToInt64(result);
    }

    private static async Task<int> ExecAsync(NpgsqlConnection conn, NpgsqlTransaction tx, string sql, params (string name, object value)[] ps)
    {
        await using var cmd = new NpgsqlCommand(sql, conn, tx) { CommandTimeout = 60 };
        foreach (var (n, v) in ps)
            cmd.Parameters.AddWithValue(n, v ?? DBNull.Value);
        return await cmd.ExecuteNonQueryAsync();
    }

    private static object DbOrNull(string? s) =>
        string.IsNullOrWhiteSpace(s) ? (object)DBNull.Value : s!.Trim();

    private static string BuildUbicacion(string area, string meson, string posicion)
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(area)) parts.Add(area);
        if (!string.IsNullOrWhiteSpace(meson)) parts.Add(meson);
        if (!string.IsNullOrWhiteSpace(posicion)) parts.Add(posicion);
        return parts.Count == 0 ? "Sin ubicación" : string.Join(" · ", parts);
    }

    private static string ResolveUrl(string? url)
    {
        if (string.IsNullOrWhiteSpace(url)) return "";
        if (url.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return url;
        return url.StartsWith("/", StringComparison.OrdinalIgnoreCase) ? url : $"/{url}";
    }

    private static string NullDash(string? s) => string.IsNullOrWhiteSpace(s) ? "—" : s;

    public void Dispose()
    {
        LaboratorioState.OnChange -= HandleLaboratorioChanged;
    }

    private sealed record SelectOption(string Id, string Label);
    private sealed record SubcatOption(string Id, string CategoriaId, string Label);

    private sealed record ManualDocOption(
        string Id,
        string Titulo,
        string? Url,
        string? ArchivoLocal,
        int? LaboratorioContextoId
    );

    private sealed class ModeloEquipoEdit
    {
        public string ModeloId { get; set; } = "";
        public string NombreModelo { get; set; } = "";

        public string MarcaId { get; set; } = "";
        public string MarcaNombre { get; set; } = "";

        public string CategoriaId { get; set; } = "";
        public string CategoriaNombre { get; set; } = "";

        public bool EsCalibrable { get; set; }

        // ✅ ahora es documento_id
        public string ManualUrl { get; set; } = "";

        // ✅ NUEVO: altura_cm (guardamos como texto para input type=number)
        public string AlturaCm { get; set; } = "";

        public string Notas { get; set; } = "";
        public string Descripcion { get; set; } = "";

        public string ImagenUrl { get; set; } = "";

        public HashSet<string> SubcategoriaIds { get; set; } = new(StringComparer.OrdinalIgnoreCase);
    }

    private sealed class EquipoInstanciaInfo
    {
        public string EquipoId { get; set; } = "";
        public string Nombre { get; set; } = "";
        public string Serie { get; set; } = "";
        public string Estado { get; set; } = "";
        public string Ubicacion { get; set; } = "";
        public string RequiereCalibracion { get; set; } = "";
    }
}

<style>
    .page-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
        padding: 1rem;
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.04);
    }

    .header-row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
    }

    .header-actions {
        display: flex;
        gap: .5rem;
        align-items: center;
    }

    .muted {
        color: #64748b;
    }

    .text-xs {
        font-size: .8rem;
    }

    .text-sm {
        font-size: .9rem;
    }

    .error-note {
        color: #b91c1c;
    }

    .empty {
        padding: .85rem 1rem;
        border-radius: 10px;
        background: #fef9c3;
        border: 1px solid #fde68a;
        color: #854d0e;
    }

    .btn {
        border: 1px solid #cbd5e1;
        background: #fff;
        color: #0f172a;
        padding: .5rem .9rem;
        border-radius: .55rem;
        font-weight: 700;
        cursor: pointer;
    }

        .btn.primary {
            background: #2563eb;
            color: #fff;
            border: none;
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.18);
        }

            .btn.primary:hover {
                background: #1d4ed8;
            }

        .btn.danger {
            background: #b91c1c;
            color: #fff;
            border: none;
        }

            .btn.danger:hover {
                background: #991b1b;
            }

    .btn-link {
        color: #1d4ed8;
        text-decoration: none;
        font-weight: 900;
    }

        .btn-link:hover {
            text-decoration: underline;
        }

    /* ===== Vista bonita ===== */
    .detail-grid {
        display: grid;
        grid-template-columns: minmax(240px, 320px) 1fr;
        gap: 1rem;
        align-items: start;
    }

    @@media (max-width: 900px) {
        .detail-grid {
            grid-template-columns: 1fr;
        }
    }

    .detail-media {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: .75rem;
        background: #fafafa;
    }

    .material-img {
        width: 100%;
        height: 280px;
        object-fit: contain;
        border-radius: 10px;
        background: #fff;
        border: 1px solid #e5e7eb;
    }

    .img-placeholder {
        width: 100%;
        height: 280px;
        border-radius: 10px;
        background: #f1f5f9;
        border: 1px dashed #cbd5e1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-weight: 800;
    }

    .detail-info {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        background: #fff;
    }

    .title-row {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: .75rem;
    }

    .badges {
        display: flex;
        gap: .4rem;
        flex-wrap: wrap;
    }

    .badge {
        background: #dbeafe;
        color: #1d4ed8;
        padding: .2rem .55rem;
        border-radius: 999px;
        font-size: .85rem;
        font-weight: 800;
    }

        .badge.gray {
            background: #e2e8f0;
            color: #0f172a;
        }

    .dl {
        display: grid;
        gap: .6rem;
    }

    .dl-row {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: .75rem;
    }

    @@media (max-width: 900px) {
        .dl-row {
            grid-template-columns: 1fr;
        }
    }

    .dt {
        color: #475569;
        font-weight: 900;
    }

    .dd {
        color: #0f172a;
    }

    .view-actions {
        margin-top: 1rem;
        display: flex;
        gap: .75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    /* ===== Chips ===== */
    .chips-row {
        display: flex;
        gap: .5rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .chip {
        background: #eef2ff;
        border: 1px solid #c7d2fe;
        color: #1e1b4b;
        padding: .25rem .6rem;
        border-radius: 999px;
        font-weight: 900;
        font-size: .85rem;
    }

        .chip.warn {
            background: #fff7ed;
            border-color: #fdba74;
            color: #9a3412;
        }

    /* ===== Notes / tabla ===== */
    .notes {
        margin-top: 1rem;
        background: #f1f5f9;
        border-radius: 12px;
        padding: .85rem 1rem;
        color: #334155;
        border: 1px solid #e2e8f0;
    }

    .table-wrap {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
    }

    th, td {
        padding: 0.6rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
    }

    th {
        background: #f3f4f6;
        font-weight: 900;
    }

    /* ===== Form ===== */
    .form-header {
        margin-bottom: .75rem;
    }

        .form-header h4 {
            margin: 0 0 .25rem 0;
            font-weight: 900;
            color: #0f172a;
        }

    .form-hint {
        margin: 0;
        color: #64748b;
        font-size: .95rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: .75rem;
        align-items: start;
    }

    .full-span {
        grid-column: 1 / -1;
    }

    .field label {
        display: block;
        font-size: .85rem;
        color: #475569;
        margin-bottom: .25rem;
        font-weight: 900;
    }

    .border {
        border: 1px solid #e5e7eb;
        border-radius: .5rem;
    }

    .p-1 {
        padding: .45rem .6rem;
    }

    .edit-check {
        display: inline-flex;
        gap: .5rem;
        align-items: center;
        font-weight: 900;
        color: #0f172a;
        padding: .45rem .6rem;
        border: 1px solid #e5e7eb;
        border-radius: .5rem;
        background: #fff;
    }

    .form-actions {
        display: flex;
        gap: .75rem;
        align-items: center;
        flex-wrap: wrap;
        margin-top: .25rem;
    }

    /* Upload + preview */
    .upload-card {
        border: 1px dashed #d1d5db;
        padding: .75rem;
        border-radius: .75rem;
        display: grid;
        gap: .6rem;
        background: #fff;
    }

    .upload-options {
        display: flex;
        gap: .75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .upload-drop {
        position: relative;
        display: flex;
        align-items: center;
        gap: .5rem;
        padding: .6rem;
        border: 1px solid #e5e7eb;
        border-radius: .5rem;
        color: #6b7280;
        cursor: pointer;
    }

        .upload-drop input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

    .preview-row {
        display: flex;
        gap: .5rem;
        align-items: center;
        flex-wrap: wrap;
        margin-top: .25rem;
    }

    .material-img-sm {
        width: 180px;
        height: 120px;
        object-fit: contain;
        border-radius: 10px;
        background: #fff;
        border: 1px solid #e5e7eb;
    }

    /* Dropdown multi-subcats */
    .subcats-dropdown {
        position: relative;
        width: 100%;
    }

    .subcats-btn {
        width: 100%;
        text-align: left;
        border-radius: 10px;
        background: #fff;
    }

    .subcats-panel {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        right: 0;
        z-index: 30;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: .6rem;
        max-height: 240px;
        overflow: auto;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
    }

    .subcats-item {
        display: flex;
        align-items: center;
        gap: .5rem;
        padding: .35rem .25rem;
        border-radius: 8px;
    }

        .subcats-item:hover {
            background: #f1f5f9;
        }
</style>