@page "/inventario-materiales"
@page "/inventario-materiales/{SubcategoriaId}"
@using Npgsql
@using BARI_web.General_Services
@using System.Globalization
@using System.IO
@using Microsoft.AspNetCore.Components.Forms
@inject NpgsqlDataSource DataSource
@inject LaboratorioState LaboratorioState
@inject NavigationManager Nav
@inject IWebHostEnvironment HostEnvironment
@implements IDisposable

<PageTitle>Inventario de Materiales</PageTitle>

<section class="page-card">
    <h2>Inventario de Materiales</h2>
    <p>
        Aquí se organizarán los materiales del laboratorio por categoría y subcategoría,
        siguiendo la guía del maestro. Servirá para registrar material de vidrio,
        consumibles, montaje/soporte y papelería.
    </p>
    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <details>
        <summary style="cursor:pointer; font-weight:600;">Subir material</summary>
        <div class="assign-row" style="margin-top:.75rem;">
            <select class="border p-1" @bind="_nuevoMaterialTipo">
                <option value="vidrio">Vidrio</option>
                <option value="consumible">Consumible</option>
                <option value="montaje">Montaje</option>
            </select>
            <input class="border p-1" placeholder="Nombre" @bind="_nuevoMaterialNombre" />
            @if (_nuevoMaterialTipo == "vidrio")
            {
                <input class="border p-1" placeholder="Capacidad (número)" type="number" step="any" @bind="_nuevoMaterialDetalle" />
                <select class="border p-1" @bind="_nuevoMaterialUnidadId">
                    <option value="">Unidad (vidrio)</option>
                    @foreach (var unidad in _unidadOptions)
                    {
                        <option value="@unidad.Id">@unidad.Label</option>
                    }
                </select>
            }
            <input class="border p-1" placeholder="Cantidad" type="number" step="any" @bind="_nuevoMaterialCantidad" />
            <select class="border p-1" @bind="_nuevoMaterialEstadoId">
                <option value="">Estado</option>
                @foreach (var estado in _estadoOptions)
                {
                    <option value="@estado.Id">@estado.Label</option>
                }
            </select>
            <select class="border p-1" @bind="_nuevoMaterialMarcaId">
                <option value="">Marca</option>
                @foreach (var marca in _marcaOptions)
                {
                    <option value="@marca.Id">@marca.Label</option>
                }
            </select>
            <select class="border p-1" @bind="_nuevoMaterialSubcategoriaId">
                <option value="">Subcategoría</option>
                @foreach (var subcategoria in _subcategoriaOptions)
                {
                    <option value="@subcategoria.Id">@subcategoria.Label</option>
                }
            </select>
            <div class="selector-split">
                <select class="border p-1" value="@_nuevoMaterialAreaId" @onchange="OnAreaChanged">
                    <option value="">Área</option>
                    @foreach (var area in _areaOptions)
                    {
                        <option value="@area.Id">@area.Label</option>
                    }
                </select>
                <div class="visual-picker">
                    <div class="visual-toolbar">
                        <label class="text-xs text-gray-500">Mapa de áreas</label>
                        <select class="border p-1 text-xs" value="@_currentPlantaId" @onchange="OnPlantaChanged">
                            @foreach (var planta in _plantasLookup)
                            {
                                <option value="@planta.Key">@planta.Value</option>
                            }
                        </select>
                    </div>
                    @if (_canvasViews.Count == 0)
                    {
                        <div class="text-xs text-gray-500">Sin mapas disponibles.</div>
                    }
                    else
                    {
                        @foreach (var view in _canvasViews)
                        {
                            var areasPorPlanta = view.Areas.Where(a => IsAreaInCurrentPlanta(a.PlantaId)).ToList();
                            if (areasPorPlanta.Count == 0)
                            {
                                continue;
                            }

                            <div class="canvas-card">
                                <div class="text-xs text-gray-500">@view.Canvas.Nombre</div>
                                <svg width="100%" height="100%" viewBox="0 0 @view.Canvas.Ancho @view.Canvas.Alto" preserveAspectRatio="xMidYMid meet">
                                    @foreach (var area in areasPorPlanta)
                                    {
                                        foreach (var poly in area.Poligonos.OrderBy(p => p.ZOrder))
                                        {
                                            <polygon points="@PointsString(poly)"
                                                     fill="@AreaFill(area)"
                                                     stroke="#111827" stroke-width="0.03"
                                                     style="cursor:pointer"
                                                     @onclick="@(() => SelectAreaFromVisual(area.AreaId))" />
                                        }

                                        if (!string.IsNullOrWhiteSpace(area.Nombre))
                                        {
                                            <text x="@area.CenterX" y="@area.CenterY"
                                                  text-anchor="middle" dominant-baseline="middle"
                                                  font-size="0.25" fill="#111827">
                                                @area.Nombre
                                            </text>
                                        }
                                    }
                                </svg>
                            </div>
                        }
                    }
                </div>
            </div>
            <div class="selector-split">
                <select class="border p-1" @bind="_nuevoMaterialMesonId" disabled="@string.IsNullOrWhiteSpace(_nuevoMaterialAreaId)">
                    <option value="">Mesón</option>
                    @foreach (var meson in _mesonOptions)
                    {
                        <option value="@meson.Id">@meson.Label</option>
                    }
                </select>
                <div class="visual-picker">
                    <div class="text-xs text-gray-500">Mesones del área seleccionada</div>
                    @if (_mesonOptions.Count == 0)
                    {
                        <div class="text-xs text-gray-500">Sin mesones disponibles.</div>
                    }
                    else
                    {
                        <ul class="meson-list">
                            @foreach (var meson in _mesonOptions)
                            {
                                <li>
                                    <button type="button"
                                            class="btn link"
                                            @onclick="@(() => SelectMeson(meson.Id))">
                                        @meson.Label
                                    </button>
                                </li>
                            }
                        </ul>
                    }
                    @if (!string.IsNullOrWhiteSpace(_nuevoMaterialMesonId))
                    {
                        <div class="text-xs text-gray-500">
                            Seleccionado: @SelectedAreaLabel · @SelectedMesonLabel
                        </div>
                    }
                </div>
            </div>
            <input class="border p-1" placeholder="Nivel" @bind="_nuevoMaterialNivel" />
            <input class="border p-1" placeholder="Posición (ej. al fondo, en el medio)" @bind="_nuevoMaterialPosicion" />
            <input class="border p-1" placeholder="Descripción" @bind="_nuevoMaterialDescripcion" />
            <div class="upload-card">
                <div class="upload-options">
                    <label class="text-sm">
                        <input type="radio" name="imagenModo" value="url" @bind-value="_nuevoMaterialImagenModo" />
                        Colocar un URL
                    </label>
                    <label class="text-sm">
                        <input type="radio" name="imagenModo" value="archivo" @bind-value="_nuevoMaterialImagenModo" />
                        Subir archivo
                    </label>
                </div>
                @if (_nuevoMaterialImagenModo == "url")
                {
                    <input class="border p-1" placeholder="Imagen URL (o ruta relativa)" @bind="_nuevoMaterialImagenUrl" />
                }
                else
                {
                    <label class="upload-drop">
                        <InputFile OnChange="OnImagenArchivoSeleccionado" accept="image/png,image/jpeg,image/jpg,image/webp" />
                        <span>Arrastra una imagen o haz clic para buscar</span>
                    </label>
                    @if (!string.IsNullOrWhiteSpace(_nuevoMaterialImagenArchivo))
                    {
                        <div class="text-xs text-gray-500">Archivo: @_nuevoMaterialImagenArchivo</div>
                    }
                }
            </div>
            <input class="border p-1" placeholder="Observaciones" @bind="_nuevoMaterialObservaciones" />
            <button class="btn" @onclick="SubirMaterialAsync">Subir</button>
            @if (!string.IsNullOrWhiteSpace(_nuevoMaterialMsg))
            {
                <span class="text-sm text-gray-500">@_nuevoMaterialMsg</span>
            }
        </div>
    </details>
</section>
<section class="page-card" style="margin-top:1.5rem;">
    <div class="category-header">
        <div>
            <h3>Guía de categorías (base para materiales)</h3>
            <p class="helper">Selecciona una subcategoría para ver los materiales de ese tipo.</p>
        </div>
        <div class="category-controls">
            <select class="category-select" @onchange="OnSubcategoriaChanged" value="@SubcategoriaId">
                <option value="">Todas las categorías</option>
                @foreach (var categoria in categorias)
                {
                    <optgroup label="@categoria.Nombre">
                        @foreach (var subcategoria in categoria.Subcategorias)
                        {
                            <option value="@subcategoria.Id">@subcategoria.Nombre</option>
                        }
                    </optgroup>
                }
            </select>
        </div>
        @if (!string.IsNullOrWhiteSpace(SubcategoriaId))
        {
            <NavLink class="btn-link" href="/inventario-materiales">Ver todas las categorías</NavLink>
        }
    </div>

    @if (categorias.Count == 0)
    {
        <p><em>Cargando categorías…</em></p>
    }
    else
    {
        <div class="category-grid">
            @foreach (var categoria in categorias)
            {
                <div class="category-card">
                    <div class="category-title">@categoria.Nombre</div>
                    <ul class="category-list">
                        @foreach (var subcategoria in categoria.Subcategorias)
                        {
                            <li>
                                <NavLink href="@($"/inventario-materiales/{subcategoria.Id}")" class="category-link">
                                    @subcategoria.Nombre
                                </NavLink>
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>
    }
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <div class="materials-header">
        <h3>@(string.IsNullOrWhiteSpace(SubcategoriaId) ? "Materiales disponibles" : $"Materiales · {subcategoriaNombre ?? SubcategoriaId}")</h3>
        @if (!string.IsNullOrWhiteSpace(SubcategoriaId))
        {
            <span class="badge">@materiales.Count materiales</span>
        }
    </div>

    @if (!string.IsNullOrWhiteSpace(loadError))
    {
        <p class="error-note">No se pudieron cargar materiales: @loadError</p>
    }
    else if (string.IsNullOrWhiteSpace(SubcategoriaId))
    {
        <p class="helper">Elige una subcategoría para ver los materiales asociados.</p>
    }
    else if (materiales.Count == 0)
    {
        <div class="empty">
            No hay materiales registrados para esta subcategoría.
        </div>
    }
    else
    {
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Subcategoría</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Cantidad</th>
                        <th>Ubicación</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var material in materiales)
                    {
                        <tr>
                            <td>@material.MaterialId</td>
                            <td>
                                <NavLink href="@($"/inventario-materiales/item/{material.MaterialId}")">
                                    @material.Nombre
                                </NavLink>
                            </td>
                            <td>@material.Categoria</td>
                            <td>@material.Subcategoria</td>
                            <td>@material.Tipo</td>
                            <td>@material.Estado</td>
                            <td>@material.Cantidad</td>
                            <td>@material.Ubicacion</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</section>

@code {
    [Parameter] public string? SubcategoriaId { get; set; }

    private readonly List<CategoriaRow> categorias = new();
    private readonly List<MaterialRow> materiales = new();
    private string? subcategoriaNombre;
    private string? loadError;
    private string _nuevoMaterialTipo = "vidrio";
    private string? _nuevoMaterialNombre;
    private string? _nuevoMaterialDetalle;
    private string? _nuevoMaterialCantidad;
    private string? _nuevoMaterialPosicion;
    private string? _nuevoMaterialEstadoId;
    private string? _nuevoMaterialUnidadId;
    private string? _nuevoMaterialMarcaId;
    private string? _nuevoMaterialSubcategoriaId;
    private string? _nuevoMaterialAreaId;
    private string? _nuevoMaterialMesonId;
    private string? _nuevoMaterialNivel;
    private string? _nuevoMaterialDescripcion;
    private string? _nuevoMaterialImagenUrl;
    private string _nuevoMaterialImagenModo = "url";
    private string? _nuevoMaterialImagenArchivo;
    private string? _nuevoMaterialObservaciones;
    private string? _nuevoMaterialMsg;
    private readonly List<SelectOption> _estadoOptions = new();
    private readonly List<SelectOption> _unidadOptions = new();
    private readonly List<SelectOption> _marcaOptions = new();
    private readonly List<SelectOption> _subcategoriaOptions = new();
    private readonly List<SelectOption> _areaOptions = new();
    private readonly List<SelectOption> _mesonOptions = new();
    private readonly List<CanvasView> _canvasViews = new();
    private readonly Dictionary<string, string> _plantasLookup = new(StringComparer.OrdinalIgnoreCase);
    private string? _currentPlantaId;

    protected override void OnInitialized()
    {
        LaboratorioState.OnChange += HandleLaboratorioChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        loadError = null;
        await LoadCategoriasAsync();
        await LoadLookupsAsync();
        await LoadCanvasAreasAsync();
        await LoadMaterialesAsync();
    }

    private async void HandleLaboratorioChanged()
    {
        await LoadMaterialesAsync();
        await LoadLookupsAsync();
        await LoadCanvasAreasAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnAreaChanged(ChangeEventArgs args)
    {
        _nuevoMaterialAreaId = args.Value?.ToString();
        _nuevoMaterialMesonId = null;
        await LoadMesonesAsync();
    }

    private async Task OnPlantaChanged(ChangeEventArgs args)
    {
        _currentPlantaId = args.Value?.ToString();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SelectAreaFromVisual(string? areaId)
    {
        if (string.IsNullOrWhiteSpace(areaId))
        {
            return;
        }

        _nuevoMaterialAreaId = areaId;
        _nuevoMaterialMesonId = null;
        await LoadMesonesAsync();
        await InvokeAsync(StateHasChanged);
    }

    private void SelectMeson(string mesonId)
    {
        _nuevoMaterialMesonId = mesonId;
    }

    private string SelectedAreaLabel =>
        _areaOptions.FirstOrDefault(a => string.Equals(a.Id, _nuevoMaterialAreaId, StringComparison.OrdinalIgnoreCase))?.Label
        ?? _nuevoMaterialAreaId
        ?? "Área";

    private string SelectedMesonLabel =>
        _mesonOptions.FirstOrDefault(m => string.Equals(m.Id, _nuevoMaterialMesonId, StringComparison.OrdinalIgnoreCase))?.Label
        ?? _nuevoMaterialMesonId
        ?? "Mesón";

    private async Task OnImagenArchivoSeleccionado(InputFileChangeEventArgs args)
    {
        if (args.FileCount == 0)
        {
            return;
        }

        var file = args.File;
        var extension = Path.GetExtension(file.Name);
        var fileName = $"material_{Guid.NewGuid():N}{extension}";
        var relativePath = Path.Combine("uploads", "materiales", fileName).Replace("\\", "/");
        var absolutePath = Path.Combine(HostEnvironment.WebRootPath, relativePath);
        Directory.CreateDirectory(Path.GetDirectoryName(absolutePath)!);

        await using var stream = file.OpenReadStream(5 * 1024 * 1024);
        await using var fileStream = File.Create(absolutePath);
        await stream.CopyToAsync(fileStream);

        _nuevoMaterialImagenUrl = $"/{relativePath}";
        _nuevoMaterialImagenArchivo = file.Name;
        _nuevoMaterialMsg = $"Imagen cargada: {file.Name}";
    }

    private async Task SubirMaterialAsync()
    {
        if (string.IsNullOrWhiteSpace(_nuevoMaterialNombre))
        {
            _nuevoMaterialMsg = "Ingresa el nombre del material.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_nuevoMaterialAreaId))
        {
            _nuevoMaterialMsg = "Selecciona un área para el material.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_nuevoMaterialMesonId))
        {
            _nuevoMaterialMsg = "Selecciona un mesón asociado al área.";
            return;
        }

        var materialId = $"mat_{Guid.NewGuid():N}".Substring(0, 12);
        await using var conn = await DataSource.OpenConnectionAsync();
        string sql;
        var cmd = new NpgsqlCommand();
        cmd.Connection = conn;
        cmd.Parameters.AddWithValue("id", materialId);
        cmd.Parameters.AddWithValue("nombre", _nuevoMaterialNombre!);
        cmd.Parameters.AddWithValue("estado", string.IsNullOrWhiteSpace(_nuevoMaterialEstadoId) ? (object)DBNull.Value : _nuevoMaterialEstadoId!);
        cmd.Parameters.AddWithValue("posicion", string.IsNullOrWhiteSpace(_nuevoMaterialPosicion) ? (object)DBNull.Value : _nuevoMaterialPosicion!);
        cmd.Parameters.AddWithValue("marca", string.IsNullOrWhiteSpace(_nuevoMaterialMarcaId) ? (object)DBNull.Value : _nuevoMaterialMarcaId!);
        cmd.Parameters.AddWithValue("subcat", string.IsNullOrWhiteSpace(_nuevoMaterialSubcategoriaId) ? (object)DBNull.Value : _nuevoMaterialSubcategoriaId!);
        cmd.Parameters.AddWithValue("area", string.IsNullOrWhiteSpace(_nuevoMaterialAreaId) ? (object)DBNull.Value : _nuevoMaterialAreaId!);
        cmd.Parameters.AddWithValue("meson", string.IsNullOrWhiteSpace(_nuevoMaterialMesonId) ? (object)DBNull.Value : _nuevoMaterialMesonId!);
        cmd.Parameters.AddWithValue("nivel", ParseIntOrNull(_nuevoMaterialNivel));
        cmd.Parameters.AddWithValue("cantidad", ParseDecimalOrNull(_nuevoMaterialCantidad));
        cmd.Parameters.AddWithValue("descripcion", string.IsNullOrWhiteSpace(_nuevoMaterialDescripcion) ? (object)DBNull.Value : _nuevoMaterialDescripcion!);
        cmd.Parameters.AddWithValue("imagen", string.IsNullOrWhiteSpace(_nuevoMaterialImagenUrl) ? (object)DBNull.Value : _nuevoMaterialImagenUrl!);
        cmd.Parameters.AddWithValue("obs", string.IsNullOrWhiteSpace(_nuevoMaterialObservaciones) ? (object)DBNull.Value : _nuevoMaterialObservaciones!);
        cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);

        if (_nuevoMaterialTipo == "consumible")
        {
            sql = @"
                INSERT INTO materiales_consumible
                (material_id, nombre, subcategoria_id, marca_id, estado_id, cantidad, area_id, meson_id, nivel, posicion,
                 laboratorio_id, descripcion, imagen_url, observaciones)
                VALUES (@id, @nombre, @subcat, @marca, @estado, @cantidad, @area, @meson, @nivel, @posicion,
                        @lab, @descripcion, @imagen, @obs)";
        }
        else if (_nuevoMaterialTipo == "montaje")
        {
            sql = @"
                INSERT INTO materiales_montaje
                (material_id, nombre, subcategoria_id, marca_id, estado_id, cantidad, area_id, meson_id, nivel, posicion,
                 laboratorio_id, descripcion, imagen_url, observaciones)
                VALUES (@id, @nombre, @subcat, @marca, @estado, @cantidad, @area, @meson, @nivel, @posicion,
                        @lab, @descripcion, @imagen, @obs)";
        }
        else
        {
            sql = @"
                INSERT INTO materiales_vidrio
                (material_id, nombre, subcategoria_id, capacidad_num, unidad_id, marca_id, estado_id, cantidad, area_id, meson_id,
                 nivel, posicion, laboratorio_id, descripcion, imagen_url, observaciones)
                VALUES (@id, @nombre, @subcat, @capacidad, @unidad, @marca, @estado, @cantidad, @area, @meson,
                        @nivel, @posicion, @lab, @descripcion, @imagen, @obs)";
            cmd.Parameters.AddWithValue("capacidad", ParseDecimalOrNull(_nuevoMaterialDetalle));
            cmd.Parameters.AddWithValue("unidad", string.IsNullOrWhiteSpace(_nuevoMaterialUnidadId) ? (object)DBNull.Value : _nuevoMaterialUnidadId!);
        }

        cmd.CommandText = sql;
        await cmd.ExecuteNonQueryAsync();

        _nuevoMaterialNombre = null;
        _nuevoMaterialDetalle = null;
        _nuevoMaterialCantidad = null;
        _nuevoMaterialEstadoId = null;
        _nuevoMaterialPosicion = null;
        _nuevoMaterialUnidadId = null;
        _nuevoMaterialMarcaId = null;
        _nuevoMaterialSubcategoriaId = null;
        _nuevoMaterialAreaId = null;
        _nuevoMaterialMesonId = null;
        _nuevoMaterialNivel = null;
        _nuevoMaterialDescripcion = null;
        _nuevoMaterialImagenUrl = null;
        _nuevoMaterialImagenModo = "url";
        _nuevoMaterialImagenArchivo = null;
        _nuevoMaterialObservaciones = null;
        _nuevoMaterialMsg = "Material registrado.";
        await LoadMaterialesAsync();
    }

    private static object ParseIntOrNull(string? value)
    {
        return int.TryParse(value, out var i)
            ? i
            : DBNull.Value;
    }

    private static object ParseDecimalOrNull(string? value)
    {
        return decimal.TryParse(value, NumberStyles.Any, CultureInfo.InvariantCulture, out var d)
            ? d
            : DBNull.Value;
    }

    private static readonly string[] CategoriaPermitidas =
    [
        "Material de Vidrio",
        "Material Consumible",
        "Material de Montaje/Soporte"
    ];

    private async Task LoadCategoriasAsync()
    {
        if (categorias.Count > 0) return;

        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            const string sql = @"
                SELECT c.categoria_id, c.nombre,
                       s.subcategoria_id, s.nombre
                FROM categorias c
                LEFT JOIN subcategorias s ON s.categoria_id = c.categoria_id
                WHERE c.nombre = ANY(@categorias)
                ORDER BY c.nombre, s.nombre
                ";
            await using var cmd = new NpgsqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("categorias", CategoriaPermitidas);
            await using var reader = await cmd.ExecuteReaderAsync();
            var map = new Dictionary<string, CategoriaRow>();
            while (await reader.ReadAsync())
            {
                var categoriaId = reader.GetString(0);
                if (!map.TryGetValue(categoriaId, out var categoria))
                {
                    categoria = new CategoriaRow(categoriaId, reader.GetString(1));
                    map.Add(categoriaId, categoria);
                    categorias.Add(categoria);
                }

                if (!reader.IsDBNull(2))
                {
                    categoria.Subcategorias.Add(new SubcategoriaRow(
                        reader.GetString(2),
                        reader.GetString(3)
                    ));
                }
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private async Task LoadLookupsAsync()
    {
        _estadoOptions.Clear();
        _unidadOptions.Clear();
        _marcaOptions.Clear();
        _subcategoriaOptions.Clear();
        _areaOptions.Clear();
        _mesonOptions.Clear();

        await using var conn = await DataSource.OpenConnectionAsync();

        await using (var cmd = new NpgsqlCommand("SELECT estado_id, nombre FROM estados_activo ORDER BY nombre", conn))
        await using (var reader = await cmd.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                _estadoOptions.Add(new SelectOption(reader.GetString(0), reader.GetString(1)));
            }
        }

        await using (var cmd = new NpgsqlCommand("SELECT unidad_id, nombre, simbolo FROM unidades ORDER BY nombre", conn))
        await using (var reader = await cmd.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                _unidadOptions.Add(new SelectOption(reader.GetString(0), $"{reader.GetString(1)} ({reader.GetString(2)})"));
            }
        }

        await using (var cmd = new NpgsqlCommand("SELECT marca_id, nombre FROM marcas ORDER BY nombre", conn))
        await using (var reader = await cmd.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                _marcaOptions.Add(new SelectOption(reader.GetString(0), reader.GetString(1)));
            }
        }

        const string subcategoriaSql = @"
            SELECT s.subcategoria_id, s.nombre, c.nombre
            FROM subcategorias s
            INNER JOIN categorias c ON c.categoria_id = s.categoria_id
            WHERE c.nombre = ANY(@categorias)
            ORDER BY c.nombre, s.nombre";
        await using (var cmd = new NpgsqlCommand(subcategoriaSql, conn))
        {
            cmd.Parameters.AddWithValue("categorias", CategoriaPermitidas);
            await using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                var label = $"{reader.GetString(2)} · {reader.GetString(1)}";
                _subcategoriaOptions.Add(new SelectOption(reader.GetString(0), label));
            }
        }

        const string areaSql = @"
            SELECT area_id, nombre_areas
            FROM areas
            WHERE laboratorio_id = @lab
            ORDER BY nombre_areas";
        await using (var cmd = new NpgsqlCommand(areaSql, conn))
        {
            cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);
            await using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                _areaOptions.Add(new SelectOption(reader.GetString(0), reader.GetString(1)));
            }
        }

        await LoadMesonesAsync();
    }

    private async Task LoadMesonesAsync()
    {
        _mesonOptions.Clear();
        if (string.IsNullOrWhiteSpace(_nuevoMaterialAreaId))
        {
            return;
        }

        await using var conn = await DataSource.OpenConnectionAsync();
        const string mesonSql = @"
            SELECT meson_id, nombre_meson
            FROM mesones
            WHERE area_id = @area
              AND laboratorio_id = @lab
            ORDER BY nombre_meson";
        await using var cmd = new NpgsqlCommand(mesonSql, conn);
        cmd.Parameters.AddWithValue("area", _nuevoMaterialAreaId);
        cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);
        await using var reader = await cmd.ExecuteReaderAsync();
        while (await reader.ReadAsync())
        {
            _mesonOptions.Add(new SelectOption(reader.GetString(0), reader.GetString(1)));
        }
    }

    private async Task LoadCanvasAreasAsync()
    {
        _canvasViews.Clear();
        _plantasLookup.Clear();
        var previousPlantaId = _currentPlantaId;
        _currentPlantaId = null;

        await using var conn = await DataSource.OpenConnectionAsync();

        await using (var cmd = new NpgsqlCommand("SELECT planta_id, nombre FROM plantas ORDER BY nombre", conn))
        await using (var reader = await cmd.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                _plantasLookup[reader.GetString(0)] = reader.GetString(1);
            }
        }

        if (!string.IsNullOrWhiteSpace(previousPlantaId) && _plantasLookup.ContainsKey(previousPlantaId))
        {
            _currentPlantaId = previousPlantaId;
        }
        else
        {
            _currentPlantaId = _plantasLookup.Keys.FirstOrDefault();
        }

        const string canvasSql = @"
            SELECT canvas_id, nombre, ancho_m, alto_m
            FROM canvas_lab
            WHERE laboratorio_id = @lab
            ORDER BY nombre";
        var canvases = new List<CanvasItem>();
        await using (var cmd = new NpgsqlCommand(canvasSql, conn))
        {
            cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);
            await using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                canvases.Add(new CanvasItem(
                    reader.GetString(0),
                    reader.GetString(1),
                    reader.GetDecimal(2),
                    reader.GetDecimal(3)
                ));
            }
        }

        const string areaSql = @"
            SELECT area_id, nombre_areas, planta_id, canvas_id
            FROM areas
            WHERE laboratorio_id = @lab
            ORDER BY nombre_areas";
        var areas = new List<AreaItem>();
        await using (var cmd = new NpgsqlCommand(areaSql, conn))
        {
            cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);
            await using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                areas.Add(new AreaItem(
                    reader.GetString(0),
                    reader.GetString(1),
                    reader.IsDBNull(2) ? null : reader.GetString(2),
                    reader.IsDBNull(3) ? null : reader.GetString(3)
                ));
            }
        }

        const string polySql = @"
            SELECT poly_id, area_id, color_hex, z_order
            FROM poligonos
            WHERE area_id IS NOT NULL
            ORDER BY z_order, poly_id";
        var polys = new Dictionary<string, PolygonItem>();
        await using (var cmd = new NpgsqlCommand(polySql, conn))
        await using (var reader = await cmd.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                var polyId = reader.GetString(0);
                polys[polyId] = new PolygonItem(
                    polyId,
                    reader.IsDBNull(1) ? null : reader.GetString(1),
                    reader.IsDBNull(2) ? "#cbd5f5" : reader.GetString(2),
                    reader.GetInt32(3)
                );
            }
        }

        const string pointsSql = @"
            SELECT poly_id, orden, x_m, y_m
            FROM poligonos_puntos
            ORDER BY poly_id, orden";
        await using (var cmd = new NpgsqlCommand(pointsSql, conn))
        await using (var reader = await cmd.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                var polyId = reader.GetString(0);
                if (!polys.TryGetValue(polyId, out var poly))
                {
                    continue;
                }

                poly.Points.Add(new PointItem(reader.GetDecimal(2), reader.GetDecimal(3)));
            }
        }

        var areasById = areas.ToDictionary(a => a.AreaId, StringComparer.OrdinalIgnoreCase);
        foreach (var area in areas)
        {
            var areaPolys = polys.Values.Where(p => string.Equals(p.AreaId, area.AreaId, StringComparison.OrdinalIgnoreCase)).ToList();
            if (areaPolys.Count == 0)
            {
                continue;
            }

            area.Poligonos.AddRange(areaPolys);
            area.CalculateBounds();
        }

        foreach (var canvas in canvases)
        {
            var viewAreas = areasById.Values
                .Where(a => string.Equals(a.CanvasId, canvas.CanvasId, StringComparison.OrdinalIgnoreCase))
                .ToList();

            if (viewAreas.Count == 0)
            {
                continue;
            }

            _canvasViews.Add(new CanvasView(canvas, viewAreas));
        }
    }

    private async Task LoadMaterialesAsync()
    {
        materiales.Clear();
        subcategoriaNombre = null;

        if (string.IsNullOrWhiteSpace(SubcategoriaId))
        {
            return;
        }

        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            const string sqlSubcategoria = @"
                SELECT nombre
                FROM subcategorias
                WHERE subcategoria_id = @subcategoria
                ";
            await using (var cmdName = new NpgsqlCommand(sqlSubcategoria, conn))
            {
                cmdName.Parameters.AddWithValue("subcategoria", SubcategoriaId);
                var nombre = await cmdName.ExecuteScalarAsync();
                subcategoriaNombre = nombre?.ToString();
            }

            const string sql = @"
                WITH materiales AS (
                    SELECT mv.material_id,
                           mv.nombre,
                           mv.subcategoria_id,
                           mv.estado_id,
                           mv.cantidad,
                           mv.area_id,
                           mv.meson_id,
                           mv.posicion,
                           mv.laboratorio_id,
                           'Vidrio'::text AS tipo
                    FROM materiales_vidrio mv
                    UNION ALL
                    SELECT mm.material_id,
                           mm.nombre,
                           mm.subcategoria_id,
                           mm.estado_id,
                           mm.cantidad,
                           mm.area_id,
                           mm.meson_id,
                           mm.posicion,
                           mm.laboratorio_id,
                           'Montaje'::text AS tipo
                    FROM materiales_montaje mm
                    UNION ALL
                    SELECT mc.material_id,
                           mc.nombre,
                           mc.subcategoria_id,
                           mc.estado_id,
                           mc.cantidad,
                           mc.area_id,
                           mc.meson_id,
                           mc.posicion,
                           mc.laboratorio_id,
                           'Consumible'::text AS tipo
                    FROM materiales_consumible mc
                )
                SELECT m.material_id,
                       m.nombre,
                       COALESCE(c.nombre, '') AS categoria,
                       COALESCE(sc.nombre, '') AS subcategoria,
                       COALESCE(ea.nombre, 'Sin estado') AS estado,
                       COALESCE(m.cantidad::text, '—') AS cantidad,
                       COALESCE(a.nombre_areas, '') AS area,
                       COALESCE(ms.nombre_meson, '') AS meson,
                       COALESCE(m.posicion, '') AS posicion,
                       m.tipo
                FROM materiales m
                LEFT JOIN subcategorias sc ON sc.subcategoria_id = m.subcategoria_id
                LEFT JOIN categorias c ON c.categoria_id = sc.categoria_id
                LEFT JOIN estados_activo ea ON ea.estado_id = m.estado_id
                LEFT JOIN areas a ON a.area_id = m.area_id
                LEFT JOIN mesones ms ON ms.meson_id = m.meson_id
                WHERE m.subcategoria_id = @subcategoria
                  AND m.laboratorio_id = @laboratorio
                  AND c.nombre = ANY(@categorias)
                ORDER BY m.nombre, m.material_id
                ";
            await using var cmd = new NpgsqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("subcategoria", SubcategoriaId);
            cmd.Parameters.AddWithValue("laboratorio", LaboratorioState.LaboratorioId);
            cmd.Parameters.AddWithValue("categorias", CategoriaPermitidas);
            await using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                var material = new MaterialRow(
                    reader.GetString(0),
                    reader.GetString(1),
                    reader.GetString(2),
                    reader.GetString(3),
                    reader.GetString(9),
                    reader.GetString(4),
                    reader.GetString(5),
                    BuildUbicacion(reader.GetString(6), reader.GetString(7), reader.GetString(8))
                );
                materiales.Add(material);
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private static string BuildUbicacion(string area, string meson, string posicion)
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(area)) parts.Add(area);
        if (!string.IsNullOrWhiteSpace(meson)) parts.Add(meson);
        if (!string.IsNullOrWhiteSpace(posicion)) parts.Add(posicion);
        return parts.Count == 0 ? "Sin ubicación" : string.Join(" · ", parts);
    }

    private sealed class CategoriaRow
    {
        public CategoriaRow(string id, string nombre)
        {
            Id = id;
            Nombre = nombre;
        }

        public string Id { get; }
        public string Nombre { get; }
        public List<SubcategoriaRow> Subcategorias { get; } = new();
    }

    private sealed record SubcategoriaRow(string Id, string Nombre);
    private sealed record SelectOption(string Id, string Label);
    private sealed record CanvasItem(string CanvasId, string Nombre, decimal Ancho, decimal Alto);

    private sealed class AreaItem
    {
        public AreaItem(string areaId, string nombre, string? plantaId, string? canvasId)
        {
            AreaId = areaId;
            Nombre = nombre;
            PlantaId = plantaId;
            CanvasId = canvasId;
        }

        public string AreaId { get; }
        public string Nombre { get; }
        public string? PlantaId { get; }
        public string? CanvasId { get; }
        public List<PolygonItem> Poligonos { get; } = new();
        public decimal CenterX { get; private set; }
        public decimal CenterY { get; private set; }

        public void CalculateBounds()
        {
            var points = Poligonos.SelectMany(p => p.Points).ToList();
            if (points.Count == 0)
            {
                return;
            }

            var minX = points.Min(p => p.X);
            var maxX = points.Max(p => p.X);
            var minY = points.Min(p => p.Y);
            var maxY = points.Max(p => p.Y);
            CenterX = (minX + maxX) / 2m;
            CenterY = (minY + maxY) / 2m;
        }
    }

    private sealed class PolygonItem
    {
        public PolygonItem(string polyId, string? areaId, string colorHex, int zOrder)
        {
            PolyId = polyId;
            AreaId = areaId;
            ColorHex = colorHex;
            ZOrder = zOrder;
        }

        public string PolyId { get; }
        public string? AreaId { get; }
        public string ColorHex { get; }
        public int ZOrder { get; }
        public List<PointItem> Points { get; } = new();
    }

    private sealed record PointItem(decimal X, decimal Y);

    private sealed record CanvasView(CanvasItem Canvas, List<AreaItem> Areas);

    private sealed record MaterialRow(
        string MaterialId,
        string Nombre,
        string Categoria,
        string Subcategoria,
        string Tipo,
        string Estado,
        string Cantidad,
        string Ubicacion);

    private void OnSubcategoriaChanged(ChangeEventArgs args)
    {
        var value = args.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            Nav.NavigateTo("/inventario-materiales");
            return;
        }

        Nav.NavigateTo($"/inventario-materiales/{value}");
    }

    public void Dispose()
    {
        LaboratorioState.OnChange -= HandleLaboratorioChanged;
    }

    private static string PointsString(PolygonItem poly)
    {
        return string.Join(" ", poly.Points.Select(p =>
            $"{p.X.ToString(CultureInfo.InvariantCulture)},{p.Y.ToString(CultureInfo.InvariantCulture)}"));
    }

    private string AreaFill(AreaItem area)
    {
        if (!string.IsNullOrWhiteSpace(_nuevoMaterialAreaId)
            && string.Equals(_nuevoMaterialAreaId, area.AreaId, StringComparison.OrdinalIgnoreCase))
        {
            return "#93c5fd";
        }

        return area.Poligonos.FirstOrDefault()?.ColorHex ?? "#cbd5f5";
    }

    private bool IsAreaInCurrentPlanta(string? plantaId)
    {
        if (string.IsNullOrWhiteSpace(_currentPlantaId))
        {
            return true;
        }

        if (string.IsNullOrWhiteSpace(plantaId))
        {
            return false;
        }

        return string.Equals(plantaId, _currentPlantaId, StringComparison.OrdinalIgnoreCase);
    }
}

<style>
    .category-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
    }

    .category-controls {
        display: flex;
        gap: .75rem;
        align-items: center;
    }

    .selector-split {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: flex-start;
    }

    .visual-picker {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.5rem;
        background: #fff;
        min-width: 240px;
        display: grid;
        gap: 0.5rem;
    }

    .visual-toolbar {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: space-between;
    }

    .canvas-card {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.5rem;
        background: #f8fafc;
        display: grid;
        gap: 0.35rem;
    }

    .canvas-card svg {
        width: 100%;
        height: 180px;
        background: #fff;
    }

    .meson-list {
        list-style: none;
        padding-left: 0;
        margin: 0;
        display: grid;
        gap: 0.35rem;
    }

    .upload-card {
        border: 1px dashed #d1d5db;
        padding: 0.6rem;
        border-radius: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 220px;
    }

    .upload-options {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .upload-drop {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        color: #6b7280;
        cursor: pointer;
    }

    .upload-drop input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }

    .category-select {
        min-width: 220px;
        padding: .35rem .6rem;
        border-radius: 8px;
        border: 1px solid #cbd5f5;
        background: #fff;
        color: #0f172a;
    }

    .helper {
        margin: .3rem 0 0;
        color: #475569;
        font-size: .95rem;
    }

    .btn-link {
        color: #1d4ed8;
        text-decoration: none;
        font-weight: 600;
    }

    .btn-link:hover {
        text-decoration: underline;
    }

    .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .category-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
        padding: 1rem;
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.04);
    }

    .category-title {
        font-weight: 700;
        color: #0f172a;
        margin-bottom: .5rem;
    }

    .category-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: .35rem;
    }

    .category-link {
        display: inline-flex;
        padding: .35rem .6rem;
        border-radius: 999px;
        background: #f1f5f9;
        color: #0f172a;
        text-decoration: none;
        font-size: .9rem;
    }

    .category-link.active,
    .category-link:hover {
        background: #dbeafe;
        color: #1d4ed8;
    }

    .materials-header {
        display: flex;
        align-items: center;
        gap: .75rem;
    }

    .badge {
        background: #e2e8f0;
        color: #0f172a;
        padding: .2rem .55rem;
        border-radius: 999px;
        font-size: .85rem;
        font-weight: 600;
    }

    .empty {
        padding: .85rem 1rem;
        border-radius: 10px;
        background: #fef9c3;
        border: 1px solid #fde68a;
        color: #854d0e;
    }

    .assign-row {
        display:flex;
        flex-wrap:wrap;
        gap:0.5rem;
        align-items:center;
        margin-top:0.5rem;
    }

    .table-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { padding:0.6rem; border-bottom:1px solid #e5e7eb; text-align:left; }
    th { background:#f3f4f6; font-weight:600; }
    .error-note { color:#b91c1c; margin-top:0.75rem; }
</style>
