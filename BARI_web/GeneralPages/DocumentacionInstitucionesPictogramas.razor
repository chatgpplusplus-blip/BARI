@page "/documentacion/instituciones/pictogramas"
@using Npgsql

<PageTitle>Pictogramas institucionales</PageTitle>

<section class="page-card">
    <h2>Pictogramas (GHS)</h2>
    <p>Listado general de pictogramas institucionales y cuántas sustancias los utilizan.</p>
    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <div class="picto-grid">
        @foreach (var item in pictogramas)
        {
            <article class="picto-card">
                <div class="picto-main">
                    <NavLink class="picto-link" href="@($"/documentacion/instituciones/pictogramas/{item.GhsId}")">
                        <img class="pictogram-icon" src="@item.IconUrl" alt="@item.Descripcion" />
                    </NavLink>
                    <div class="picto-text">
                        <div class="picto-code">@item.GhsId</div>
                        <div class="picto-desc">@item.Descripcion</div>
                    </div>
                </div>
                <div class="picto-reactivos">
                    @if (item.Reactivos.Count == 0)
                    {
                        <div class="reactivos-empty">0 reactivos registrados</div>
                    }
                    else
                    {
                        <details class="reactivos-list">
                            <summary>
                                <span class="count">@item.Reactivos.Count</span>
                                <span>@(item.Reactivos.Count == 1 ? "reactivo" : "reactivos")</span>
                                <span class="hint">ver lista</span>
                            </summary>
                            <ul>
                                @foreach (var reactivo in item.Reactivos)
                                {
                                    <li>
                                        <NavLink href="@($"/inventario-sustancias/{reactivo.Id}")">
                                            @reactivo.Nombre
                                        </NavLink>
                                    </li>
                                }
                            </ul>
                        </details>
                    }
                </div>
            </article>
        }
    </div>

    @if (!string.IsNullOrWhiteSpace(loadError))
    {
        <p class="error-note">No se pudo cargar pictogramas: @loadError</p>
    }
</section>

@code {
    [Inject] private NpgsqlDataSource DataSource { get; set; } = default!;

    private readonly List<PictogramaRow> pictogramas = new();
    private string? loadError;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            const string sql = @"
                SELECT g.ghs_id,
                       g.descripcion,
                       COALESCE(g.icon_url, '') AS icon_url,
                       s.sustancia_id,
                       COALESCE(NULLIF(s.nombre_comercial, ''),
                                NULLIF(s.nombre_quimico, ''),
                                s.sustancia_id) AS nombre
                FROM ghs_pictogramas g
                LEFT JOIN sustancias_pictogramas sp ON sp.ghs_id = g.ghs_id
                LEFT JOIN sustancias s ON s.sustancia_id = sp.sustancia_id
                ORDER BY g.ghs_id, nombre
                ";
            await using var cmd = new NpgsqlCommand(sql, conn);
            await using var reader = await cmd.ExecuteReaderAsync();
            var map = new Dictionary<string, PictogramaRow>();
            while (await reader.ReadAsync())
            {
                var ghsId = reader.GetString(0);
                if (!map.TryGetValue(ghsId, out var row))
                {
                    row = new PictogramaRow(
                        ghsId,
                        reader.GetString(1),
                        reader.GetString(2)
                    );
                    map.Add(ghsId, row);
                    pictogramas.Add(row);
                }

                if (!reader.IsDBNull(3))
                {
                    row.AddReactivo(new ReactivoLink(
                        reader.GetString(3),
                        reader.GetString(4)
                    ));
                }
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private sealed class PictogramaRow
    {
        private readonly HashSet<string> reactivoIds = new();

        public PictogramaRow(string ghsId, string descripcion, string iconUrl)
        {
            GhsId = ghsId;
            Descripcion = descripcion;
            IconUrl = iconUrl;
        }

        public string GhsId { get; }
        public string Descripcion { get; }
        public string IconUrl { get; }
        public List<ReactivoLink> Reactivos { get; } = new();

        public void AddReactivo(ReactivoLink reactivo)
        {
            if (reactivoIds.Add(reactivo.Id))
            {
                Reactivos.Add(reactivo);
            }
        }
    }

    private sealed record ReactivoLink(string Id, string Nombre);
}

<style>
    .picto-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1rem;
    }

    .picto-card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        background: #fff;
        padding: 1rem;
        display: grid;
        gap: .75rem;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
    }

    .picto-main {
        display: flex;
        align-items: center;
        gap: .85rem;
    }

    .picto-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: .5rem;
        border-radius: 12px;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
    }

    .pictogram-icon {
        width: 44px;
        height: 44px;
        object-fit: contain;
    }

    .picto-code {
        font-weight: 700;
        letter-spacing: .3px;
        color: #0f172a;
    }

    .picto-desc {
        color: #475569;
        font-size: .95rem;
    }

    .picto-reactivos {
        border-top: 1px solid #eef2f7;
        padding-top: .6rem;
    }

    .reactivos-empty {
        font-size: .9rem;
        color: #64748b;
    }

    .reactivos-list summary {
        list-style: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: .4rem;
        font-weight: 600;
        color: #0f172a;
    }

    .reactivos-list summary::-webkit-details-marker {
        display: none;
    }

    .reactivos-list .hint {
        font-size: .8rem;
        font-weight: 500;
        color: #64748b;
        margin-left: auto;
    }

    .reactivos-list ul {
        margin: .6rem 0 0;
        padding-left: 1.1rem;
        display: grid;
        gap: .35rem;
    }

    .reactivos-list a {
        color: #1d4ed8;
        text-decoration: none;
    }

    .reactivos-list a:hover {
        text-decoration: underline;
    }

    .error-note { color:#b91c1c; margin-top:0.75rem; }
</style>
