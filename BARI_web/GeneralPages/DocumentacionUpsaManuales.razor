@page "/documentacion/upsa/manuales"
@using BARI_web.General_Services
@implements IDisposable

<PageTitle>Manuales UPSA</PageTitle>

<section class="page-card">
    <h2>Manuales UPSA</h2>
    <p>Listado general de manuales internos del laboratorio.</p>
    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Título</th>
                    <th>Archivo</th>
                    <th>URL</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var doc in documentos)
                {
                    <tr>
                        <td>@doc.Titulo</td>
                        <td>@doc.Archivo</td>
                        <td>
                            @if (!string.IsNullOrWhiteSpace(doc.Url))
                            {
                                <a href="@doc.Url" target="_blank" rel="noopener">Abrir</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!string.IsNullOrWhiteSpace(loadError))
    {
        <p class="error-note">No se pudo cargar manuales: @loadError</p>
    }
</section>

@code {
    [Inject] private NpgsqlDataSource DataSource { get; set; } = default!;
    [Inject] private LaboratorioState LaboratorioState { get; set; } = default!;

    private readonly List<DocRow> documentos = new();
    private string? loadError;

    protected override void OnInitialized()
    {
        LaboratorioState.OnChange += HandleLaboratorioChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDocumentosAsync();
    }

    private async void HandleLaboratorioChanged()
    {
        await LoadDocumentosAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadDocumentosAsync()
    {
        documentos.Clear();
        loadError = null;

        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            const string sql = @"
                SELECT d.titulo,
                       COALESCE(d.archivo_local, ''),
                       COALESCE(d.url, '')
                FROM documentos d
                LEFT JOIN categorias c ON c.categoria_id = d.categoria_id
                LEFT JOIN subcategorias s ON s.subcategoria_id = d.subcategoria_id
                WHERE c.nombre = 'UPSA'
                  AND s.nombre = 'Manual'
                  AND d.laboratorio_id = @laboratorio
                ORDER BY d.titulo
                ";
            await using var cmd = new NpgsqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("laboratorio", LaboratorioState.LaboratorioId);
            await using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                documentos.Add(new DocRow(
                    reader.GetString(0),
                    reader.GetString(1),
                    reader.GetString(2)
                ));
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private sealed record DocRow(string Titulo, string Archivo, string Url);

    public void Dispose()
    {
        LaboratorioState.OnChange -= HandleLaboratorioChanged;
    }
}

<style>
    .table-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { padding:0.6rem; border-bottom:1px solid #e5e7eb; text-align:left; }
    th { background:#f3f4f6; font-weight:600; }
    .error-note { color:#b91c1c; margin-top:0.75rem; }
</style>
