@page "/documentacion/instituciones"
@using BARI_web.General_Services
@using Npgsql
@inject LaboratorioState LaboratorioState
@implements IDisposable

<PageTitle>Documentación institucional</PageTitle>

<section class="page-card">
    <h2>Documentación institucional</h2>
    <p>
        Catálogos, fichas y referencias institucionales disponibles para el laboratorio.
    </p>
    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <div class="card-grid">
        <article class="doc-card">
            <h3>Documentos institucionales</h3>
            <p>Lineamientos, reglamentos y documentos generales de instituciones externas.</p>
            <NavLink class="btn-link" href="/documentacion/instituciones/documentos">Ver documentos</NavLink>
        </article>

        <article class="doc-card">
            <h3>Catálogo CAS</h3>
            <p>Listado de sustancias con número CAS asociado al laboratorio.</p>
            <NavLink class="btn-link" href="/documentacion/instituciones/cas">Ver CAS</NavLink>
        </article>

        @if (isQuimica)
        {
            <article class="doc-card">
                <h3>Pictogramas (GHS)</h3>
                <p>Señales de peligro químico usadas en reactivos del laboratorio.</p>
                <NavLink class="btn-link" href="/documentacion/instituciones/pictogramas">Ver pictogramas</NavLink>
            </article>

            <article class="doc-card">
                <h3>H-Codes</h3>
                <p>Frases de peligro asociadas a sustancias químicas.</p>
                <NavLink class="btn-link" href="/documentacion/instituciones/h-codes">Ver H-Codes</NavLink>
            </article>

            <article class="doc-card">
                <h3>P-Codes</h3>
                <p>Consejos de prudencia y medidas de seguridad.</p>
                <NavLink class="btn-link" href="/documentacion/instituciones/p-codes">Ver P-Codes</NavLink>
            </article>
        }
    </div>

    @if (!isQuimica)
    {
        <p class="note">Los listados GHS/H/P se muestran únicamente para el laboratorio de Química.</p>
    }
</section>

@code {
    [Inject] private NpgsqlDataSource DataSource { get; set; } = default!;

    private string? laboratorioNombre;
    private bool isQuimica;

    protected override void OnInitialized()
    {
        LaboratorioState.OnChange += HandleLaboratorioChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadLaboratorioAsync();
    }

    private async void HandleLaboratorioChanged()
    {
        await LoadLaboratorioAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadLaboratorioAsync()
    {
        await using var conn = await DataSource.OpenConnectionAsync();
        const string sqlLab = @"
            SELECT nombre
            FROM laboratorios
            WHERE laboratorio_id = @laboratorio
            ";
        await using var cmdLab = new NpgsqlCommand(sqlLab, conn);
        cmdLab.Parameters.AddWithValue("laboratorio", LaboratorioState.LaboratorioId);
        laboratorioNombre = (string?)await cmdLab.ExecuteScalarAsync();
        var labNombre = laboratorioNombre ?? string.Empty;
        isQuimica = LaboratorioState.LaboratorioId == 1
            || labNombre.Contains("quim", StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        LaboratorioState.OnChange -= HandleLaboratorioChanged;
    }
}

<style>
    .card-grid {
        display:grid;
        gap:1rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .doc-card {
        border:1px solid #e5e7eb;
        border-radius:0.8rem;
        padding:1rem;
        background:#fff;
        display:flex;
        flex-direction:column;
        gap:0.6rem;
    }
    .doc-card h3 { margin:0; color:#0b2a68; }
    .doc-card p { color:#475569; margin:0; }
    .btn-link {
        display:inline-flex;
        width:max-content;
        padding:0.35rem 0.6rem;
        border-radius:0.5rem;
        background:#0b2a68;
        color:#fff;
        text-decoration:none;
        font-size:0.85rem;
    }
    .btn-link:hover { background:#143a84; }
    .note { color:#64748b; margin-top:0.75rem; }
</style>
