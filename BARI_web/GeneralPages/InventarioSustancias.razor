@page "/inventario-sustancias"
@page "/inventario-sustancias/categoria/{SubcategoriaId}"
@using Npgsql
@using BARI_web.General_Services
@using System.Globalization
@inject NpgsqlDataSource DataSource
@inject LaboratorioState LaboratorioState
@inject NavigationManager Nav
@implements IDisposable

<PageTitle>Inventario de Sustancias</PageTitle>

<section class="page-card">
    <h2>Inventario de Sustancias</h2>
    <p>
        Aquí se gestionarán las sustancias y reactivos del laboratorio, incluyendo
        datos químicos, seguridad, pictogramas y stock disponible.
    </p>
    <LaboratorioSelector />
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <details>
        <summary style="cursor:pointer; font-weight:600;">Subir sustancia</summary>
        <div class="assign-row" style="margin-top:.75rem;">
            <input class="border p-1" placeholder="ID sustancia (opcional)" @bind="_nuevoSustanciaId" />
            <input class="border p-1" placeholder="Nombre comercial" @bind="_nuevoSustanciaNombreComercial" />
            <input class="border p-1" placeholder="Nombre químico" @bind="_nuevoSustanciaNombreQuimico" />
            <input class="border p-1" placeholder="CAS" @bind="_nuevoSustanciaCas" />
            <input class="border p-1" placeholder="Forma física" @bind="_nuevoSustanciaFormaFisica" />
            <input class="border p-1" placeholder="Subcategoría ID" @bind="_nuevoSustanciaSubcategoriaId" />
            <input class="border p-1" placeholder="Descripción" @bind="_nuevoSustanciaDescripcion" />
            <input class="border p-1" placeholder="Imagen URL" @bind="_nuevoSustanciaImagenUrl" />
            <input class="border p-1" placeholder="Observaciones" @bind="_nuevoSustanciaObservaciones" />
            <label class="text-sm text-gray-600">
                <input type="checkbox" @bind="_nuevoSustanciaControlada" /> Sustancia controlada
            </label>
            <button class="btn" @onclick="SubirSustanciaAsync">Subir sustancia</button>
            @if (!string.IsNullOrWhiteSpace(_nuevoSustanciaMsg))
            {
                <span class="text-sm text-gray-500">@_nuevoSustanciaMsg</span>
            }
        </div>
    </details>
</section>

<section class="page-card" style="margin-top:1rem;">
    <details>
        <summary style="cursor:pointer; font-weight:600;">Subir contenedor</summary>
        <div class="assign-row" style="margin-top:.75rem;">
            <input class="border p-1" placeholder="ID contenedor (opcional)" @bind="_nuevoContenedorId" />
            <select class="border p-1" @bind="_nuevoContenedorSustanciaId">
                <option value="">Selecciona sustancia</option>
                @foreach (var opt in sustanciasLookup)
                {
                    <option value="@opt.Id">@opt.Nombre</option>
                }
            </select>
            <input class="border p-1" placeholder="Marca ID" @bind="_nuevoContenedorMarcaId" />
            <input class="border p-1" placeholder="Densidad g/mL" @bind="_nuevoContenedorDensidad" />
            <input class="border p-1" placeholder="Proveedor" @bind="_nuevoContenedorProveedor" />
            <input class="border p-1" placeholder="Fecha compra (YYYY-MM-DD)" @bind="_nuevoContenedorFechaCompra" />
            <input class="border p-1" placeholder="Fecha recepción (YYYY-MM-DD)" @bind="_nuevoContenedorFechaRecepcion" />
            <input class="border p-1" placeholder="Fecha vencimiento (YYYY-MM-DD)" @bind="_nuevoContenedorFechaVencimiento" />
            <input class="border p-1" placeholder="Fecha apertura (YYYY-MM-DD)" @bind="_nuevoContenedorFechaApertura" />
            <input class="border p-1" placeholder="Masa envase vacío (g)" @bind="_nuevoContenedorMasaEnvase" />
            <input class="border p-1" placeholder="Masa tapa (g)" @bind="_nuevoContenedorMasaTapa" />
            <input class="border p-1" placeholder="Color envase" @bind="_nuevoContenedorColor" />
            <input class="border p-1" placeholder="Unidad ID" @bind="_nuevoContenedorUnidadId" />
            <input class="border p-1" placeholder="Cantidad nominal" @bind="_nuevoContenedorCantidadNominal" />
            <input class="border p-1" placeholder="Cantidad actual" @bind="_nuevoContenedorCantidad" />
            <input class="border p-1" placeholder="Condición ID" @bind="_nuevoContenedorCondicionId" />
            <input class="border p-1" placeholder="Observaciones" @bind="_nuevoContenedorObservaciones" />
            <input class="border p-1" placeholder="Área ID (opcional)" @bind="_nuevoContenedorAreaId" />
            <input class="border p-1" placeholder="Mesón ID (opcional)" @bind="_nuevoContenedorMesonId" />
            <input class="border p-1" placeholder="Nivel" @bind="_nuevoContenedorNivel" />
            <input class="border p-1" placeholder="Posición" @bind="_nuevoContenedorPosicion" />
            <input class="border p-1" placeholder="QR" @bind="_nuevoContenedorQr" />
            <button class="btn" @onclick="SubirContenedorAsync">Subir contenedor</button>
            @if (!string.IsNullOrWhiteSpace(_nuevoContenedorMsg))
            {
                <span class="text-sm text-gray-500">@_nuevoContenedorMsg</span>
            }
        </div>
    </details>
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <div class="category-header">
        <div>
            <h3>Guía base (reactivos químicos)</h3>
            <p class="helper">Selecciona una subcategoría para ver los reactivos disponibles.</p>
        </div>
        <div class="category-controls">
            <select class="category-select" @onchange="OnSubcategoriaChanged" value="@SubcategoriaId">
                <option value="">Todas las categorías</option>
                @foreach (var categoria in categorias)
                {
                    <optgroup label="@categoria.Nombre">
                        @foreach (var subcategoria in categoria.Subcategorias)
                        {
                            <option value="@subcategoria.Id">@subcategoria.Nombre</option>
                        }
                    </optgroup>
                }
            </select>
        </div>
        @if (!string.IsNullOrWhiteSpace(SubcategoriaId))
        {
            <NavLink class="btn-link" href="/inventario-sustancias">Ver todas las categorías</NavLink>
        }
    </div>

    @if (categorias.Count == 0)
    {
        <p><em>Cargando categorías…</em></p>
    }
    else
    {
        <div class="category-grid">
            @foreach (var categoria in categorias)
            {
                <div class="category-card">
                    <div class="category-title">@categoria.Nombre</div>
                    <ul class="category-list">
                        @foreach (var subcategoria in categoria.Subcategorias)
                        {
                            <li>
                                <NavLink href="@($"/inventario-sustancias/categoria/{subcategoria.Id}")" class="category-link">
                                    @subcategoria.Nombre
                                </NavLink>
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>
    }
</section>

<section class="page-card" style="margin-top:1.5rem;">
    <div class="materials-header">
        <h3>@(string.IsNullOrWhiteSpace(SubcategoriaId) ? "Reactivos disponibles" : $"Reactivos · {subcategoriaNombre ?? SubcategoriaId}")</h3>
        @if (!string.IsNullOrWhiteSpace(SubcategoriaId))
        {
            <span class="badge">@sustancias.Count reactivos</span>
        }
    </div>

    @if (!string.IsNullOrWhiteSpace(loadError))
    {
        <p class="error-note">No se pudieron cargar reactivos: @loadError</p>
    }
    else if (string.IsNullOrWhiteSpace(SubcategoriaId))
    {
        <p class="helper">Elige una subcategoría para ver los reactivos asociados.</p>
    }
    else if (sustancias.Count == 0)
    {
        <div class="empty">
            No hay reactivos registrados para esta subcategoría.
        </div>
    }
    else
    {
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Reactivo</th>
                        <th>CAS</th>
                        <th>Categoría</th>
                        <th>Subcategoría</th>
                        <th>Ubicación</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var sustancia in sustancias)
                    {
                        <tr>
                            <td>@sustancia.Id</td>
                            <td>
                                <NavLink href="@($"/inventario-sustancias/{sustancia.Id}")">
                                    @sustancia.Nombre
                                </NavLink>
                            </td>
                            <td>@sustancia.Cas</td>
                            <td>@sustancia.Categoria</td>
                            <td>@sustancia.Subcategoria</td>
                            <td>@sustancia.Ubicacion</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</section>

@code {
    [Parameter] public string? SubcategoriaId { get; set; }

    private readonly List<CategoriaRow> categorias = new();
    private readonly List<SustanciaRow> sustancias = new();
    private string? subcategoriaNombre;
    private string? loadError;
    private string? _nuevoSustanciaId;
    private string? _nuevoSustanciaNombreComercial;
    private string? _nuevoSustanciaNombreQuimico;
    private string? _nuevoSustanciaCas;
    private string? _nuevoSustanciaFormaFisica;
    private string? _nuevoSustanciaSubcategoriaId;
    private string? _nuevoSustanciaDescripcion;
    private string? _nuevoSustanciaImagenUrl;
    private string? _nuevoSustanciaObservaciones;
    private bool _nuevoSustanciaControlada;
    private string? _nuevoContenedorId;
    private string? _nuevoContenedorSustanciaId;
    private string? _nuevoContenedorMarcaId;
    private string? _nuevoContenedorDensidad;
    private string? _nuevoContenedorProveedor;
    private string? _nuevoContenedorFechaCompra;
    private string? _nuevoContenedorFechaRecepcion;
    private string? _nuevoContenedorFechaVencimiento;
    private string? _nuevoContenedorFechaApertura;
    private string? _nuevoContenedorMasaEnvase;
    private string? _nuevoContenedorMasaTapa;
    private string? _nuevoContenedorColor;
    private string? _nuevoContenedorUnidadId;
    private string? _nuevoContenedorCantidadNominal;
    private string? _nuevoContenedorCantidad;
    private string? _nuevoContenedorCondicionId;
    private string? _nuevoContenedorObservaciones;
    private string? _nuevoContenedorAreaId;
    private string? _nuevoContenedorMesonId;
    private string? _nuevoContenedorNivel;
    private string? _nuevoContenedorPosicion;
    private string? _nuevoContenedorQr;
    private string? _nuevoSustanciaMsg;
    private string? _nuevoContenedorMsg;
    private readonly List<SustanciaLookup> sustanciasLookup = new();

    protected override void OnInitialized()
    {
        LaboratorioState.OnChange += HandleLaboratorioChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        loadError = null;
        await LoadCategoriasAsync();
        await LoadSustanciasAsync();
        await LoadSustanciasLookupAsync();
    }

    private async void HandleLaboratorioChanged()
    {
        await LoadSustanciasAsync();
        await LoadSustanciasLookupAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SubirSustanciaAsync()
    {
        var sustanciaId = string.IsNullOrWhiteSpace(_nuevoSustanciaId)
            ? $"sus_{Guid.NewGuid():N}".Substring(0, 12)
            : _nuevoSustanciaId!.Trim();

        await using var conn = await DataSource.OpenConnectionAsync();
        const string sqlSust = @"
            INSERT INTO sustancias
            (sustancia_id, nombre_comercial, nombre_quimico, cas, forma_fisica, sustancia_controlada,
             subcategoria_id, descripcion, imagen_url, observaciones, laboratorio_id)
            VALUES (@id, @comercial, @quimico, @cas, @forma, @controlada,
                    @subcat, @descripcion, @imagen, @obs, @lab)
            ON CONFLICT (sustancia_id) DO NOTHING";
        await using (var cmd = new NpgsqlCommand(sqlSust, conn))
        {
            cmd.Parameters.AddWithValue("id", sustanciaId);
            cmd.Parameters.AddWithValue("comercial", string.IsNullOrWhiteSpace(_nuevoSustanciaNombreComercial) ? (object)DBNull.Value : _nuevoSustanciaNombreComercial!);
            cmd.Parameters.AddWithValue("quimico", string.IsNullOrWhiteSpace(_nuevoSustanciaNombreQuimico) ? (object)DBNull.Value : _nuevoSustanciaNombreQuimico!);
            cmd.Parameters.AddWithValue("cas", string.IsNullOrWhiteSpace(_nuevoSustanciaCas) ? (object)DBNull.Value : _nuevoSustanciaCas!);
            cmd.Parameters.AddWithValue("forma", string.IsNullOrWhiteSpace(_nuevoSustanciaFormaFisica) ? (object)DBNull.Value : _nuevoSustanciaFormaFisica!);
            cmd.Parameters.AddWithValue("controlada", _nuevoSustanciaControlada);
            cmd.Parameters.AddWithValue("subcat", string.IsNullOrWhiteSpace(_nuevoSustanciaSubcategoriaId) ? (object)DBNull.Value : _nuevoSustanciaSubcategoriaId!);
            cmd.Parameters.AddWithValue("descripcion", string.IsNullOrWhiteSpace(_nuevoSustanciaDescripcion) ? (object)DBNull.Value : _nuevoSustanciaDescripcion!);
            cmd.Parameters.AddWithValue("imagen", string.IsNullOrWhiteSpace(_nuevoSustanciaImagenUrl) ? (object)DBNull.Value : _nuevoSustanciaImagenUrl!);
            cmd.Parameters.AddWithValue("obs", string.IsNullOrWhiteSpace(_nuevoSustanciaObservaciones) ? (object)DBNull.Value : _nuevoSustanciaObservaciones!);
            cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);
            await cmd.ExecuteNonQueryAsync();
        }

        _nuevoSustanciaId = null;
        _nuevoSustanciaNombreComercial = null;
        _nuevoSustanciaNombreQuimico = null;
        _nuevoSustanciaCas = null;
        _nuevoSustanciaFormaFisica = null;
        _nuevoSustanciaSubcategoriaId = null;
        _nuevoSustanciaDescripcion = null;
        _nuevoSustanciaImagenUrl = null;
        _nuevoSustanciaObservaciones = null;
        _nuevoSustanciaControlada = false;
        _nuevoSustanciaMsg = "Sustancia registrada.";
        await LoadSustanciasLookupAsync();
    }

    private async Task SubirContenedorAsync()
    {
        if (string.IsNullOrWhiteSpace(_nuevoContenedorSustanciaId))
        {
            _nuevoContenedorMsg = "Selecciona una sustancia.";
            return;
        }

        var contenedorId = string.IsNullOrWhiteSpace(_nuevoContenedorId)
            ? $"cont_{Guid.NewGuid():N}".Substring(0, 12)
            : _nuevoContenedorId!.Trim();

        await using var conn = await DataSource.OpenConnectionAsync();
        const string sqlCont = @"
            INSERT INTO contenedores
            (cont_id, sustancia_id, marca_id, densidad_g_ml, fecha_compra, proveedor, fecha_recepcion, fecha_vencimiento,
             masa_envase_vacio_g, masa_tapa_g, color_envase, unidad_id, cantidad_reactivo_nominal,
             cantidad_reactivo_actual, fecha_apertura, condicion_id, observaciones, area_id, meson_id, nivel, posicion,
             laboratorio_id, qr)
            VALUES (@cont, @sus, @marca, @densidad, @fcompra, @proveedor, @frecep, @fvenc,
                    @menvase, @mtapa, @color, @unidad, @nominal,
                    @actual, @fapertura, @cond, @obs, @area, @meson, @nivel, @posicion,
                    @lab, @qr)";
        await using var cmd = new NpgsqlCommand(sqlCont, conn);
        cmd.Parameters.AddWithValue("cont", contenedorId);
        cmd.Parameters.AddWithValue("sus", _nuevoContenedorSustanciaId!);
        cmd.Parameters.AddWithValue("marca", string.IsNullOrWhiteSpace(_nuevoContenedorMarcaId) ? (object)DBNull.Value : _nuevoContenedorMarcaId!);
        cmd.Parameters.AddWithValue("densidad", ParseDecimalOrNull(_nuevoContenedorDensidad));
        cmd.Parameters.AddWithValue("fcompra", ParseDateOrNull(_nuevoContenedorFechaCompra));
        cmd.Parameters.AddWithValue("proveedor", string.IsNullOrWhiteSpace(_nuevoContenedorProveedor) ? (object)DBNull.Value : _nuevoContenedorProveedor!);
        cmd.Parameters.AddWithValue("frecep", ParseDateOrNull(_nuevoContenedorFechaRecepcion));
        cmd.Parameters.AddWithValue("fvenc", ParseDateOrNull(_nuevoContenedorFechaVencimiento));
        cmd.Parameters.AddWithValue("menvase", ParseDecimalOrNull(_nuevoContenedorMasaEnvase));
        cmd.Parameters.AddWithValue("mtapa", ParseDecimalOrNull(_nuevoContenedorMasaTapa));
        cmd.Parameters.AddWithValue("color", string.IsNullOrWhiteSpace(_nuevoContenedorColor) ? (object)DBNull.Value : _nuevoContenedorColor!);
        cmd.Parameters.AddWithValue("unidad", string.IsNullOrWhiteSpace(_nuevoContenedorUnidadId) ? (object)DBNull.Value : _nuevoContenedorUnidadId!);
        cmd.Parameters.AddWithValue("nominal", ParseDecimalOrNull(_nuevoContenedorCantidadNominal));
        cmd.Parameters.AddWithValue("actual", ParseDecimalOrNull(_nuevoContenedorCantidad));
        cmd.Parameters.AddWithValue("fapertura", ParseDateOrNull(_nuevoContenedorFechaApertura));
        cmd.Parameters.AddWithValue("cond", string.IsNullOrWhiteSpace(_nuevoContenedorCondicionId) ? (object)DBNull.Value : _nuevoContenedorCondicionId!);
        cmd.Parameters.AddWithValue("obs", string.IsNullOrWhiteSpace(_nuevoContenedorObservaciones) ? (object)DBNull.Value : _nuevoContenedorObservaciones!);
        cmd.Parameters.AddWithValue("area", string.IsNullOrWhiteSpace(_nuevoContenedorAreaId) ? (object)DBNull.Value : _nuevoContenedorAreaId!);
        cmd.Parameters.AddWithValue("meson", string.IsNullOrWhiteSpace(_nuevoContenedorMesonId) ? (object)DBNull.Value : _nuevoContenedorMesonId!);
        cmd.Parameters.AddWithValue("nivel", ParseIntOrNull(_nuevoContenedorNivel));
        cmd.Parameters.AddWithValue("posicion", string.IsNullOrWhiteSpace(_nuevoContenedorPosicion) ? (object)DBNull.Value : _nuevoContenedorPosicion!);
        cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);
        cmd.Parameters.AddWithValue("qr", string.IsNullOrWhiteSpace(_nuevoContenedorQr) ? (object)DBNull.Value : _nuevoContenedorQr!);
        await cmd.ExecuteNonQueryAsync();

        _nuevoContenedorId = null;
        _nuevoContenedorSustanciaId = null;
        _nuevoContenedorMarcaId = null;
        _nuevoContenedorDensidad = null;
        _nuevoContenedorProveedor = null;
        _nuevoContenedorFechaCompra = null;
        _nuevoContenedorFechaRecepcion = null;
        _nuevoContenedorFechaVencimiento = null;
        _nuevoContenedorFechaApertura = null;
        _nuevoContenedorMasaEnvase = null;
        _nuevoContenedorMasaTapa = null;
        _nuevoContenedorColor = null;
        _nuevoContenedorUnidadId = null;
        _nuevoContenedorCantidadNominal = null;
        _nuevoContenedorCantidad = null;
        _nuevoContenedorCondicionId = null;
        _nuevoContenedorObservaciones = null;
        _nuevoContenedorAreaId = null;
        _nuevoContenedorMesonId = null;
        _nuevoContenedorNivel = null;
        _nuevoContenedorPosicion = null;
        _nuevoContenedorQr = null;
        _nuevoContenedorMsg = "Contenedor registrado.";
    }

    private static object ParseDecimalOrNull(string? value)
    {
        return decimal.TryParse(value, NumberStyles.Any, CultureInfo.InvariantCulture, out var d)
            ? d
            : DBNull.Value;
    }

    private static object ParseIntOrNull(string? value)
    {
        return int.TryParse(value, out var i)
            ? i
            : DBNull.Value;
    }

    private static object ParseDateOrNull(string? value)
    {
        return DateTime.TryParse(value, out var d)
            ? d
            : DBNull.Value;
    }

    private async Task LoadSustanciasLookupAsync()
    {
        sustanciasLookup.Clear();
        await using var conn = await DataSource.OpenConnectionAsync();
        const string sql = @"
            SELECT sustancia_id,
                   COALESCE(NULLIF(nombre_comercial, ''), NULLIF(nombre_quimico, ''), sustancia_id)
            FROM sustancias
            WHERE laboratorio_id = @lab
            ORDER BY 2";
        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("lab", LaboratorioState.LaboratorioId);
        await using var reader = await cmd.ExecuteReaderAsync();
        while (await reader.ReadAsync())
        {
            sustanciasLookup.Add(new SustanciaLookup(reader.GetString(0), reader.GetString(1)));
        }
    }

    private sealed record SustanciaLookup(string Id, string Nombre);

    private static readonly string[] CategoriaPermitidas =
    [
        "Reactivo Químico"
    ];

    private async Task LoadCategoriasAsync()
    {
        if (categorias.Count > 0) return;

        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            const string sql = @"
                SELECT c.categoria_id, c.nombre,
                       s.subcategoria_id, s.nombre
                FROM categorias c
                LEFT JOIN subcategorias s ON s.categoria_id = c.categoria_id
                WHERE c.nombre = ANY(@categorias)
                ORDER BY c.nombre, s.nombre
                ";
            await using var cmd = new NpgsqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("categorias", CategoriaPermitidas);
            await using var reader = await cmd.ExecuteReaderAsync();
            var map = new Dictionary<string, CategoriaRow>();
            while (await reader.ReadAsync())
            {
                var categoriaId = reader.GetString(0);
                if (!map.TryGetValue(categoriaId, out var categoria))
                {
                    categoria = new CategoriaRow(categoriaId, reader.GetString(1));
                    map.Add(categoriaId, categoria);
                    categorias.Add(categoria);
                }

                if (!reader.IsDBNull(2))
                {
                    categoria.Subcategorias.Add(new SubcategoriaRow(
                        reader.GetString(2),
                        reader.GetString(3)
                    ));
                }
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private async Task LoadSustanciasAsync()
    {
        sustancias.Clear();
        subcategoriaNombre = null;

        if (string.IsNullOrWhiteSpace(SubcategoriaId))
        {
            return;
        }

        try
        {
            await using var conn = await DataSource.OpenConnectionAsync();
            const string sqlSubcategoria = @"
                SELECT nombre
                FROM subcategorias
                WHERE subcategoria_id = @subcategoria
                ";
            await using (var cmdName = new NpgsqlCommand(sqlSubcategoria, conn))
            {
                cmdName.Parameters.AddWithValue("subcategoria", SubcategoriaId);
                var nombre = await cmdName.ExecuteScalarAsync();
                subcategoriaNombre = nombre?.ToString();
            }

            const string sql = @"
                SELECT s.sustancia_id,
                       COALESCE(NULLIF(s.nombre_comercial, ''),
                                NULLIF(s.nombre_quimico, ''),
                                s.sustancia_id) AS nombre,
                       COALESCE(s.cas, '') AS cas,
                       COALESCE(c.nombre, '') AS categoria,
                       COALESCE(sc.nombre, '') AS subcategoria,
                       COALESCE(a.nombre_areas, '') AS area,
                       COALESCE(m.nombre_meson, '') AS meson,
                       COALESCE(cn.posicion, '') AS posicion
                FROM sustancias s
                LEFT JOIN subcategorias sc ON sc.subcategoria_id = s.subcategoria_id
                LEFT JOIN categorias c ON c.categoria_id = sc.categoria_id
                LEFT JOIN contenedores cn ON cn.sustancia_id = s.sustancia_id
                LEFT JOIN areas a ON a.area_id = cn.area_id
                LEFT JOIN mesones m ON m.meson_id = cn.meson_id
                WHERE s.subcategoria_id = @subcategoria
                  AND s.laboratorio_id = @laboratorio
                  AND c.nombre = ANY(@categorias)
                ORDER BY nombre, s.sustancia_id
                ";
            await using var cmd = new NpgsqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("subcategoria", SubcategoriaId);
            cmd.Parameters.AddWithValue("laboratorio", LaboratorioState.LaboratorioId);
            cmd.Parameters.AddWithValue("categorias", CategoriaPermitidas);
            await using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                sustancias.Add(new SustanciaRow(
                    reader.GetString(0),
                    reader.GetString(1),
                    reader.GetString(2),
                    reader.GetString(3),
                    reader.GetString(4),
                    BuildUbicacion(reader.GetString(5), reader.GetString(6), reader.GetString(7))
                ));
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private static string BuildUbicacion(string area, string meson, string posicion)
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(area)) parts.Add(area);
        if (!string.IsNullOrWhiteSpace(meson)) parts.Add(meson);
        if (!string.IsNullOrWhiteSpace(posicion)) parts.Add(posicion);
        return parts.Count == 0 ? "Sin ubicación" : string.Join(" · ", parts);
    }

    private sealed class CategoriaRow
    {
        public CategoriaRow(string id, string nombre)
        {
            Id = id;
            Nombre = nombre;
        }

        public string Id { get; }
        public string Nombre { get; }
        public List<SubcategoriaRow> Subcategorias { get; } = new();
    }

    private sealed record SubcategoriaRow(string Id, string Nombre);

    private sealed record SustanciaRow(
        string Id,
        string Nombre,
        string Cas,
        string Categoria,
        string Subcategoria,
        string Ubicacion);

    private void OnSubcategoriaChanged(ChangeEventArgs args)
    {
        var value = args.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            Nav.NavigateTo("/inventario-sustancias");
            return;
        }

        Nav.NavigateTo($"/inventario-sustancias/categoria/{value}");
    }

    public void Dispose()
    {
        LaboratorioState.OnChange -= HandleLaboratorioChanged;
    }
}

<style>
    .category-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
    }

    .category-controls {
        display: flex;
        gap: .75rem;
        align-items: center;
    }

    .category-select {
        min-width: 220px;
        padding: .35rem .6rem;
        border-radius: 8px;
        border: 1px solid #cbd5f5;
        background: #fff;
        color: #0f172a;
    }

    .helper {
        margin: .3rem 0 0;
        color: #475569;
        font-size: .95rem;
    }

    .btn-link {
        color: #1d4ed8;
        text-decoration: none;
        font-weight: 600;
    }

    .btn-link:hover {
        text-decoration: underline;
    }

    .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .category-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
        padding: 1rem;
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.04);
    }

    .category-title {
        font-weight: 700;
        color: #0f172a;
        margin-bottom: .5rem;
    }

    .category-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: .35rem;
    }

    .category-link {
        display: inline-flex;
        padding: .35rem .6rem;
        border-radius: 999px;
        background: #f1f5f9;
        color: #0f172a;
        text-decoration: none;
        font-size: .9rem;
    }

    .category-link.active,
    .category-link:hover {
        background: #dbeafe;
        color: #1d4ed8;
    }

    .materials-header {
        display: flex;
        align-items: center;
        gap: .75rem;
    }

    .badge {
        background: #e2e8f0;
        color: #0f172a;
        padding: .2rem .55rem;
        border-radius: 999px;
        font-size: .85rem;
        font-weight: 600;
    }

    .empty {
        padding: .85rem 1rem;
        border-radius: 10px;
        background: #fef9c3;
        border: 1px solid #fde68a;
        color: #854d0e;
    }

    .assign-row {
        display:flex;
        flex-wrap:wrap;
        gap:0.5rem;
        align-items:center;
        margin-top:0.5rem;
    }

    .table-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { padding:0.6rem; border-bottom:1px solid #e5e7eb; text-align:left; }
    th { background:#f3f4f6; font-weight:600; }
    .error-note { color:#b91c1c; margin-top:0.75rem; }
</style>
