@page "/detalles/{AreaSlug}"
@namespace BARI_web.Features.Espacios.Pages

<div class="areas-wrap">
    <div class="toolbar">
        <div class="toolbar-left">
            <h2 class="toolbar-title">Detalles del Área: @(_areaInfo?.nombre ?? AreaSlug)</h2>
        </div>

        <div class="toolbar-actions">
            <button type="button" class="btn" @onclick="@(()=>Nav.NavigateTo("/areas"))">
                ← Volver al mapa
            </button>
            <button type="button" class="btn primary"
                    @onclick="@(()=>Nav.NavigateTo($"/modificar-detalles/{AreaSlug}"))">
                ✏️ Editar instalaciones / mesones
            </button>
        </div>
    </div>

    @if (_canvas is null)
    {
        <p class="muted">Cargando...</p>
    }
    else
    {
        <div class="map-frame">
            <svg class="map-svg"
                 width="100%" height="100%"
                 viewBox="@ViewBox()"
                 preserveAspectRatio="xMidYMid meet"
                 style="background:#fafafa">

                <!-- fondo -->
                <rect x="@S(VX)" y="@S(VY)" width="@S(VW)" height="@S(VH)"
                      fill="white" stroke="#ddd" stroke-width="@S(0.03m)" />

                <!-- grilla -->
                @for (var gx = GridStartX; gx <= GridEndX; gx += 1m)
                {
                    <line x1="@S(gx)" y1="@S(VY)" x2="@S(gx)" y2="@S(VY + VH)"
                          stroke="#f1f1f1" stroke-width="@S(0.02m)" />
                }
                @for (var gy = GridStartY; gy <= GridEndY; gy += 1m)
                {
                    <line x1="@S(VX)" y1="@S(gy)" x2="@S(VX + VW)" y2="@S(gy)"
                          stroke="#f1f1f1" stroke-width="@S(0.02m)" />
                }

                @if (_area is not null)
                {
                    <!-- clip del área + clips por cada inner -->
                    <defs>
                        <clipPath id="clip_target" clipPathUnits="userSpaceOnUse">
                            @foreach (var p in _area.Polys)
                            {
                                if (p.puntos.Count >= 3)
                                {
                                    <polygon points="@PointsString(p)" />
                                }
                                else
                                {
                                    <rect x="@S(p.x_m)" y="@S(p.y_m)" width="@S(p.ancho_m)" height="@S(p.largo_m)" />
                                }
                            }
                        </clipPath>

                        @foreach (var b in _blocks)
                        {
                            <clipPath id="@($"clip_blk_{b.bloque_id}")" clipPathUnits="userSpaceOnUse">
                                <rect x="@S(b.abs_x)" y="@S(b.abs_y)" width="@S(b.ancho)" height="@S(b.largo)" />
                            </clipPath>
                        }


                        @foreach (var inn in _inners)
                        {
                            <clipPath id="@($"clip_in_{inn.poly_in_id}")" clipPathUnits="userSpaceOnUse">
                                <rect x="@S(inn.abs_x)" y="@S(inn.abs_y)" width="@S(inn.ancho_m)" height="@S(inn.largo_m)" />
                            </clipPath>
                        }
                    </defs>

                    <!-- relleno -->
                    <g class="softshadow" clip-path="url(#clip_target)">
                        @foreach (var p in _area.Polys)
                        {
                            if (p.puntos.Count >= 3)
                            {
                                <polygon points="@PointsString(p)" fill="@_area.Fill" />
                            }
                            else
                            {
                                <rect x="@S(p.x_m)" y="@S(p.y_m)"
                                      width="@S(p.ancho_m)" height="@S(p.largo_m)"
                                      fill="@_area.Fill" />
                            }
                        }
                    </g>

                    <!-- contorno -->
                    @foreach (var seg in _area.Outline)
                    {
                        <line x1="@S(seg.x1)" y1="@S(seg.y1)" x2="@S(seg.x2)" y2="@S(seg.y2)"
                              stroke="#000" stroke-width="@S(OutlineStroke)"
                              vector-effect="non-scaling-stroke" />
                    }

                    <!-- bloques internos (clic + hover) -->
                    @foreach (var b in _blocks.OrderBy(b => b.z_order))
                    {
                        var blockLabel = BlockLabel(b);
                        var labelWidth = Math.Max(0.2m, b.ancho - 0.1m);
                        var labelFont = Math.Max(0.22m, Math.Min(0.6m, b.largo * 0.4m));

                        // si es mesón o instalación => es clickeable
                        var isClickable = !string.IsNullOrWhiteSpace(b.meson_id) || !string.IsNullOrWhiteSpace(b.instalacion_id);
                        var gClass = $"map-block {(isClickable ? "is-clickable" : "")}";

                        <g class="@gClass"
                           @onclick="(() => { if (isClickable) OnBlockClick(b); })">

                            @if (!string.IsNullOrWhiteSpace(blockLabel))
                            {
                                <title>@blockLabel</title>
                            }

                            <rect class="block-rect"
                                  x="@S(b.abs_x)" y="@S(b.abs_y)"
                                  width="@S(b.ancho)" height="@S(b.largo)"
                                  fill="@b.color_hex" opacity="0.45"
                                  stroke="#1f2937"
                                  vector-effect="non-scaling-stroke"
                                  style="pointer-events:all" />

                            @if (!string.IsNullOrWhiteSpace(blockLabel))
{
    var rotate = ShouldRotate(b.ancho, b.largo);
    var tl = rotate
        ? LayoutLabel(blockLabel, b.largo, b.ancho) // 👈 al rotar, el “ancho útil” pasa a ser el largo
        : LayoutLabel(blockLabel, b.ancho, b.largo);

    if (tl.Lines.Count > 0)
    {
        var cx = b.abs_x + (b.ancho / 2m);
        var cy = b.abs_y + (b.largo / 2m);

        var dy = tl.FontSize * tl.LineHeight;
        var totalH = tl.Lines.Count * dy;
        var firstBaseline = (-totalH / 2m) + (tl.FontSize * 0.85m);

        if (!rotate)
        {
            <svg:text class="block-text"
                  text-anchor="middle"
                  font-size="@S(tl.FontSize)" fill="#111"
                  style="pointer-events:none; user-select:none;">
                <tspan x="@S(cx)" y="@S(cy + firstBaseline)">@tl.Lines[0]</tspan>
                @for (var i = 1; i < tl.Lines.Count; i++)
                {
                    <tspan x="@S(cx)" dy="@S(dy)">@tl.Lines[i]</tspan>
                }
            </svg:text>
        }
        else
        {
            <g transform="translate(@S(cx),@S(cy)) rotate(-90)">
                <text class="block-text"
                      text-anchor="middle"
                      font-size="@S(tl.FontSize)" fill="#111"
                      style="pointer-events:none; user-select:none;">
                    <tspan x="0" y="@S(firstBaseline)">@tl.Lines[0]</tspan>
                    @for (var i = 1; i < tl.Lines.Count; i++)
                    {
                        <tspan x="0" dy="@S(dy)">@tl.Lines[i]</tspan>
                    }
                </text>
            </g>
        }
    }
}


                        </g>
                    }

                    <!-- elementos interiores -->
                    @foreach (var it in _inners)
                    {
                        <rect x="@S(it.abs_x)" y="@S(it.abs_y)"
                              width="@S(it.ancho_m)" height="@S(it.largo_m)"
                              fill="@it.fill" opacity="@S(it.opacidad)" />

                        @if (!string.IsNullOrWhiteSpace(it.label))
                        {
                            var anchoTexto = it.ancho_m - 0.25m;
                            if (anchoTexto < 0.15m) anchoTexto = 0.15m;

                            <g clip-path="url(#clip_in_@it.poly_in_id)">
    @{
        var label = it.label.ToUpperInvariant();
        var rotate = ShouldRotate(it.ancho_m, it.largo_m);
        var tl = rotate
            ? LayoutLabel(label, it.largo_m, it.ancho_m)
            : LayoutLabel(label, it.ancho_m, it.largo_m);

        if (tl.Lines.Count > 0)
        {
            var cx = it.abs_x + (it.ancho_m / 2m);
            var cy = it.abs_y + (it.largo_m / 2m);

            var dy = tl.FontSize * tl.LineHeight;
            var totalH = tl.Lines.Count * dy;
            var firstBaseline = (-totalH / 2m) + (tl.FontSize * 0.85m);

            if (!rotate)
            {
                <svg:text class="area-label"
                      text-anchor="middle"
                      font-size="@S(tl.FontSize)" fill="#111"
                      style="pointer-events:none; user-select:none;">
                    <tspan x="@S(cx)" y="@S(cy + firstBaseline)">@tl.Lines[0]</tspan>
                    @for (var i = 1; i < tl.Lines.Count; i++)
                    {
                        <tspan x="@S(cx)" dy="@S(dy)">@tl.Lines[i]</tspan>
                    }
                </svg:text>
            }
            else
            {
                <g transform="translate(@S(cx),@S(cy)) rotate(-90)">
                    <text class="area-label"
                          text-anchor="middle"
                          font-size="@S(tl.FontSize)" fill="#111"
                          style="pointer-events:none; user-select:none;">
                        <tspan x="0" y="@S(firstBaseline)">@tl.Lines[0]</tspan>
                        @for (var i = 1; i < tl.Lines.Count; i++)
                        {
                            <tspan x="0" dy="@S(dy)">@tl.Lines[i]</tspan>
                        }
                    </text>
                </g>
            }
        }
    }
</g>

                        }
                    }

                    <!-- puertas -->
                    @foreach (var d in _doors)
                    {
                        <line x1="@S(d.x_m)" y1="@S(d.y_m)"
                              x2="@S(DoorEndX(d))" y2="@S(DoorEndY(d))"
                              stroke="#13A076" stroke-width="@S(0.10m)" stroke-linecap="round" />
                    }

                    <!-- ventanas -->
                    @foreach (var w in _windows)
                    {
                        <line x1="@S(w.x_m)" y1="@S(w.y_m)"
                              x2="@S(WinEndX(w))" y2="@S(WinEndY(w))"
                              stroke="#66CCFF" stroke-width="@S(0.06m)" stroke-linecap="round" />
                    }
                }
                else
                {
                    <text>
                        <tspan x="@S(VX + VW/2m)" y="@S(VY + VH/2m)"
                               style="text-anchor:middle;dominant-baseline:middle"
                               font-size="@S(0.6m)">
                            Area no encontrada: @AreaSlug
                        </tspan>
                    </text>
                }
            </svg>
        </div>

        @if (_areaInfo is not null)
        {
            <div class="card">
                <h3 style="margin:0 0 .5rem 0">Información del área</h3>
                <div class="info-grid">
                    <div>
                        <strong>Nombre</strong>
                        <div>@_areaInfo.nombre</div>
                    </div>
                    <div>
                        <strong>Altura</strong>
                        <div>@(_areaInfo.altura_m is null ? "—" : $"{_areaInfo.altura_m} m")</div>
                    </div>
                    <div>
                        <strong>Área total</strong>
                        <div>@(_areaInfo.area_total_m2 is null ? "—" : $"{_areaInfo.area_total_m2} m²")</div>
                    </div>
                    <div>
                        <strong>Planta</strong>
                        <div>@(_areaInfo.planta_id ?? "—")</div>
                    </div>
                </div>
                @if (!string.IsNullOrWhiteSpace(_areaInfo.anotaciones))
                {
                    <div style="margin-top:.5rem; color:#4b5563">@_areaInfo.anotaciones</div>
                }
            </div>
        }

        <!-- === Panel de listas: Mesones e Instalaciones === -->
        <div class="card">
            <details open>
                <summary style="cursor:pointer; font-weight:700">
                    Mesones (@_mesones.Count)
                </summary>
                <ul style="list-style:none; padding-left:0; margin:.5rem 0 0">
                    @if (_mesones.Count == 0)
                    {
                        <li class="muted"><em>Sin mesones.</em></li>
                    }
                    else
                    {
                        @foreach (var m in _mesones)
                        {
                            <li style="display:flex; align-items:center; justify-content:space-between; padding:.35rem 0; border-bottom:1px dashed #eee">
                                <div>
                                    <strong>@MesonNameForDisplay(m)</strong>
                                    <div style="font-size:.85rem; color:#6b7280">
                                        Reactivos: @m.reactivos_count · Equipos: @m.equipos_count
                                    </div>
                                </div>
                                <button type="button" class="btn link"
                                        @onclick="@(() => Nav.NavigateTo($"/inventario-mesones/item/{m.meson_id}"))">
                                    ver
                                </button>
                            </li>
                        }
                    }
                </ul>
            </details>

            <details open style="margin-top:.75rem">
                <summary style="cursor:pointer; font-weight:700">
                    Instalaciones (@_instalaciones.Count)
                </summary>

                <div class="assign-row" style="margin-top:.5rem">
                    <select class="field" @bind="_selectedInstalacionId">
                        <option value="">Selecciona instalación</option>
                        @foreach (var opt in _instalacionesDisponibles)
                        {
                            <option value="@opt.id">@opt.label</option>
                        }
                    </select>
                    <button class="btn"
                            @onclick="AssignInstalacionAsync"
                            disabled="@string.IsNullOrWhiteSpace(_selectedInstalacionId)">
                        Asignar
                    </button>
                </div>

                <ul style="list-style:none; padding-left:0; margin:.5rem 0 0">
                    @if (_instalaciones.Count == 0)
                    {
                        <li class="muted"><em>Sin instalaciones.</em></li>
                    }
                    else
                    {
                        @foreach (var item in _instalaciones)
                        {
                            <li style="padding:.5rem 0; border-bottom:1px dashed #eee">
                                <div style="display:flex; justify-content:space-between; gap:.75rem; align-items:center">
                                    <div>
                                        <strong>@item.nombre</strong>
                                        <div style="color:#4b5563; font-size:.9rem; margin-top:.15rem">
                                            @item.detalle
                                        </div>
                                    </div>
                                    <button type="button" class="btn link"
                                            @onclick='@(() => Nav.NavigateTo($"/inventario-instalaciones/item/{item.instalacion_id}"))'>
                                        ver
                                    </button>
                                </div>
                            </li>
                        }
                    }
                </ul>
            </details>
        </div>

        <!-- Sustancias -->
        <div class="card">
            <h3 style="margin:0 0 .5rem 0">Sustancias (@_sustancias.Count)</h3>
            <div class="assign-row">
                <select class="field" @bind="_selectedContenedorId">
                    <option value="">Selecciona contenedor</option>
                    @foreach (var opt in _contenedoresDisponibles)
                    {
                        <option value="@opt.id">@opt.label</option>
                    }
                </select>
                <button class="btn" @onclick="AssignContenedorAsync" disabled="@string.IsNullOrWhiteSpace(_selectedContenedorId)">Asignar</button>
                <span class="muted">@_assignMsg</span>
            </div>
            <div class="assign-row">
                <input class="field" placeholder="ID sustancia (opcional)" @bind="_nuevoSustanciaId" />
                <input class="field" placeholder="Nombre comercial" @bind="_nuevoSustanciaNombreComercial" />
                <input class="field" placeholder="Nombre químico" @bind="_nuevoSustanciaNombreQuimico" />
                <input class="field" placeholder="ID contenedor (opcional)" @bind="_nuevoContenedorId" />
                <input class="field" placeholder="Cantidad actual" @bind="_nuevoContenedorCantidad" />
                <button class="btn" @onclick="SubirSustanciaAsync">Subir sustancia</button>
                @if (!string.IsNullOrWhiteSpace(_nuevoSustanciaMsg))
                {
                    <span class="muted">@_nuevoSustanciaMsg</span>
                }
            </div>
            @if (_sustancias.Count == 0)
            {
                <p class="muted">Sin sustancias registradas.</p>
            }
            else
            {
                <ul class="simple-list">
                    @foreach (var item in _sustancias)
                    {
                        <li>
                            <strong>@item.nombre</strong> · @item.cantidad
                            <span class="muted">(@item.cont_id)</span>
                        </li>
                    }
                </ul>
            }
        </div>

        <!-- Equipos -->
        <div class="card">
            <h3 style="margin:0 0 .5rem 0">Equipos (@_equipos.Count)</h3>
            <div class="assign-row">
                <select class="field" @bind="_selectedEquipoId">
                    <option value="">Selecciona equipo</option>
                    @foreach (var opt in _equiposDisponibles)
                    {
                        <option value="@opt.id">@opt.label</option>
                    }
                </select>
                <button class="btn" @onclick="AssignEquipoAsync" disabled="@string.IsNullOrWhiteSpace(_selectedEquipoId)">Asignar</button>
                <span class="muted">@_assignMsg</span>
            </div>
            <div class="assign-row">
                <input class="field" placeholder="Modelo ID" @bind="_nuevoEquipoModeloId" />
                <input class="field" placeholder="Serie" @bind="_nuevoEquipoSerie" />
                <input class="field" placeholder="Estado ID" @bind="_nuevoEquipoEstadoId" />
                <input class="field" placeholder="Posición" @bind="_nuevoEquipoPosicion" />
                <label class="text-sm text-gray-600">
                    <input type="checkbox" @bind="_nuevoEquipoRequiereCalibracion" /> Requiere calibración
                </label>
                <button class="btn" @onclick="SubirEquipoAsync">Subir equipo</button>
                @if (!string.IsNullOrWhiteSpace(_nuevoEquipoMsg))
                {
                    <span class="muted">@_nuevoEquipoMsg</span>
                }
            </div>
            @if (_equipos.Count == 0)
            {
                <p class="muted">Sin equipos registrados.</p>
            }
            else
            {
                <ul class="simple-list">
                    @foreach (var item in _equipos)
                    {
                        <li>
                            <strong>@item.nombre_modelo</strong> · @item.serie
                            <span class="muted">@item.posicion</span>
                        </li>
                    }
                </ul>
            }
        </div>

        <!-- Instalaciones (alta rápida) -->
        <div class="card">
            <h3 style="margin:0 0 .5rem 0">Instalaciones</h3>

            <div class="assign-row">
                <input class="field" placeholder="Nombre" @bind="_nuevoInstalacionNombre" />
                <input class="field" placeholder="Subcategoría ID (opcional)" @bind="_nuevoInstalacionSubcategoriaId" />
                <input class="field" placeholder="Estado ID (opcional)" @bind="_nuevoInstalacionEstadoId" />
                <button class="btn" @onclick="SubirInstalacionAsync">Subir instalación</button>
                @if (!string.IsNullOrWhiteSpace(_nuevoInstalacionMsg))
                {
                    <span class="muted">@_nuevoInstalacionMsg</span>
                }
            </div>

            @if (_instalaciones.Count == 0)
            {
                <p class="muted">Sin instalaciones registradas.</p>
            }
            else
            {
                <ul class="simple-list">
                    @foreach (var item in _instalaciones)
                    {
                        <li><strong>@item.nombre</strong> · @item.detalle</li>
                    }
                </ul>
            }
        </div>

        <!-- Documentos -->
        <div class="card">
            <h3 style="margin:0 0 .5rem 0">Documentos</h3>
            <div class="assign-row">
                <input class="field" placeholder="Título" @bind="_nuevoDocumentoTitulo" />
                <input class="field" placeholder="URL" @bind="_nuevoDocumentoUrl" />
                <input class="field" placeholder="Ruta local (puede ser cualquier dirección)" @bind="_nuevoDocumentoArchivoLocal" />
                <input class="field" placeholder="Notas" @bind="_nuevoDocumentoNotas" />
                <button class="btn" @onclick="SubirDocumentoAsync">Subir documento</button>
                @if (!string.IsNullOrWhiteSpace(_nuevoDocumentoMsg))
                {
                    <span class="muted">@_nuevoDocumentoMsg</span>
                }
            </div>
        </div>
    }
</div>
