@page "/detalles/{AreaSlug}"
@namespace BARI_web.Features.Espacios.Pages

<div class="areas-wrap">
    <div class="toolbar">

        <h2 class="text-2xl" style="margin:0">Detalles del Area: @(_areaInfo?.nombre ?? AreaSlug)</h2>
        <button type="button" class="btn" @onclick="@(()=>Nav.NavigateTo("/areas"))">
            Volver al mapa
        </button>
        <button type="button" class="btn" style="margin-left:.5rem"
                @onclick="@(()=>Nav.NavigateTo($"/modificar-detalles/{AreaSlug}"))">
            Editar materiales de montaje / mesones
        </button>

    </div>

    @if (_canvas is null)
    {
        <p>Cargando...</p>
    }
    else
    {
        <div style="border:1px solid #e5e7eb; aspect-ratio:@AspectRatioString(); width:100%;">
            <svg width="100%" height="100%" viewBox="@ViewBox()" preserveAspectRatio="xMidYMid meet" style="background:#fafafa">
                <!-- fondo -->
                <rect x="@S(VX)" y="@S(VY)" width="@S(VW)" height="@S(VH)" fill="white" stroke="#ddd" stroke-width="@S(0.03m)" />

                <!-- grilla -->
                @for (var gx = GridStartX; gx <= GridEndX; gx += 1m)
                {
                    <line x1="@S(gx)" y1="@S(VY)" x2="@S(gx)" y2="@S(VY + VH)" stroke="#f1f1f1" stroke-width="@S(0.02m)" />
                }
                @for (var gy = GridStartY; gy <= GridEndY; gy += 1m)
                {
                    <line x1="@S(VX)" y1="@S(gy)" x2="@S(VX + VW)" y2="@S(gy)" stroke="#f1f1f1" stroke-width="@S(0.02m)" />
                }

                @if (_area is not null)
                {
                    <!-- clip del área + clips por cada inner -->
                    <defs>
                        <clipPath id="clip_target" clipPathUnits="userSpaceOnUse">
                            @foreach (var p in _area.Polys)
                            {
                                if (p.puntos.Count >= 3)
                                {
                                    <polygon points="@PointsString(p)" />
                                }
                                else
                                {
                                    <rect x="@S(p.x_m)" y="@S(p.y_m)" width="@S(p.ancho_m)" height="@S(p.alto_m)" />
                                }
                            }
                        </clipPath>

                        @foreach (var inn in _inners)
                        {
                            <clipPath id="@($"clip_in_{inn.poly_in_id}")" clipPathUnits="userSpaceOnUse">
                                <rect x="@S(inn.abs_x)" y="@S(inn.abs_y)" width="@S(inn.ancho_m)" height="@S(inn.alto_m)" />
                            </clipPath>
                        }
                    </defs>

                    <!-- relleno -->
                    <g class="softshadow" clip-path="url(#clip_target)">
                        @foreach (var p in _area.Polys)
                        {
                            if (p.puntos.Count >= 3)
                            {
                                <polygon points="@PointsString(p)" fill="@_area.Fill" />
                            }
                            else
                            {
                                <rect x="@S(p.x_m)" y="@S(p.y_m)"
                                      width="@S(p.ancho_m)" height="@S(p.alto_m)"
                                      fill="@_area.Fill" />
                            }
                        }
                    </g>

                    <!-- contorno -->
                    @foreach (var seg in _area.Outline)
                    {
                        <line x1="@S(seg.x1)" y1="@S(seg.y1)" x2="@S(seg.x2)" y2="@S(seg.y2)"
                              stroke="#000" stroke-width="@S(OutlineStroke)"
                              vector-effect="non-scaling-stroke" />
                    }

                    <!-- bloques internos -->
                    @foreach (var b in _blocks.OrderBy(b => b.z_order))
                    {
                        var blockLabel = BlockLabel(b);
                        var labelWidth = Math.Max(0.2m, b.ancho - 0.1m);
                        var labelFont = Math.Max(0.22m, Math.Min(0.6m, b.alto * 0.4m));

                        <rect x="@S(b.abs_x)" y="@S(b.abs_y)"
                              width="@S(b.ancho)" height="@S(b.alto)"
                              fill="@b.color_hex" opacity="0.45"
                              stroke="#1f2937" stroke-width="@S(0.03m)" />

                        @if (!string.IsNullOrWhiteSpace(blockLabel))
                        {
                            <text>
                                <tspan x="@S(b.abs_x + b.ancho / 2m)"
                                       y="@S(b.abs_y + b.alto / 2m)"
                                       style="text-anchor:middle;dominant-baseline:middle"
                                       font-size="@S(labelFont)"
                                       textLength="@S(labelWidth)"
                                       lengthAdjust="spacingAndGlyphs"
                                       fill="#111">
                                    @blockLabel
                                </tspan>
                            </text>
                        }
                    }

                    <!-- elementos interiores (rect + texto centrado y escalado) -->
                    @foreach (var it in _inners)
                    {
                        <rect x="@S(it.abs_x)" y="@S(it.abs_y)"
                              width="@S(it.ancho_m)" height="@S(it.alto_m)"
                              fill="@it.fill" opacity="@S(it.opacidad)" />

                        @if (!string.IsNullOrWhiteSpace(it.label))
                        {
                            var anchoTexto = it.ancho_m - 0.25m;
                            if (anchoTexto < 0.15m) anchoTexto = 0.15m;

                            <g clip-path="url(#clip_in_@it.poly_in_id)">
                                <text>
                                    <tspan x="@S(it.abs_x + it.ancho_m / 2m)"
                                           y="@S(it.abs_y + it.alto_m / 2m)"
                                           style="text-anchor:middle;dominant-baseline:middle"
                                           font-size="@S(FitInnerText(it))"
                                           textLength="@S(anchoTexto)"
                                           lengthAdjust="spacingAndGlyphs"
                                           fill="#111">
                                        @it.label.ToUpperInvariant()
                                    </tspan>
                                </text>
                            </g>
                        }
                    }



                    <!-- puertas (SIN vector-effect para que escalen con el viewBox) -->
                    @foreach (var d in _doors)
                    {
                        <line x1="@S(d.x_m)" y1="@S(d.y_m)"
                              x2="@S(DoorEndX(d))" y2="@S(DoorEndY(d))"
                              stroke="#13A076" stroke-width="@S(0.10m)" stroke-linecap="round" />
                    }

                    <!-- ventanas -->
                    @foreach (var w in _windows)
                    {
                        <line x1="@S(w.x_m)" y1="@S(w.y_m)"
                              x2="@S(WinEndX(w))" y2="@S(WinEndY(w))"
                              stroke="#66CCFF" stroke-width="@S(0.06m)" stroke-linecap="round" />
                    }

                    <!-- (se elimina el rótulo gigante del área) -->
                }
                else
                {
                    <text>
                        <tspan x="@S(VX + VW/2m)" y="@S(VY + VH/2m)"
                               style="text-anchor:middle;dominant-baseline:middle"
                               font-size="@S(0.6m)">
                            Area no encontrada: @AreaSlug
                        </tspan>
                    </text>
                }
            </svg>
        </div>

        @if (_areaInfo is not null)
        {
            <div style="margin-top:1rem; border:1px solid #e5e7eb; border-radius:.5rem; padding:.75rem; background:#fff">
                <h3 style="margin:0 0 .5rem 0">Información del área</h3>
                <div class="info-grid">
                    <div>
                        <strong>Nombre</strong>
                        <div>@_areaInfo.nombre</div>
                    </div>
                    <div>
                        <strong>Altura</strong>
                        <div>@(_areaInfo.altura_m is null ? "—" : $"{_areaInfo.altura_m} m")</div>
                    </div>
                    <div>
                        <strong>Área total</strong>
                        <div>@(_areaInfo.area_total_m2 is null ? "—" : $"{_areaInfo.area_total_m2} m²")</div>
                    </div>
                    <div>
                        <strong>Planta</strong>
                        <div>@(_areaInfo.planta_id ?? "—")</div>
                    </div>
                </div>
                @if (!string.IsNullOrWhiteSpace(_areaInfo.anotaciones))
                {
                    <div style="margin-top:.5rem; color:#4b5563">@_areaInfo.anotaciones</div>
                }
            </div>
        }

        <!-- === Panel de listas: Mesones y Materiales de montaje === -->
        <div style="margin-top:1rem; border:1px solid #e5e7eb; border-radius:.5rem; padding:.75rem; background:#fff">
            <details open>
                <summary style="cursor:pointer; font-weight:600">
                    Mesones (@_mesones.Count)
                </summary>
                <ul style="list-style:none; padding-left:0; margin:.5rem 0 0">
                    @if (_mesones.Count == 0)
                    {
                        <li style="color:#6b7280"><em>Sin mesones.</em></li>
                    }
                    else
                    {
                        @foreach (var m in _mesones)
                        {
                            <li style="display:flex; align-items:center; justify-content:space-between; padding:.25rem 0; border-bottom:1px dashed #eee">
                                <div>
                                    <strong>@MesonNameForDisplay(m)</strong>
                                    <div style="font-size:.85rem; color:#6b7280">
                                        Reactivos: @m.reactivos_count · Equipos: @m.equipos_count
                                    </div>
                                </div>
                                <button type="button" class="btn link"
                                        @onclick='@(() => Nav.NavigateTo($"/detalles-meson/{m.meson_id}"))'>
                                    ver
                                </button>
                            </li>
                        }
                    }
                </ul>
            </details>

            <details open style="margin-top:.75rem">
                <summary style="cursor:pointer; font-weight:600">
                    Materiales de montaje (@_materialesMontaje.Count)
                </summary>
                <div class="assign-row" style="margin-top:.5rem">
                    <select class="border p-1" @bind="_selectedMaterialMontajeId">
                        <option value="">Selecciona material</option>
                        @foreach (var opt in _materialesMontajeDisponibles)
                        {
                            <option value="@opt.id">@opt.label</option>
                        }
                    </select>
                    <button class="btn" @onclick='@(() => AssignMaterialAsync("materiales_montaje", _selectedMaterialMontajeId))' disabled="@string.IsNullOrWhiteSpace(_selectedMaterialMontajeId)">Asignar</button>
                </div>
                <ul style="list-style:none; padding-left:0; margin:.5rem 0 0">
                    @if (_materialesMontaje.Count == 0)
                    {
                        <li style="color:#6b7280"><em>Sin materiales de montaje.</em></li>
                    }
                    else
                    {
                        @foreach (var item in _materialesMontaje)
                        {
                            <li style="padding:.5rem 0; border-bottom:1px dashed #eee">
                                <div>
                                    <strong>@item.nombre</strong>
                                </div>
                                <div style="color:#4b5563; font-size:.9rem; margin-top:.15rem">
                                    @item.detalle
                                    @if (!string.IsNullOrWhiteSpace(item.posicion))
                                    {
                                        <span class="muted"> · @item.posicion</span>
                                    }
                                </div>
                            </li>
                        }
                    }
                </ul>
            </details>
        </div>

        <div style="margin-top:1rem; border:1px solid #e5e7eb; border-radius:.5rem; padding:.75rem; background:#fff">
            <h3 style="margin:0 0 .5rem 0">Sustancias (@_sustancias.Count)</h3>
            <div class="assign-row">
                <select class="border p-1" @bind="_selectedContenedorId">
                    <option value="">Selecciona contenedor</option>
                    @foreach (var opt in _contenedoresDisponibles)
                    {
                        <option value="@opt.id">@opt.label</option>
                    }
                </select>
                <button class="btn" @onclick="AssignContenedorAsync" disabled="@string.IsNullOrWhiteSpace(_selectedContenedorId)">Asignar</button>
                <span class="text-sm text-gray-500">@_assignMsg</span>
            </div>
            @if (_sustancias.Count == 0)
            {
                <p class="muted">Sin sustancias registradas.</p>
            }
            else
            {
                <ul class="simple-list">
                    @foreach (var item in _sustancias)
                    {
                        <li>
                            <strong>@item.nombre</strong> · @item.cantidad
                            <span class="muted">(@item.cont_id)</span>
                        </li>
                    }
                </ul>
            }
        </div>

        <div style="margin-top:1rem; border:1px solid #e5e7eb; border-radius:.5rem; padding:.75rem; background:#fff">
            <h3 style="margin:0 0 .5rem 0">Equipos (@_equipos.Count)</h3>
            <div class="assign-row">
                <select class="border p-1" @bind="_selectedEquipoId">
                    <option value="">Selecciona equipo</option>
                    @foreach (var opt in _equiposDisponibles)
                    {
                        <option value="@opt.id">@opt.label</option>
                    }
                </select>
                <button class="btn" @onclick="AssignEquipoAsync" disabled="@string.IsNullOrWhiteSpace(_selectedEquipoId)">Asignar</button>
                <span class="text-sm text-gray-500">@_assignMsg</span>
            </div>
            @if (_equipos.Count == 0)
            {
                <p class="muted">Sin equipos registrados.</p>
            }
            else
            {
                <ul class="simple-list">
                    @foreach (var item in _equipos)
                    {
                        <li>
                            <strong>@item.nombre_modelo</strong> · @item.serie
                            <span class="muted">@item.posicion</span>
                        </li>
                    }
                </ul>
            }
        </div>

        <div style="margin-top:1rem; border:1px solid #e5e7eb; border-radius:.5rem; padding:.75rem; background:#fff">
            <h3 style="margin:0 0 .5rem 0">Materiales</h3>

            <h4 style="margin:.5rem 0 0">Vidrio (@_materialesVidrio.Count)</h4>
            <div class="assign-row">
                <select class="border p-1" @bind="_selectedMaterialVidrioId">
                    <option value="">Selecciona material</option>
                    @foreach (var opt in _materialesVidrioDisponibles)
                    {
                        <option value="@opt.id">@opt.label</option>
                    }
                </select>
                <button class="btn" @onclick='@(() => AssignMaterialAsync("materiales_vidrio", _selectedMaterialVidrioId))' disabled="@string.IsNullOrWhiteSpace(_selectedMaterialVidrioId)">Asignar</button>
            </div>
            @if (_materialesVidrio.Count == 0)
            {
                <p class="muted">Sin materiales de vidrio.</p>
            }
            else
            {
                <ul class="simple-list">
                    @foreach (var item in _materialesVidrio)
                    {
                        <li><strong>@item.nombre</strong> · @item.detalle</li>
                    }
                </ul>
            }

            <h4 style="margin:.8rem 0 0">Consumible (@_materialesConsumible.Count)</h4>
            <div class="assign-row">
                <select class="border p-1" @bind="_selectedMaterialConsumibleId">
                    <option value="">Selecciona material</option>
                    @foreach (var opt in _materialesConsumibleDisponibles)
                    {
                        <option value="@opt.id">@opt.label</option>
                    }
                </select>
                <button class="btn" @onclick='@(() => AssignMaterialAsync("materiales_consumible", _selectedMaterialConsumibleId))' disabled="@string.IsNullOrWhiteSpace(_selectedMaterialConsumibleId)">Asignar</button>
            </div>
            @if (_materialesConsumible.Count == 0)
            {
                <p class="muted">Sin materiales consumibles.</p>
            }
            else
            {
                <ul class="simple-list">
                    @foreach (var item in _materialesConsumible)
                    {
                        <li><strong>@item.nombre</strong> · @item.detalle</li>
                    }
                </ul>
            }
        </div>

    }
</div>

<style>
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }
    .assign-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin: 0.5rem 0;
        flex-wrap: wrap;
    }
    .simple-list {
        list-style: none;
        padding-left: 0;
        margin: 0.5rem 0 0;
        display: grid;
        gap: 0.35rem;
    }
    .muted {
        color: #6b7280;
    }
</style>
